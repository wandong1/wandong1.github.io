<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>万东的云计算运维博客</title><meta name=keywords content><meta name=description content="基于Docker和Kubernetes的企业级DevOps实践训练营 课程准备 离线镜像包
百度：https://pan.baidu.com/s/1N1AYGCYftYGn6L0QPMWIMw 提取码：ev2h
天翼云：https://cloud.189.cn/t/ENjUbmRR7FNz
CentOS7.4版本以上 虚拟机3台（4C+8G+50G），内网互通，可连外网
课件文档
《训练营课件》 《安装手册》 git仓库
https://gitee.com/agagin/python-demo.git python demo项目
https://gitee.com/agagin/demo-resources.git demo项目演示需要的资源文件
关于本人 李永信
2012-2017，云平台开发工程师，先后对接过Vmware、OpenStack、Docker平台
2017-2019， 运维开发工程师，Docker+Kubernetes的Paas平台运维开发
2019至今，DevOps工程师
8年多的时间，积攒了一定的开发和运维经验，跟大家分享。
课程安排 2020.4.11 Docker + kubernetes
2020.4.18 DevOps平台实践
2天的时间，节奏会相对快一些
小调研：
A : 只听过docker，几乎没有docker的使用经验 B：有一定的docker实践经验，不熟悉或者几乎没用过k8s C：对于docker和k8s都有一定的实践经验，想更多了解如何基于docker+k8s构建devops平台 D：其他 课程介绍 最近的三年多时间，关注容器圈的话应该会知道这么几个事情：
容器技术持续火爆
Kubernetes(k8s)成为容器编排管理的标准
国内外厂商均已开始了全面拥抱Kubernetes的转型， 无数中小型企业已经落地 Kubernetes，或正走落地的道路上 。基于目前的发展趋势可以预见，未来几年以kubernetes平台为核心的容器运维管理、DevOps等将迎来全面的发展。
本着实践为核心的思想，本课程使用企业常见的基于Django + uwsgi + Nginx架构的Python Demo项目，分别讲述三个事情：
项目的容器化
教大家如何把公司的项目做成容器，并且运行在docker环境中
使用Kubernetes集群来管理容器化的项目
带大家一步一步部署k8s集群，并把容器化后的demo项目使用k8s来管理起来
使用Jenkins和Kubernetes集成，实现demo项目的持续集成/持续交付(CI/CD)
会使用k8s管理应用生命周期后，还差最后的环节，就是如何把开发、测试、部署的流程使用自动化工具整合起来，最后一部分呢，课程会教会大家如何优雅的使用gitlab+Jenkins+k8s构建企业级的DevOps平台
流程示意 你将学到哪些 Docker相关
如何使用Dockerfile快速构建镜像 Docker镜像、容器、仓库的常用操作 Docker容器的网络（Bridge下的SNAT、DNAT） Kubernetes相关
集群的快速搭建 kubernetes的架构及工作流程 使用Pod控制器管理业务应用的生命周期 使用CoreDNS、Service和Ingress实现服务发现、负载均衡及四层、七层网络的访问 Kubernetes的认证授权体系 使用EFK构建集群业务应用的日志收集系统"><meta name=author content="Me"><link rel=canonical href=https://wandong1.github.io/post/%E5%9F%BA%E4%BA%8Edocker%E5%92%8Ckubernetes%E7%9A%84%E4%BC%81%E4%B8%9A%E7%BA%A7devops%E5%AE%9E%E8%B7%B5%E8%AE%AD%E7%BB%83%E8%90%A5/><link crossorigin=anonymous href=/assets/css/stylesheet.min.77d563e104d7b39d673d4f21adf63da1ad0244dbcd78291ac2b44dc25b0066e1.css integrity="sha256-d9Vj4QTXs51nPU8hrfY9oa0CRNvNeCkawrRNwlsAZuE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wandong1.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://wandong1.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://wandong1.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://wandong1.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wandong1.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content><meta property="og:description" content="基于Docker和Kubernetes的企业级DevOps实践训练营 课程准备 离线镜像包
百度：https://pan.baidu.com/s/1N1AYGCYftYGn6L0QPMWIMw 提取码：ev2h
天翼云：https://cloud.189.cn/t/ENjUbmRR7FNz
CentOS7.4版本以上 虚拟机3台（4C+8G+50G），内网互通，可连外网
课件文档
《训练营课件》 《安装手册》 git仓库
https://gitee.com/agagin/python-demo.git python demo项目
https://gitee.com/agagin/demo-resources.git demo项目演示需要的资源文件
关于本人 李永信
2012-2017，云平台开发工程师，先后对接过Vmware、OpenStack、Docker平台
2017-2019， 运维开发工程师，Docker+Kubernetes的Paas平台运维开发
2019至今，DevOps工程师
8年多的时间，积攒了一定的开发和运维经验，跟大家分享。
课程安排 2020.4.11 Docker + kubernetes
2020.4.18 DevOps平台实践
2天的时间，节奏会相对快一些
小调研：
A : 只听过docker，几乎没有docker的使用经验 B：有一定的docker实践经验，不熟悉或者几乎没用过k8s C：对于docker和k8s都有一定的实践经验，想更多了解如何基于docker+k8s构建devops平台 D：其他 课程介绍 最近的三年多时间，关注容器圈的话应该会知道这么几个事情：
容器技术持续火爆
Kubernetes(k8s)成为容器编排管理的标准
国内外厂商均已开始了全面拥抱Kubernetes的转型， 无数中小型企业已经落地 Kubernetes，或正走落地的道路上 。基于目前的发展趋势可以预见，未来几年以kubernetes平台为核心的容器运维管理、DevOps等将迎来全面的发展。
本着实践为核心的思想，本课程使用企业常见的基于Django + uwsgi + Nginx架构的Python Demo项目，分别讲述三个事情：
项目的容器化
教大家如何把公司的项目做成容器，并且运行在docker环境中
使用Kubernetes集群来管理容器化的项目
带大家一步一步部署k8s集群，并把容器化后的demo项目使用k8s来管理起来
使用Jenkins和Kubernetes集成，实现demo项目的持续集成/持续交付(CI/CD)
会使用k8s管理应用生命周期后，还差最后的环节，就是如何把开发、测试、部署的流程使用自动化工具整合起来，最后一部分呢，课程会教会大家如何优雅的使用gitlab+Jenkins+k8s构建企业级的DevOps平台
流程示意 你将学到哪些 Docker相关
如何使用Dockerfile快速构建镜像 Docker镜像、容器、仓库的常用操作 Docker容器的网络（Bridge下的SNAT、DNAT） Kubernetes相关
集群的快速搭建 kubernetes的架构及工作流程 使用Pod控制器管理业务应用的生命周期 使用CoreDNS、Service和Ingress实现服务发现、负载均衡及四层、七层网络的访问 Kubernetes的认证授权体系 使用EFK构建集群业务应用的日志收集系统"><meta property="og:type" content="article"><meta property="og:url" content="https://wandong1.github.io/post/%E5%9F%BA%E4%BA%8Edocker%E5%92%8Ckubernetes%E7%9A%84%E4%BC%81%E4%B8%9A%E7%BA%A7devops%E5%AE%9E%E8%B7%B5%E8%AE%AD%E7%BB%83%E8%90%A5/"><meta property="og:image" content="https://wandong1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wandong1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content><meta name=twitter:description content="基于Docker和Kubernetes的企业级DevOps实践训练营 课程准备 离线镜像包
百度：https://pan.baidu.com/s/1N1AYGCYftYGn6L0QPMWIMw 提取码：ev2h
天翼云：https://cloud.189.cn/t/ENjUbmRR7FNz
CentOS7.4版本以上 虚拟机3台（4C+8G+50G），内网互通，可连外网
课件文档
《训练营课件》 《安装手册》 git仓库
https://gitee.com/agagin/python-demo.git python demo项目
https://gitee.com/agagin/demo-resources.git demo项目演示需要的资源文件
关于本人 李永信
2012-2017，云平台开发工程师，先后对接过Vmware、OpenStack、Docker平台
2017-2019， 运维开发工程师，Docker+Kubernetes的Paas平台运维开发
2019至今，DevOps工程师
8年多的时间，积攒了一定的开发和运维经验，跟大家分享。
课程安排 2020.4.11 Docker + kubernetes
2020.4.18 DevOps平台实践
2天的时间，节奏会相对快一些
小调研：
A : 只听过docker，几乎没有docker的使用经验 B：有一定的docker实践经验，不熟悉或者几乎没用过k8s C：对于docker和k8s都有一定的实践经验，想更多了解如何基于docker+k8s构建devops平台 D：其他 课程介绍 最近的三年多时间，关注容器圈的话应该会知道这么几个事情：
容器技术持续火爆
Kubernetes(k8s)成为容器编排管理的标准
国内外厂商均已开始了全面拥抱Kubernetes的转型， 无数中小型企业已经落地 Kubernetes，或正走落地的道路上 。基于目前的发展趋势可以预见，未来几年以kubernetes平台为核心的容器运维管理、DevOps等将迎来全面的发展。
本着实践为核心的思想，本课程使用企业常见的基于Django + uwsgi + Nginx架构的Python Demo项目，分别讲述三个事情：
项目的容器化
教大家如何把公司的项目做成容器，并且运行在docker环境中
使用Kubernetes集群来管理容器化的项目
带大家一步一步部署k8s集群，并把容器化后的demo项目使用k8s来管理起来
使用Jenkins和Kubernetes集成，实现demo项目的持续集成/持续交付(CI/CD)
会使用k8s管理应用生命周期后，还差最后的环节，就是如何把开发、测试、部署的流程使用自动化工具整合起来，最后一部分呢，课程会教会大家如何优雅的使用gitlab+Jenkins+k8s构建企业级的DevOps平台
流程示意 你将学到哪些 Docker相关
如何使用Dockerfile快速构建镜像 Docker镜像、容器、仓库的常用操作 Docker容器的网络（Bridge下的SNAT、DNAT） Kubernetes相关
集群的快速搭建 kubernetes的架构及工作流程 使用Pod控制器管理业务应用的生命周期 使用CoreDNS、Service和Ingress实现服务发现、负载均衡及四层、七层网络的访问 Kubernetes的认证授权体系 使用EFK构建集群业务应用的日志收集系统"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://wandong1.github.io/post/"},{"@type":"ListItem","position":3,"name":"","item":"https://wandong1.github.io/post/%E5%9F%BA%E4%BA%8Edocker%E5%92%8Ckubernetes%E7%9A%84%E4%BC%81%E4%B8%9A%E7%BA%A7devops%E5%AE%9E%E8%B7%B5%E8%AE%AD%E7%BB%83%E8%90%A5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"基于Docker和Kubernetes的企业级DevOps实践训练营 课程准备 离线镜像包\n百度：https://pan.baidu.com/s/1N1AYGCYftYGn6L0QPMWIMw 提取码：ev2h\n天翼云：https://cloud.189.cn/t/ENjUbmRR7FNz\nCentOS7.4版本以上 虚拟机3台（4C+8G+50G），内网互通，可连外网\n课件文档\n《训练营课件》 《安装手册》 git仓库\nhttps://gitee.com/agagin/python-demo.git python demo项目\nhttps://gitee.com/agagin/demo-resources.git demo项目演示需要的资源文件\n关于本人 李永信\n2012-2017，云平台开发工程师，先后对接过Vmware、OpenStack、Docker平台\n2017-2019， 运维开发工程师，Docker+Kubernetes的Paas平台运维开发\n2019至今，DevOps工程师\n8年多的时间，积攒了一定的开发和运维经验，跟大家分享。\n课程安排 2020.4.11 Docker + kubernetes\n2020.4.18 DevOps平台实践\n2天的时间，节奏会相对快一些\n小调研：\nA : 只听过docker，几乎没有docker的使用经验 B：有一定的docker实践经验，不熟悉或者几乎没用过k8s C：对于docker和k8s都有一定的实践经验，想更多了解如何基于docker+k8s构建devops平台 D：其他 课程介绍 最近的三年多时间，关注容器圈的话应该会知道这么几个事情：\n容器技术持续火爆\nKubernetes(k8s)成为容器编排管理的标准\n国内外厂商均已开始了全面拥抱Kubernetes的转型， 无数中小型企业已经落地 Kubernetes，或正走落地的道路上 。基于目前的发展趋势可以预见，未来几年以kubernetes平台为核心的容器运维管理、DevOps等将迎来全面的发展。\n本着实践为核心的思想，本课程使用企业常见的基于Django + uwsgi + Nginx架构的Python Demo项目，分别讲述三个事情：\n项目的容器化\n教大家如何把公司的项目做成容器，并且运行在docker环境中\n使用Kubernetes集群来管理容器化的项目\n带大家一步一步部署k8s集群，并把容器化后的demo项目使用k8s来管理起来\n使用Jenkins和Kubernetes集成，实现demo项目的持续集成/持续交付(CI/CD)\n会使用k8s管理应用生命周期后，还差最后的环节，就是如何把开发、测试、部署的流程使用自动化工具整合起来，最后一部分呢，课程会教会大家如何优雅的使用gitlab+Jenkins+k8s构建企业级的DevOps平台\n流程示意 你将学到哪些 Docker相关\n如何使用Dockerfile快速构建镜像 Docker镜像、容器、仓库的常用操作 Docker容器的网络（Bridge下的SNAT、DNAT） Kubernetes相关\n集群的快速搭建 kubernetes的架构及工作流程 使用Pod控制器管理业务应用的生命周期 使用CoreDNS、Service和Ingress实现服务发现、负载均衡及四层、七层网络的访问 Kubernetes的认证授权体系 使用EFK构建集群业务应用的日志收集系统","keywords":[],"articleBody":"基于Docker和Kubernetes的企业级DevOps实践训练营 课程准备 离线镜像包\n百度：https://pan.baidu.com/s/1N1AYGCYftYGn6L0QPMWIMw 提取码：ev2h\n天翼云：https://cloud.189.cn/t/ENjUbmRR7FNz\nCentOS7.4版本以上 虚拟机3台（4C+8G+50G），内网互通，可连外网\n课件文档\n《训练营课件》 《安装手册》 git仓库\nhttps://gitee.com/agagin/python-demo.git python demo项目\nhttps://gitee.com/agagin/demo-resources.git demo项目演示需要的资源文件\n关于本人 李永信\n2012-2017，云平台开发工程师，先后对接过Vmware、OpenStack、Docker平台\n2017-2019， 运维开发工程师，Docker+Kubernetes的Paas平台运维开发\n2019至今，DevOps工程师\n8年多的时间，积攒了一定的开发和运维经验，跟大家分享。\n课程安排 2020.4.11 Docker + kubernetes\n2020.4.18 DevOps平台实践\n2天的时间，节奏会相对快一些\n小调研：\nA : 只听过docker，几乎没有docker的使用经验 B：有一定的docker实践经验，不熟悉或者几乎没用过k8s C：对于docker和k8s都有一定的实践经验，想更多了解如何基于docker+k8s构建devops平台 D：其他 课程介绍 最近的三年多时间，关注容器圈的话应该会知道这么几个事情：\n容器技术持续火爆\nKubernetes(k8s)成为容器编排管理的标准\n国内外厂商均已开始了全面拥抱Kubernetes的转型， 无数中小型企业已经落地 Kubernetes，或正走落地的道路上 。基于目前的发展趋势可以预见，未来几年以kubernetes平台为核心的容器运维管理、DevOps等将迎来全面的发展。\n本着实践为核心的思想，本课程使用企业常见的基于Django + uwsgi + Nginx架构的Python Demo项目，分别讲述三个事情：\n项目的容器化\n教大家如何把公司的项目做成容器，并且运行在docker环境中\n使用Kubernetes集群来管理容器化的项目\n带大家一步一步部署k8s集群，并把容器化后的demo项目使用k8s来管理起来\n使用Jenkins和Kubernetes集成，实现demo项目的持续集成/持续交付(CI/CD)\n会使用k8s管理应用生命周期后，还差最后的环节，就是如何把开发、测试、部署的流程使用自动化工具整合起来，最后一部分呢，课程会教会大家如何优雅的使用gitlab+Jenkins+k8s构建企业级的DevOps平台\n流程示意 你将学到哪些 Docker相关\n如何使用Dockerfile快速构建镜像 Docker镜像、容器、仓库的常用操作 Docker容器的网络（Bridge下的SNAT、DNAT） Kubernetes相关\n集群的快速搭建 kubernetes的架构及工作流程 使用Pod控制器管理业务应用的生命周期 使用CoreDNS、Service和Ingress实现服务发现、负载均衡及四层、七层网络的访问 Kubernetes的认证授权体系 使用EFK构建集群业务应用的日志收集系统\n基于Gitlab+Jenkins+k8s构建DevOps平台\nJenkins介绍及流水线的使用 Jenkinsfile及多分支流水线的实际应用 Jenkins集成sonarQube、Docker、Kubernetes 使用groovy编写sharedLibrary，实现CI/CD流程的优化 第一章 走进Docker的世界 介绍docker的前世今生，了解docker的实现原理，以Django项目为例，带大家如何编写最佳的Dockerfile构建镜像。通过本章的学习，大家会知道docker的概念及基本操作，并学会构建自己的业务镜像，并通过抓包的方式掌握Docker最常用的bridge网络模式的通信。\n认识docker 怎么出现的 轻量、高效的虚拟化\nDocker 公司位于旧金山,原名dotCloud，底层利用了Linux容器技术（在操作系统中实现资源隔离与限制）。为了方便创建和管理这些容器，dotCloud 开发了一套内部工具，之后被命名为“Docker”。Docker就是这样诞生的。\n（思考为啥要用Linux容器技术？）\nHypervisor： 一种运行在基础物理服务器和操作系统之间的中间软件层，可允许多个操作系统和应用共享硬件 。常见的VMware的 Workstation 、ESXi、微软的Hyper-V或者思杰的XenServer。\nContainer Runtime：通过Linux内核虚拟化能力管理多个容器，多个容器共享一套操作系统内核。因此摘掉了内核占用的空间及运行所需要的耗时，使得容器极其轻量与快速。\n软件交付过程中的环境依赖\n几个知识点 可以把应用程序代码及运行依赖环境打包成镜像，作为交付介质，在各环境部署\n可以将镜像（image）启动成为容器(container)，并且提供多容器的生命周期进行管理（启、停、删）\ncontainer容器之间相互隔离，且每个容器可以设置资源限额\n提供轻量级虚拟化功能，容器就是在宿主机中的一个个的虚拟的空间，彼此相互隔离，完全独立\nCS架构的软件产品\n版本管理 Docker 引擎主要有两个版本：企业版（EE）和社区版（CE） 每个季度(1-3,4-6,7-9,10-12)，企业版和社区版都会发布一个稳定版本(Stable)。社区版本会提供 4 个月的支持，而企业版本会提供 12 个月的支持 每个月社区版还会通过 Edge 方式发布月度版 从 2017 年第一季度开始，Docker 版本号遵循 YY.MM-xx 格式，类似于 Ubuntu 等项目。例如，2018 年 6 月第一次发布的社区版本为 18.06.0-ce 发展史 13年成立，15年开始，迎来了飞速发展。\nDocker 1.8之前，使用LXC，Docker在上层做了封装， 把LXC复杂的容器创建与使用方式简化为自己的一套命令体系。\n之后，为了实现跨平台等复杂的场景，Docker抽出了libcontainer项目，把对namespace、cgroup的操作封装在libcontainer项目里，支持不同的平台类型。\n2015年6月，Docker牵头成立了 OCI（Open Container Initiative开放容器计划）组织，这个组织的目的是建立起一个围绕容器的通用标准 。 容器格式标准是一种不受上层结构绑定的协议，即不限于某种特定操作系统、硬件、CPU架构、公有云等 ， 允许任何人在遵循该标准的情况下开发应用容器技术，这使得容器技术有了一个更广阔的发展空间。\nOCI成立后，libcontainer 交给OCI组织来维护，但是libcontainer中只包含了与kernel交互的库，因此基于libcontainer项目，后面又加入了一个CLI工具，并且项目改名为runC (https://github.com/opencontainers/runc )， 目前runC已经成为一个功能强大的runtime工具。\nDocker也做了架构调整。将容器运行时相关的程序从docker daemon剥离出来，形成了containerd。containerd向上为Docker Daemon提供了gRPC接口，使得Docker Daemon屏蔽下面的结构变化，确保原有接口向下兼容。向下通过containerd-shim结合runC，使得引擎可以独立升级，避免之前Docker Daemon升级会导致所有容器不可用的问题。\n也就是说\nrunC（libcontainer）是符合OCI标准的一个实现，与底层系统交互 containerd是实现了OCI之上的容器的高级功能，比如镜像管理、容器执行的调用等 Dockerd目前是最上层与CLI交互的进程，接收cli的请求并与containerd协作 小结 为了解决软件交付过程中的环境依赖，同时提供一种更加轻量的虚拟化技术，Docker出现了 Docker是一种CS架构的软件产品，可以把代码及依赖打包成镜像，作为交付介质，并且把镜像启动成为容器，提供容器生命周期的管理 docker-ce，每季度发布stable版本。18.06，18.09，19.03 发展至今，docker已经通过制定OCI标准对最初的项目做了拆分，其中runC和containerd是docker的核心项目，理解docker整个请求的流程，对我们深入理解docker有很大的帮助 安装 配置宿主机网卡转发 ## 配置网卡转发,看值是否为1 $ sysctl -a |grep -w net.ipv4.ip_forward net.ipv4.ip_forward = 1 ## 若未配置，需要执行如下 $ cat \u003c\u003cEOF \u003e /etc/sysctl.d/docker.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward=1 EOF $ sysctl -p /etc/sysctl.d/docker.conf Yum安装配置docker ## 下载阿里源repo文件 $ curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo $ curl -o /etc/yum.repos.d/docker-ce.repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo $ yum clean all \u0026\u0026 yum makecache ## yum安装 $ yum install -y docker-ce ## 查看源中可用版本 $ yum list docker-ce --showduplicates | sort -r ## 安装指定版本 ##yum install -y docker-ce-18.09.9 ## 配置源加速 ## https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors mkdir -p /etc/docker vi /etc/docker/daemon.json { \"registry-mirrors\" : [ \"https://8xpk5wnt.mirror.aliyuncs.com\", \"https://dockerhub.azk8s.cn\", \"https://registry.docker-cn.com\", \"https://ot2k4d59.mirror.aliyuncs.com/\" ] } ## 设置开机自启 systemctl enable docker systemctl daemon-reload ## 启动docker systemctl start docker ## 查看docker信息 docker info ## docker-client which docker ## docker daemon ps aux |grep docker 核心要素及常用操作详解 三大核心要素：镜像(Image)、容器(Container)、仓库(Registry)\n（先整体看下流程，再逐个演示）\n镜像（Image） 打包了业务代码及运行环境的包，是静态的文件，不能直接对外提供服务。\n容器（Container） 镜像的运行时，可以对外提供服务。本质上讲是利用namespace和cgroup等技术在宿主机中创建的独立的虚拟空间。\n仓库（Registry） 公有仓库，Docker Hub，阿里，网易… 私有仓库，企业内部搭建 Docker Registry，Docker官方提供的镜像仓库存储服务 Harbor, 是Docker Registry的更高级封装，它除了提供友好的Web UI界面，角色和用户权限管理，用户操作审计等功能 镜像访问地址形式 registry.devops.com/demo/hello:latest,若没有前面的url地址，则默认寻找Docker Hub中的镜像，若没有tag标签，则使用latest作为标签 公有的仓库中，一般存在这么几类镜像 操作系统基础镜像（centos，ubuntu，suse，alpine） 中间件（nginx，redis，mysql，tomcat） 语言编译环境（python，java，golang） 业务镜像（django-demo…） 操作演示 解压离线包\n为了保证镜像下载的速度，因此提前在一台节点下载了离线镜像包，做解压：\n$ tar zxf registry.tar.gz -C /opt $ ll /opt/registry-data total 25732 drwxr-xr-x 3 root root 4096 Apr 9 20:11 registry -rw------- 1 root root 26344448 Apr 9 22:15 registry-v2.tar 查看所有镜像：\n$ docker images 拉取镜像: $ docker pull nginx:alpine 如何唯一确定镜像: image_id repository:tag $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE nginx alpine 377c0837328f 2 weeks ago 19.7MB 导出镜像到文件中\n$ docker save -o nginx-alpine.tar nginx:alpine\n5. 从文件中加载镜像\r```powershell\r$ docker load -i nginx-alpine.tar 部署镜像仓库\nhttps://docs.docker.com/registry/\n## 使用docker镜像启动镜像仓库服务 $ docker run -d -p 5000:5000 --restart always -v /opt/registry-data/registry:/var/lib/registry --name registry registry:2 ## 默认仓库不带认证，若需要认证，参考https://docs.docker.com/registry/deploying/#restricting-access 假设启动镜像仓库服务的主机地址为172.21.32.6，该目录中已存在的镜像列表：\n现镜像仓库地址 原镜像仓库地址 172.21.32.6:5000/coreos/flannel:v0.11.0-amd64 quay.io/coreos/flannel:v0.11.0-amd64 172.21.32.6:5000/mysql:5.7 mysql:5.7 172.21.32.6:5000/nginx:alpine nginx:alpine 172.21.32.6:5000/centos:centos7.5.1804 centos:centos7.5.1804 172.21.32.6:5000/elasticsearch/elasticsearch:7.4.2 docker.elastic.co/elasticsearch/elasticsearch:7.4.2 172.21.32.6:5000/fluentd-es-root:v1.6.2-1.0 gcr.io/google_containers/fluentd-elasticsearch:v2.4.0 172.21.32.6:5000/kibana/kibana:7.4.2 docker.elastic.co/kibana/kibana:7.4.2 172.21.32.6:5000/kubernetesui/dashboard:v2.0.0-beta5 kubernetesui/dashboard:v2.0.0-beta5 172.21.32.6:5000/kubernetesui/metrics-scraper:v1.0.1 kubernetesui/metrics-scraper:v1.0.1 172.21.32.6:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0 quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0 推送本地镜像到镜像仓库中\n$ docker tag nginx:alpine localhost:5000/nginx:alpine $ docker push localhost:5000/nginx:alpine ## 我的镜像仓库给外部访问，不能通过localhost，尝试使用内网地址172.21.16.3:5000/nginx:alpine $ docker tag nginx:alpine 172.21.16.3:5000/nginx:alpine $ docker push 172.21.16.3:5000/nginx:alpine The push refers to repository [172.21.16.3:5000/nginx] Get https://172.21.16.3:5000/v2/: http: server gave HTTP response to HTTPS client ## docker默认不允许向http的仓库地址推送，如何做成https的，参考：https://docs.docker.com/registry/deploying/#run-an-externally-accessible-registry ## 我们没有可信证书机构颁发的证书和域名，自签名证书需要在每个节点中拷贝证书文件，比较麻烦，因此我们通过配置daemon的方式，来跳过证书的验证： $ cat /etc/docker/daemon.json { \"registry-mirrors\": [ \"https://8xpk5wnt.mirror.aliyuncs.com\" ], \"insecure-registries\": [ \"172.21.16.3:5000\" ] } $ systemctl restart docker $ docker push 172.21.16.3:5000/nginx:alpine $ docker images\t# IMAGE ID相同，等于起别名或者加快捷方式 REPOSITORY TAG IMAGE ID CREATED SIZE 172.21.16.3:5000/nginx alpine 377c0837328f 4 weeks ago nginx alpine 377c0837328f 4 weeks ago localhost:5000/nginx alpine 377c0837328f 4 weeks ago registry 2 708bc6af7e5e 2 months ago 删除镜像\ndocker rmi nginx:alpine 查看容器列表\n## 查看运行状态的容器列表 $ docker ps ## 查看全部状态的容器列表 $ docker ps -a 启动容器\n## 后台启动 $ docker run --name nginx -d nginx:alpine ##查看run流程# ##查看容器进程 ## 等同于在虚拟机中开辟了一块隔离的独立的虚拟空间 ## 启动容器的同时进入容器，-ti与/bin/sh或者/bin/bash配套使用，意思未分配一个tty终端 $ docker run --name nginx -ti nginx:alpine /bin/sh （注意：退出容器后，该容器会变成退出状态，因为容器内部的1号进程退出） ## 实际上，在运行容器的时候，镜像地址后面跟的命令等于是覆盖了原有的容器的CMD命令，因此，执行的这些命令在容器内部就是1号进程，若该进程不存在了，那么容器就会处于退出的状态，比如，宿主机中执行 1. echo 1,执行完后，该命令立马就结束了 2. ping www.baidu.com,执行完后，命令的进程会持续运行 $ docker run -d --name test_echo nginx:alpine echo 1,容器会立马退出 $ docker run -d --name test_ping nginx:alpine ping www.baidu.com,容器不会退出，但是因为没有加-d参数，因此一直在前台运行，若ctrl+C终止，则容器退出，因为1号进程被终止了 ## 映射端口,把容器的端口映射到宿主机中,-p : $ docker run --name nginx -d -p 8080:80 nginx:alpine ## 资源限制,-cpuset-cpus用于设置容器可以使用的 vCPU 核。-c,--cpu-shares用于设置多个容器竞争 CPU 时，各个容器相对能分配到的 CPU 时间比例。假设有三个正在运行的容器，这三个容器中的任务都是 CPU 密集型的。第一个容器的 cpu 共享权值是 1024，其它两个容器的 cpu 共享权值是 512。第一个容器将得到 50% 的 CPU 时间，而其它两个容器就只能各得到 25% 的 CPU 时间了。如果再添加第四个 cpu 共享值为 1024 的容器，每个容器得到的 CPU 时间将重新计算。第一个容器的CPU 时间变为 33%，其它容器分得的 CPU 时间分别为 16.5%、16.5%、33%。必须注意的是，这个比例只有在 CPU 密集型的任务执行时才有用。在四核的系统上，假设有四个单进程的容器，它们都能各自使用一个核的 100% CPU 时间，不管它们的 cpu 共享权值是多少。 $ docker run --cpuset-cpus=\"0-3\" --cpu-shares=512 --memory=500m nginx:alpine 容器数据持久化\n## 挂载主机目录 $ docker run --name nginx -d -v /opt:/opt -v /var/log:/var/log nginx:alpine $ docker run --name mysql -e MYSQL_ROOT_PASSWORD=123456 -d -v /opt/mysql/:/var/lib/mysql mysql:5.7 ## 使用volumes卷 $ docker volume ls $ docker volume create my-vol $ docker run --name nginx -d -v my-vol:/opt/my-vol nginx:alpine $ docker exec -ti nginx touch /opt/my-vol/a.txt ## 验证数据共享 $ docker run --name nginx2 -d -v my-vol:/opt/hh nginx:alpine $ docker exec -ti nginx2 ls /opt/hh/ a.txt 进入容器或者执行容器内的命令\n$ docker exec -ti \u003ccontainer_id_or_name\u003e /bin/sh $ docker exec -ti \u003ccontainer_id_or_name\u003e hostname 主机与容器之间拷贝数据\n## 主机拷贝到容器 $ echo '123'\u003e/tmp/test.txt $ docker cp /tmp/test.txt nginx:/tmp $ docker exec -ti nginx cat /tmp/test.txt 123 ## 容器拷贝到主机 $ docker cp nginx:/tmp/test.txt ./ 查看容器日志\n## 查看全部日志 $ docker logs nginx ## 实时查看最新日志 $ docker logs -f nginx ## 从最新的100条开始查看 $ docker logs --tail=100 -f nginx 停止或者删除容器\n## 停止运行中的容器 $ docker stop nginx ## 启动退出容器 $ docker start nginx ## 删除退出容器 $ docker rm nginx ## 删除运行中的容器 $ docker rm -f nginx 查看容器或者镜像的明细\n## 查看容器详细信息，包括容器IP地址等 $ docker inspect nginx ## 查看镜像的明细信息 $ docker inspect nginx:alpine Django应用容器化实践 django项目介绍 项目地址：https://gitee.com/agagin/python-demo.git\npython3 + uwsgi + nginx + mysql\n内部服务端口8002\n构建命令 $ docker build . -t ImageName:ImageTag -f Dockerfile 如何理解构建镜像的过程？\nDockerfile是一堆指令，在docker build的时候，按照该指令进行操作，最终生成我们期望的镜像\nFROM 指定基础镜像，必须为第一个命令\n格式：\rFROM FROM :\r示例：\rFROM mysql:5.7\r注意：\rtag是可选的，如果不使用tag时，会使用latest版本的基础镜像 MAINTAINER 镜像维护者的信息\n格式：\rMAINTAINER 示例：\rMAINTAINER Yongxin Li\rMAINTAINER inspur_lyx@hotmail.com\rMAINTAINER Yongxin Li COPY|ADD 添加本地文件到镜像中\n格式：\rCOPY ... 示例：\rADD hom* /mydir/ # 添加所有以\"hom\"开头的文件\rADD test relativeDir/ # 添加 \"test\" 到 `WORKDIR`/relativeDir/\rADD test /absoluteDir/ # 添加 \"test\" 到 /absoluteDir/ WORKDIR 工作目录\n格式：\rWORKDIR /path/to/workdir\r示例：\rWORKDIR /a (这时工作目录为/a)\r注意：\r通过WORKDIR设置工作目录后，Dockerfile中其后的命令RUN、CMD、ENTRYPOINT、ADD、COPY等命令都会在该目录下执行 RUN 构建镜像过程中执行命令\n格式：\rRUN 示例：\rRUN yum install nginx\rRUN pip install django\rRUN mkdir test \u0026\u0026 rm -rf /var/lib/unusedfiles\r注意：\rRUN指令创建的中间镜像会被缓存，并会在下次构建中使用。如果不想使用这些缓存镜像，可以在构建时指定--no-cache参数，如：docker build --no-cache CMD 构建容器后调用，也就是在容器启动时才进行调用\n格式：\rCMD [\"executable\",\"param1\",\"param2\"] (执行可执行文件，优先)\rCMD [\"param1\",\"param2\"] (设置了ENTRYPOINT，则直接调用ENTRYPOINT添加参数)\rCMD command param1 param2 (执行shell内部命令)\r示例：\rCMD [\"/usr/bin/wc\",\"--help\"]\rCMD ping www.baidu.com\r注意：\rCMD不同于RUN，CMD用于指定在容器启动时所要执行的命令，而RUN用于指定镜像构建时所要执行的命令。 ENTRYPOINT 设置容器初始化命令，使其可执行化\n格式：\rENTRYPOINT [\"executable\", \"param1\", \"param2\"] (可执行文件, 优先)\rENTRYPOINT command param1 param2 (shell内部命令)\r示例：\rENTRYPOINT [\"/usr/bin/wc\",\"--help\"]\r注意：\rENTRYPOINT与CMD非常类似，不同的是通过docker run执行的命令不会覆盖ENTRYPOINT，而docker run命令中指定的任何参数，都会被当做参数再次传递给ENTRYPOINT。Dockerfile中只允许有一个ENTRYPOINT命令，多指定时会覆盖前面的设置，而只执行最后的ENTRYPOINT指令 ENV\n格式：\rENV ENV =\r示例：\rENV myName John\rENV myCat=fluffy EXPOSE\n格式：\rEXPOSE [...]\r示例：\rEXPOSE 80 443\rEXPOSE 8080\rEXPOSE 11211/tcp 11211/udp\r注意：\rEXPOSE并不会让容器的端口访问到主机。要使其可访问，需要在docker run运行容器时通过-p来发布这些端口，或通过-P参数来发布EXPOSE导出的所有端口 Dockerfile dockerfiles/myblog/Dockerfile\n# This my first django Dockerfile # Version 1.0 # Base images 基础镜像 FROM centos:centos7.5.1804 #MAINTAINER 维护者信息 LABEL maintainer=\"inspur_lyx@hotmail.com\" #ENV 设置环境变量 ENV LANG en_US.UTF-8 ENV LC_ALL en_US.UTF-8 #RUN 执行以下命令 RUN curl -so /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo RUN yum install -y python36 python3-devel gcc pcre-devel zlib-devel make net-tools #工作目录 WORKDIR /opt/myblog #拷贝文件至工作目录 COPY . . #安装nginx RUN tar -zxf nginx-1.13.7.tar.gz -C /opt \u0026\u0026 cd /opt/nginx-1.13.7 \u0026\u0026 ./configure --prefix=/usr/local/nginx \\ \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx RUN cp myblog.conf /usr/local/nginx/conf/myblog.conf #安装依赖的插件 RUN pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt RUN chmod +x run.sh \u0026\u0026 rm -rf ~/.cache/pip #EXPOSE 映射端口 EXPOSE 8002 #容器启动时执行命令 CMD [\"./run.sh\"] 执行构建：\n$ docker build . -t myblog:v1 -f Dockerfile 定制化基础镜像 dockerfiles/myblog/Dockerfile-base\n# Base images 基础镜像 FROM centos:centos7.5.1804 #MAINTAINER 维护者信息 LABEL maintainer=\"inspur_lyx@hotmail.com\" #ENV 设置环境变量 ENV LANG en_US.UTF-8 ENV LC_ALL en_US.UTF-8 #RUN 执行以下命令 RUN curl -so /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo RUN yum install -y python36 python3-devel gcc pcre-devel zlib-devel make net-tools COPY nginx-1.13.7.tar.gz /opt #安装nginx RUN tar -zxf /opt/nginx-1.13.7.tar.gz -C /opt \u0026\u0026 cd /opt/nginx-1.13.7 \u0026\u0026 ./configure --prefix=/usr/local/nginx \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx ## 构建基础镜像 $ docker build . -t centos-python3-nginx:v1 -f Dockerfile-base $ docker tag centos-python3-nginx:v1 172.21.32.6:5000/base/centos-python3-nginx:v1 $ docker push 172.21.32.6:5000/base/centos-python3-nginx:v1 简化Dockerfile dockerfiles/myblog/Dockerfile-optimized\n# This my first django Dockerfile # Version 1.0 # Base images 基础镜像 FROM centos-python3-nginx:v1 #MAINTAINER 维护者信息 LABEL maintainer=\"inspur_lyx@hotmail.com\" #工作目录 WORKDIR /opt/myblog #拷贝文件至工作目录 COPY . . RUN cp myblog.conf /usr/local/nginx/conf/myblog.conf #安装依赖的插件 RUN pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt RUN chmod +x run.sh \u0026\u0026 rm -rf ~/.cache/pip #EXPOSE 映射端口 EXPOSE 8002 #容器启动时执行命令 CMD [\"./run.sh\"] $ docker build . -t myblog -f Dockerfile-optimized 运行mysql $ docker run -d -p 3306:3306 --name mysql -v /opt/mysql/mysql-data/:/var/lib/mysql -e MYSQL_DATABASE=myblog -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7 ## 查看数据库 $ docker exec -ti mysql bash #/ mysql -uroot -p123456 #/ show databases; ## navicator连接 启动Django应用 ## 启动容器 $ docker run -d -p 8002:8002 --name myblog -e MYSQL_HOST=172.21.32.6 -e MYSQL_USER=root -e MYSQL_PASSWD=123456 myblog ## migrate $ docker exec -ti myblog bash #/ python3 manage.py makemigrations #/ python3 manage.py migrate #/ python3 manage.py createsuperuser ## 创建超级用户 $ docker exec -ti myblog python3 manage.py createsuperuser ## 收集静态文件 ## $ docker exec -ti myblog python3 manage.py collectstatic 访问62.234.214.206:8002/admin\n构建镜像，替换默认编码：\ndockerfiles/mysql/my.cnf\n$ cat my.cnf [mysqld] user=root character-set-server=utf8 lower_case_table_names=1 [client] default-character-set=utf8 [mysql] default-character-set=utf8 !includedir /etc/mysql/conf.d/ !includedir /etc/mysql/mysql.conf.d/ dockerfiles/mysql/Dockerfile\nFROM mysql:5.7 COPY my.cnf /etc/mysql/my.cnf ## CMD或者ENTRYPOINT默认继承 $ docker build . -t mysql:5.7-utf8 $ docker tag mysql:5.7-utf8 172.21.16.3:5000/mysql:5.7-utf8 $ docker push 172.21.16.3:5000/mysql:5.7-utf8 ## 删除旧的mysql容器，使用新镜像启动,不用再次初始化 $ docker rm -f mysql $ rm -rf /opt/mysql/mysql-data/* $ docker run -d -p 3306:3306 --name mysql -v /opt/mysql/mysql-data/:/var/lib/mysql -e MYSQL_DATABASE=myblog -e MYSQL_ROOT_PASSWORD=123456 172.21.32.6:5000/mysql:5.7-utf8 ## 重新migrate $ docker exec -ti myblog bash #/ python3 manage.py makemigrations #/ python3 manage.py migrate #/ python3 manage.py createsuperuser 实现原理 录屏！！！ 虚拟化核心需要解决的问题：资源隔离与资源限制\n虚拟机硬件虚拟化技术， 通过一个 hypervisor 层实现对资源的彻底隔离。 容器则是操作系统级别的虚拟化，利用的是内核的 Cgroup 和 Namespace 特性，此功能完全通过软件实现。 Namespace 资源隔离 命名空间是全局资源的一种抽象，将资源放到不同的命名空间中，各个命名空间中的资源是相互隔离的。 通俗来讲，就是docker在启动一个容器的时候，会调用Linux Kernel Namespace的接口，来创建一块虚拟空间，创建的时候，可以支持设置下面这几种（可以随意选择）,docker默认都设置。\npid：用于进程隔离（PID：进程ID） net：管理网络接口（NET：网络） ipc：管理对 IPC 资源的访问（IPC：进程间通信（信号量、消息队列和共享内存）） mnt：管理文件系统挂载点（MNT：挂载） uts：隔离主机名和域名 user：隔离用户和用户组（3.8以后的内核才支持） func setNamespaces(daemon *Daemon, s *specs.Spec, c *container.Container) error { // user // network // ipc // uts // pid if c.HostConfig.PidMode.IsContainer() { ns := specs.LinuxNamespace{Type: \"pid\"} pc, err := daemon.getPidContainer(c) if err != nil { return err } ns.Path = fmt.Sprintf(\"/proc/%d/ns/pid\", pc.State.GetPID()) setNamespace(s, ns) } else if c.HostConfig.PidMode.IsHost() { oci.RemoveNamespace(s, specs.LinuxNamespaceType(\"pid\")) } else { ns := specs.LinuxNamespace{Type: \"pid\"} setNamespace(s, ns) } return nil } CGroup 资源限制 通过namespace可以保证容器之间的隔离，但是无法控制每个容器可以占用多少资源， 如果其中的某一个容器正在执行 CPU 密集型的任务，那么就会影响其他容器中任务的性能与执行效率，导致多个容器相互影响并且抢占资源。如何对多个容器的资源使用进行限制就成了解决进程虚拟资源隔离之后的主要问题。\nControl Groups（简称 CGroups）就是能够隔离宿主机器上的物理资源，例如 CPU、内存、磁盘 I/O 和网络带宽。每一个 CGroup 都是一组被相同的标准和参数限制的进程。而我们需要做的，其实就是把容器这个进程加入到指定的Cgroup中。深入理解CGroup，请点此。\nUnionFS 联合文件系统 Linux namespace和cgroup分别解决了容器的资源隔离与资源限制，那么容器是很轻量的，通常每台机器中可以运行几十上百个容器， 这些个容器是共用一个image，还是各自将这个image复制了一份，然后各自独立运行呢？ 如果每个容器之间都是全量的文件系统拷贝，那么会导致至少如下问题：\n运行容器的速度会变慢 容器和镜像对宿主机的磁盘空间的压力 怎么解决这个问题——Docker的存储驱动\n镜像分层存储 UnionFS Docker 镜像是由一系列的层组成的，每层代表 Dockerfile 中的一条指令，比如下面的 Dockerfile 文件：\nFROM ubuntu:15.04 COPY . /app RUN make /app CMD python /app/app.py 这里的 Dockerfile 包含4条命令，其中每一行就创建了一层，下面显示了上述Dockerfile构建出来的镜像运行的容器层的结构：\n镜像就是由这些层一层一层堆叠起来的，镜像中的这些层都是只读的，当我们运行容器的时候，就可以在这些基础层至上添加新的可写层，也就是我们通常说的容器层，对于运行中的容器所做的所有更改（比如写入新文件、修改现有文件、删除文件）都将写入这个容器层。\n对容器层的操作，主要利用了写时复制（CoW）技术。CoW就是copy-on-write，表示只在需要写时才去复制，这个是针对已有文件的修改场景。 CoW技术可以让所有的容器共享image的文件系统，所有数据都从image中读取，只有当要对文件进行写操作时，才从image里把要写的文件复制到自己的文件系统进行修改。所以无论有多少个容器共享同一个image，所做的写操作都是对从image中复制到自己的文件系统中的复本上进行，并不会修改image的源文件，且多个容器操作同一个文件，会在每个容器的文件系统里生成一个复本，每个容器修改的都是自己的复本，相互隔离，相互不影响。使用CoW可以有效的提高磁盘的利用率。\n镜像中每一层的文件都是分散在不同的目录中的，如何把这些不同目录的文件整合到一起呢？\nUnionFS 其实是一种为 Linux 操作系统设计的用于把多个文件系统联合到同一个挂载点的文件系统服务。 它能够将不同文件夹中的层联合（Union）到了同一个文件夹中，整个联合的过程被称为联合挂载（Union Mount）。\n上图是AUFS的实现，AUFS是作为Docker存储驱动的一种实现，Docker 还支持了不同的存储驱动，包括 aufs、devicemapper、overlay2、zfs 和 Btrfs 等等，在最新的 Docker 中，overlay2 取代了 aufs 成为了推荐的存储驱动，但是在没有 overlay2 驱动的机器上仍然会使用 aufs 作为 Docker 的默认驱动。\nDocker网络 录屏！！！ docker容器是一块具有隔离性的虚拟系统，容器内可以有自己独立的网络空间，\n多个容器之间是如何实现通信的呢？ 容器和宿主机之间又是如何实现的通信呢？ 使用-p参数是怎么实现的端口映射? 带着我们就这些问题，我们来学习一下docker的网络模型，最后我会通过抓包的方式，给大家演示一下数据包在容器和宿主机之间的转换过程。\n网络模式 我们在使用docker run创建Docker容器时，可以用–net选项指定容器的网络模式，Docker有以下4种网络模式：\nbridge模式，使用–net=bridge指定，默认设置\nhost模式，使用–net=host指定，容器内部网络空间共享宿主机的空间，效果类似直接在宿主机上启动一个进程，端口信息和宿主机共用。\ncontainer模式，使用–net=container:NAME_or_ID指定\n指定容器与特定容器共享网络命名空间\nnone模式，使用–net=none指定\n网络模式为空，即仅保留网络命名空间，但是不做任何网络相关的配置(网卡、IP、路由等)\nbridge模式 那我们之前在演示创建docker容器的时候其实是没有指定的网络模式的，如果不指定的话默认就会使用bridge模式，bridge本意是桥的意思，其实就是网桥模式，那我们怎么理解网桥，如果需要做类比的话，我们可以把网桥看成一个二层的交换机设备，我们来看下这张图：\n交换机通信简图\n网桥模式示意图\n网桥在哪，查看网桥\n$ yum install -y bridge-utils $ brctl show bridge name bridge id STP enabled interfaces docker0 8000.0242b5fbe57b no veth3a496ed 有了网桥之后，那我们看下docker在启动一个容器的时候做了哪些事情才能实现容器间的互联互通\nDocker 创建一个容器的时候，会执行如下操作：\n创建一对虚拟接口/网卡，也就是veth pair； 本地主机一端桥接 到默认的 docker0 或指定网桥上，并具有一个唯一的名字，如 veth9953b75； 容器一端放到新启动的容器内部，并修改名字作为 eth0，这个网卡/接口只在容器的命名空间可见； 从网桥可用地址段中（也就是与该bridge对应的network）获取一个空闲地址分配给容器的 eth0 配置默认路由到网桥 那整个过程其实是docker自动帮我们完成的，清理掉所有容器，来验证。\n## 清掉所有容器 $ docker rm -f `docker ps -aq` $ docker ps $ brctl show # 查看网桥中的接口，目前没有 ## 创建测试容器test1 $ docker run -d --name test1 nginx:alpine $ brctl show # 查看网桥中的接口，已经把test1的veth端接入到网桥中 $ ip a |grep veth # 已在宿主机中可以查看到 $ docker exec -ti test1 sh / # ifconfig # 查看容器的eth0网卡及分配的容器ip / # route -n # 观察默认网关都指向了网桥的地址，即所有流量都转向网桥，等于是在veth pair接通了网线 Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 172.17.0.1 0.0.0.0 UG 0 0 0 eth0 172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 eth0 # 再来启动一个测试容器，测试容器间的通信 $ docker run -d --name test2 nginx:alpine $ docker exec -ti test sh / # sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories / # apk add curl / # curl 172.17.0.8:80 ## 为啥可以通信，因为两个容器是接在同一个网桥中的，通信其实是通过mac地址和端口的的记录来做转发的。test1访问test2，通过test1的eth0发送ARP广播，网桥会维护一份mac映射表，我们可以大概通过命令来看一下， $ brctl showmacs docker0 ## 这些mac地址是主机端的veth网卡对应的mac，可以查看一下 $ ip a 我们如何知道网桥上的这些虚拟网卡与容器端是如何对应？\n通过ifindex，网卡索引号\n## 查看test1容器的网卡索引 $ docker exec -ti test1 cat /sys/class/net/eth0/ifindex ## 主机中找到虚拟网卡后面这个@ifxx的值，如果是同一个值，说明这个虚拟网卡和这个容器的eth0网卡是配对的。 $ ip a |grep @if 整理脚本，快速查看对应：\nfor container in $(docker ps -q); do iflink=`docker exec -it $container sh -c 'cat /sys/class/net/eth0/iflink'` iflink=`echo $iflink|tr -d '\\r'` veth=`grep -l $iflink /sys/class/net/veth*/ifindex` veth=`echo $veth|sed -e 's;^.*net/\\(.*\\)/ifindex$;\\1;'` echo $container:$veth done 上面我们讲解了容器之间的通信，那么容器与宿主机的通信是如何做的？\n添加端口映射：\n## 启动容器的时候通过-p参数添加宿主机端口与容器内部服务端口的映射 $ docker run --name test -d -p 8088:80 nginx:alpine $ curl localhost:8088 端口映射如何实现的？先来回顾iptables链表图\n访问本机的8088端口，数据包会从流入方向进入本机，因此涉及到PREROUTING和INPUT链，我们是通过做宿主机与容器之间加的端口映射，所以肯定会涉及到端口转换，那哪个表是负责存储端口转换信息的呢，就是nat表，负责维护网络地址转换信息的。因此我们来查看一下PREROUTING链的nat表：\n$ iptables -t nat -nvL PREROUTING Chain PREROUTING (policy ACCEPT 159 packets, 20790 bytes) pkts bytes target prot opt in out source destination 3 156 DOCKER all -- * * 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL 规则利用了iptables的addrtype拓展，匹配网络类型为本地的包，如何确定哪些是匹配本地，\n$ ip route show table local type local local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 local 172.17.0.1 dev docker0 proto kernel scope host src 172.17.0.1 local 192.168.136.133 dev ens33 proto kernel scope host src 192.168.136.133 也就是说目标地址类型匹配到这些的，会转发到我们的TARGET中，TARGET是动作，意味着对符合要求的数据包执行什么样的操作，最常见的为ACCEPT或者DROP，此处的TARGET为DOCKER，很明显DOCKER不是标准的动作，那DOCKER是什么呢？我们通常会定义自定义的链，这样把某类对应的规则放在自定义链中，然后把自定义的链绑定到标准的链路中，因此此处DOCKER 是自定义的链。那我们现在就来看一下DOCKER这个自定义链上的规则。\n$ iptables -t nat -nvL DOCKER Chain DOCKER (2 references) pkts bytes target prot opt in out source destination 0 0 RETURN all -- docker0 * 0.0.0.0/0 0.0.0.0/0 0 0 DNAT tcp -- !docker0 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:8088 to:172.17.0.2:80 此条规则就是对主机收到的目的端口为8088的tcp流量进行DNAT转换，将流量发往172.17.0.2:80，172.17.0.2地址是不是就是我们上面创建的Docker容器的ip地址，流量走到网桥上了，后面就走网桥的转发就ok了。 所以，外界只需访问192.168.136.133:8088就可以访问到容器中的服务了。\n数据包在出口方向走POSTROUTING链，我们查看一下规则：\n$ iptables -t nat -nvL POSTROUTING Chain POSTROUTING (policy ACCEPT 1099 packets, 67268 bytes) pkts bytes target prot opt in out source destination 86 5438 MASQUERADE all -- * !docker0 172.17.0.0/16 0.0.0.0/0 0 0 MASQUERADE tcp -- * * 172.17.0.4 172.17.0.4 tcp dpt:80 大家注意MASQUERADE这个动作是什么意思，其实是一种更灵活的SNAT，把源地址转换成主机的出口ip地址，那解释一下这条规则的意思:\n这条规则会将源地址为172.17.0.0/16的包（也就是从Docker容器产生的包），并且不是从docker0网卡发出的，进行源地址转换，转换成主机网卡的地址。大概的过程就是ACK的包在容器里面发出来，会路由到网桥docker0，网桥根据宿主机的路由规则会转给宿主机网卡eth0，这时候包就从docker0网卡转到eth0网卡了，并从eth0网卡发出去，这时候这条规则就会生效了，把源地址换成了eth0的ip地址。\n注意一下，刚才这个过程涉及到了网卡间包的传递，那一定要打开主机的ip_forward转发服务，要不然包转不了，服务肯定访问不到。\n抓包演示 我们先想一下，我们要抓哪个网卡的包\n首先访问宿主机的8088端口，我们抓一下宿主机的eth0\n$ tcpdump -i eth0 port 8088 -w host.cap 然后最终包会流入容器内，那我们抓一下容器内的eth0网卡\n# 容器内安装一下tcpdump $ sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories $ apk add tcpdump $ tcpdump -i eth0 port 80 -w container.cap 到另一台机器访问一下，\n$ curl 172.21.32.6:8088/ 停止抓包，拷贝容器内的包到宿主机\n$ docker cp test:/root/container.cap /root/ 把抓到的内容拷贝到本地，使用wireshark进行分析。\n$ scp root@172.21.32.6:/root/*.cap /d/packages （wireshark合并包进行分析）\n进到容器内的包做DNAT，出去的包做SNAT，这样对外面来讲，根本就不知道机器内部是谁提供服务，其实这就和一个内网多个机器公用一个外网IP地址上网的效果是一样的，对吧，那这也属于NAT功能的一个常见的应用场景。\nHost模式 容器内部不会创建网络空间，共享宿主机的网络空间\n$ docker run --net host -d --name mysql mysql:5.7 Conatiner模式 这个模式指定新创建的容器和已经存在的一个容器共享一个 Network Namespace，而不是和宿主机共享。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过 lo 网卡设备通信。\n## 启动测试容器，共享mysql的网络空间 $ docker run -ti --rm --net=container:mysql busybox sh / # ip a / # netstat -tlp|grep 3306 / # telnet localhost 3306 实用技巧 清理主机上所有退出的容器\n$ docker rm $(docker ps -aq) 调试或者排查容器启动错误\n## 若有时遇到容器启动失败的情况，可以先使用相同的镜像启动一个临时容器，先进入容器 $ docker exec -ti --rm \u003cimage_id\u003e bash ## 进入容器后，手动执行该容器对应的ENTRYPOINT或者CMD命令，这样即使出错，容器也不会退出，因为bash作为1号进程，我们只要不退出容器，该容器就不会自动退出 本章小结 为了解决软件交付过程中的环境依赖，同时提供一种更加轻量的虚拟化技术，Docker出现了\n2013年诞生，15年开始迅速发展，从17.03月开始，使用时间日期管理版本，稳定版以每季度为准\nDocker是一种CS架构的软件产品，可以把代码及依赖打包成镜像，作为交付介质，并且把镜像启动成为容器，提供容器生命周期的管理\n使用yum部署docker，启动后通过操作docker这个命令行，自动调用docker daemon完成容器相关操作\n常用操作\nsystemctl start|stop|restart docker docker build | pull -\u003e docker tag -\u003e docker push docker run –name my-demo -d -p 8080:80 -v /opt/data:/data demo:v20200327 docker cp /path/a.txt mycontainer:/opt docker exec -ti mycontainer /bin/sh docker logs -f mycontainer 通过dockerfile构建业务镜像，先使用基础镜像，然后通过一系列的指令把我们的业务应用所需要的运行环境和依赖都打包到镜像中，然后通过CMD或者ENTRYPOINT指令把镜像启动时的入口制定好，完成封装即可。有点类似于，先找来一个空的集装箱(基础镜像)，然后把项目依赖的服务都扔到集装箱中，然后设置好服务的启动入口，关闭箱门，即完成了业务镜像的制作。\n容器的实现依赖于内核模块提供的namespace和control-group的功能，通过namespace创建一块虚拟空间，空间内实现了各类资源(进程、网络、文件系统)的隔离，提供control-group实现了对隔离的空间的资源使用的限制。\ndocker镜像使用分层的方式进行存储，根据主机的存储驱动的不同，实现方式会不同，kernel在3.10.0-514以上自动支持overlay2 存储驱动，也是目前Docker推荐的方式。\n得益于分层存储的模式，多个容器可以通过copy-on-write的策略，在镜像的最上层加一个可写层，实现一个镜像快速启动多个容器的场景\ndocker的网络模式分为4种，最常用的为bridge和host模式。bridge模式通过docker0网桥，启动容器的时候通过创建一对虚拟网卡，将容器连接在桥上，同时维护了虚拟网卡与网桥端口的关系，实现容器间的通信。容器与宿主机之间的通信通过iptables端口映射的方式，docker利用iptables的PREROUTING和POSTROUTING的nat功能，实现了SNAT与DNAT，使得容器内部的服务被完美的保护起来。\n第二章 Kubernetes实践之旅 录屏！！！ 本章学习kubernetes的架构及工作流程，重点介绍如何使用Deployment管理Pod生命周期，实现服务不中断的滚动更新，通过服务发现来实现集群内部的服务间访问，并通过ingress-nginx实现外部使用域名访问集群内部的服务。同时介绍基于EFK如何搭建Kubernetes集群的日志收集系统。\n学完本章，我们的Django demo项目已经可以运行在k8s集群中，同时我们可以使用域名进行服务的访问。\n架构及核心组件介绍 使用kubeadm快速搭建集群 运行第一个Pod应用 Pod进阶 Pod控制器的使用 实现服务与Node绑定的几种方式 负载均衡与服务发现 使用Ingress实现集群服务的7层代理 Django项目k8s落地实践 基于EFK实现kubernetes集群的日志平台（扩展） 集群认证与授权 纯容器模式的问题 业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？ 跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？ 跨主机容器间互相调用，配置如何写？写死固定IP+端口？ 如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？ 容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器? 如何实现滚动升级保证业务的连续性？ …… 容器调度管理平台 Docker Swarm Mesos Google Kubernetes\n2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀\nhttps://kubernetes.io/\n架构图 区分组件与资源\n核心组件 ETCD：分布式高性能键值数据库,存储整个集群的所有元数据\nApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制\nScheduler：调度器,负责把业务容器调度到最合适的Node节点\nController Manager：控制器管理,确保集群资源按照期望的方式运行\nReplication Controller Node controller ResourceQuota Controller Namespace Controller ServiceAccount Controller Tocken Controller Service Controller Endpoints Controller kubelet：运行在每运行在每个节点上的主要的“节点代理”个节点上的主要的“节点代理”\npod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。 容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理. 容器监控：kubelet 会监控所在节点的资源使用情况，并定时向 master 报告，资源使用数据都是通过 cAdvisor 获取的。知道整个集群所有节点的资源情况，对于 pod 的调度和正常运行至关重要 kubectl: 命令行接口，用于对 Kubernetes 集群运行命令 https://kubernetes.io/zh/docs/reference/kubectl/\nCNI实现: 通用网络接口, 我们使用flannel来作为k8s集群的网络插件, 实现跨节点通信\n工作流程 用户准备一个资源文件（记录了业务应用的名称、镜像地址等信息），通过调用APIServer执行创建Pod APIServer收到用户的Pod创建请求，将Pod信息写入到etcd中 调度器通过list-watch的方式，发现有新的pod数据，但是这个pod还没有绑定到某一个节点中 调度器通过调度算法，计算出最适合该pod运行的节点，并调用APIServer，把信息更新到etcd中 kubelet同样通过list-watch方式，发现有新的pod调度到本机的节点了，因此调用容器运行时，去根据pod的描述信息，拉取镜像，启动容器，同时生成事件信息 同时，把容器的信息、事件及状态也通过APIServer写入到etcd中 实践–集群安装 录屏！！！ kubeadm https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/\n《Kubernetes安装手册（非高可用版）》\n核心组件 静态Pod的方式：\n## etcd、apiserver、controller-manager、kube-scheduler $ kubectl -n kube-system get po systemd服务方式：\n$ systemctl status kubelet kubectl：二进制命令行工具\n理解集群资源 组件是为了支撑k8s平台的运行，安装好的软件。\n资源是如何去使用k8s的能力的定义。比如，k8s可以使用Pod来管理业务应用，那么Pod就是k8s集群中的一类资源，集群中的所有资源可以提供如下方式查看：\n$ kubectl api-resources 如何理解namespace：\n命名空间，集群内一个虚拟的概念，类似于资源池的概念，一个池子里可以有各种资源类型，绝大多数的资源都必须属于某一个namespace。集群初始化安装好之后，会默认有如下几个namespace：\n$ kubectl get namespaces NAME STATUS AGE default Active 84m kube-node-lease Active 84m kube-public Active 84m kube-system Active 84m kubernetes-dashboard Active 71m 所有NAMESPACED的资源，在创建的时候都需要指定namespace，若不指定，默认会在default命名空间下 相同namespace下的同类资源不可以重名，不同类型的资源可以重名 不同namespace下的同类资源可以重名 通常在项目使用的时候，我们会创建带有业务含义的namespace来做逻辑上的整合 kubectl的使用 类似于docker，kubectl是命令行工具，用于与APIServer交互，内置了丰富的子命令，功能极其强大。 https://kubernetes.io/docs/reference/kubectl/overview/\n$ kubectl -h $ kubectl get -h $ kubectl create -h $ kubectl create namespace -h kubectl如何管理集群资源\n$ kubectl get po -v=7 实践–使用k8s管理业务应用 最小调度单元 Pod 录屏！！！ docker调度的是容器，在k8s集群中，最小的调度单元是Pod（豆荚）\n为什么引入Pod 与容器引擎解耦\nDocker、Rkt。平台设计与引擎的具体的实现解耦\n多容器共享网络|存储|进程 空间, 支持的业务场景更加灵活\n使用yaml格式定义Pod myblog/one-pod/pod.yaml\napiVersion: v1 kind: Pod metadata: name: myblog namespace: demo labels: component: myblog spec: containers: - name: myblog image: 172.21.32.6:5000/myblog env: - name: MYSQL_HOST # 指定root用户的用户名 value: \"127.0.0.1\" - name: MYSQL_PASSWD value: \"123456\" ports: - containerPort: 8002 - name: mysql image: 172.21.32.6:5000/mysql:5.7-utf8 ports: - containerPort: 3306 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" - name: MYSQL_DATABASE value: \"myblog\" { \"apiVersion\": \"v1\",\t\"kind\": \"Pod\", \"metadata\": { \"name\": \"myblog\", \"namespace\": \"demo\", \"labels\": { \"component\": \"myblog\" } }, \"spec\": { \"containers\": [ { \"name\": \"myblog\", \"image\": \"172.21.32.6:5000/myblog\", \"env\": [ { \"name\": \"MYSQL_HOST\", \"value\": \"127.0.0.1\" }, { \"name\": \"MYSQL_PASSWD\", \"value\": \"123456\" } ], \"ports\": [ { \"containerPort\": 8002 } ] }, { \"name\": \"mysql\", ... } ] } } apiVersion 含义 alpha 进入K8s功能的早期候选版本，可能包含Bug，最终不一定进入K8s beta 已经过测试的版本，最终会进入K8s，但功能、对象定义可能会发生变更。 stable 可安全使用的稳定版本 v1 stable 版本之后的首个版本，包含了更多的核心对象 apps/v1 使用最广泛的版本，像Deployment、ReplicaSets都已进入该版本 资源类型与apiVersion对照表\nKind apiVersion ClusterRoleBinding rbac.authorization.k8s.io/v1 ClusterRole rbac.authorization.k8s.io/v1 ConfigMap v1 CronJob batch/v1beta1 DaemonSet extensions/v1beta1 Node v1 Namespace v1 Secret v1 PersistentVolume v1 PersistentVolumeClaim v1 Pod v1 Deployment v1、apps/v1、apps/v1beta1、apps/v1beta2 Service v1 Ingress extensions/v1beta1 ReplicaSet apps/v1、apps/v1beta2 Job batch/v1 StatefulSet apps/v1、apps/v1beta1、apps/v1beta2 快速获得资源和版本\n$ kubectl explain pod $ kubectl explain Pod.apiVersion 创建和访问Pod ## 创建namespace, namespace是逻辑上的资源池 $ kubectl create namespace demo ## 使用指定文件创建Pod $ kubectl create -f demo-pod.yaml ## 查看pod，可以简写po ## 所有的操作都需要指定namespace，如果是在default命名空间下，则可以省略 $ kubectl -n demo get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE myblog 2/2 Running 0 3m 10.244.1.146 k8s-slave1 ## 使用Pod Ip访问服务,3306和8002 $ curl 10.244.1.146:8002/blog/index/ ## 进入容器,执行初始化, 不必到对应的主机执行docker exec $ kubectl -n demo exec -ti myblog -c myblog bash / # env / # python3 manage.py migrate $ kubectl -n demo exec -ti myblog -c mysql bash / # mysql -p123456 ## 再次访问服务,3306和8002 $ curl 10.244.1.146:8002/blog/index/ Infra容器 登录k8s-slave1节点\n$ docker ps -a |grep myblog ## 发现有三个容器 ## 其中包含mysql和myblog程序以及Infra容器 ## 为了实现Pod内部的容器可以通过localhost通信，每个Pod都会启动Infra容器，然后Pod内部的其他容器的网络空间会共享该Infra容器的网络空间(Docker网络的container模式)，Infra容器只需要hang住网络空间，不需要额外的功能，因此资源消耗极低。 ## 登录master节点，查看pod内部的容器ip均相同，为pod ip $ kubectl -n demo exec -ti myblog -c myblog bash / # ifconfig $ kubectl -n demo exec -ti myblog -c mysql bash / # ifconfig pod容器命名: k8s____\n查看pod详细信息 ## 查看pod调度节点及pod_ip $ kubectl -n demo get pods -o wide ## 查看完整的yaml $ kubectl -n demo get po myblog -o yaml ## 查看pod的明细信息及事件 $ kubectl -n demo describe pod myblog Troubleshooting and Debugging #进入Pod内的容器 $ kubectl -n \u003cnamespace\u003e exec \u003cpod_name\u003e -c \u003ccontainer_name\u003e -ti /bin/sh #查看Pod内容器日志,显示标准或者错误输出日志 $ kubectl -n \u003cnamespace\u003e logs -f \u003cpod_name\u003e -c \u003ccontainer_name\u003e 更新服务版本 $ kubectl apply -f demo-pod.yaml 删除Pod服务 #根据文件删除 $ kubectl delete -f demo-pod.yaml #根据pod_name删除 $ kubectl -n \u003cnamespace\u003e delete pod \u003cpod_name\u003e Pod数据持久化 若删除了Pod，由于mysql的数据都在容器内部，会造成数据丢失，因此需要数据进行持久化。\n定点使用hostpath挂载，nodeSelector定点\nmyblog/one-pod/pod-with-volume.yaml\napiVersion: v1 kind: Pod metadata: name: myblog namespace: demo labels: component: myblog spec: volumes: - name: mysql-data hostPath: path: /opt/mysql/data nodeSelector: # 使用节点选择器将Pod调度到指定label的节点 component: mysql containers: - name: myblog image: 172.21.32.6:5000/myblog env: - name: MYSQL_HOST # 指定root用户的用户名 value: \"127.0.0.1\" - name: MYSQL_PASSWD value: \"123456\" ports: - containerPort: 8002 - name: mysql image: 172.21.32.6:5000/mysql:5.7-utf8 ports: - containerPort: 3306 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" - name: MYSQL_DATABASE value: \"myblog\" volumeMounts: - name: mysql-data mountPath: /var/lib/mysql 保存文件为pod-with-volume.yaml，执行创建\n## 若存在旧的同名服务，先删除掉，后创建 $ kubectl -n demo delete pod myblog ## 创建 $ kubectl create -f pod-with-volume.yaml ## 此时pod状态Pending $ kubectl -n demo get po NAME READY STATUS RESTARTS AGE myblog 0/2 Pending 0 32s ## 查看原因，提示调度失败，因为节点不满足node selector $ kubectl -n demo describe po myblog Events: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedScheduling 12s (x2 over 12s) default-scheduler 0/3 nodes are available: 3 node(s) didn't match node selector. ## 为节点打标签 $ kubectl label node k8s-slave1 component=mysql ## 再次查看，已经运行成功 $ kubectl -n demo get po NAME READY STATUS RESTARTS AGE IP NODE myblog 2/2 Running 0 3m54s 10.244.1.150 k8s-slave1 ## 到k8s-slave1节点，查看/opt/mysql/data $ ll /opt/mysql/data/ total 188484 -rw-r----- 1 polkitd input 56 Mar 29 09:20 auto.cnf -rw------- 1 polkitd input 1676 Mar 29 09:20 ca-key.pem -rw-r--r-- 1 polkitd input 1112 Mar 29 09:20 ca.pem drwxr-x--- 2 polkitd input 8192 Mar 29 09:20 sys ... ## 执行migrate，创建数据库表，然后删掉pod，再次创建后验证数据是否存在 $ kubectl -n demo exec -ti myblog python3 manage.py migrate ## 访问服务，正常 $ curl 10.244.1.150:8002/blog/index/ ## 删除pod $ kubectl delete -f pod-with-volume.yaml ## 再次创建Pod $ kubectl create -f pod-with-volume.yaml ## 查看pod ip并访问服务 $ kubectl -n demo get po -o wide NAME READY STATUS RESTARTS AGE IP NODE myblog 2/2 Running 0 7s 10.244.1.151 k8s-slave1 ## 未做migrate，服务正常 $ curl 10.244.1.151:8002/blog/index/ 使用PV+PVC连接分布式存储解决方案\nceph glusterfs nfs 服务健康检查 检测容器服务是否健康的手段，若不健康，会根据设置的重启策略（restartPolicy）进行操作，两种检测机制可以分别单独设置，若不设置，默认认为Pod是健康的。\n两种机制：\nLivenessProbe探针 用于判断容器是否存活，即Pod是否为running状态，如果LivenessProbe探针探测到容器不健康，则kubelet将kill掉容器，并根据容器的重启策略是否重启，如果一个容器不包含LivenessProbe探针，则Kubelet认为容器的LivenessProbe探针的返回值永远成功。 ReadinessProbe探针 用于判断容器是否正常提供服务，即容器的Ready是否为True，是否可以接收请求，如果ReadinessProbe探测失败，则容器的Ready将为False，控制器将此Pod的Endpoint从对应的service的Endpoint列表中移除，从此不再将任何请求调度此Pod上，直到下次探测成功。（剔除此pod不参与接收请求不会将流量转发给此Pod）。 三种类型：\nexec：通过执行命令来检查服务是否正常，回值为0则表示容器健康 httpGet方式：通过发送http请求检查服务是否正常，返回200-399状态码则表明容器健康 tcpSocket：通过容器的IP和Port执行TCP检查，如果能够建立TCP连接，则表明容器健康 示例：\n完整文件路径 myblog/one-pod/pod-with-healthcheck.yaml\ncontainers: - name: myblog image: 172.21.32.6:5000/myblog env: - name: MYSQL_HOST # 指定root用户的用户名 value: \"127.0.0.1\" - name: MYSQL_PASSWD value: \"123456\" ports: - containerPort: 8002 livenessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒 periodSeconds: 15 # 执行探测的频率 timeoutSeconds: 2\t# 探测超时时间 readinessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 timeoutSeconds: 2 periodSeconds: 15 initialDelaySeconds：容器启动后第一次执行探测是需要等待多少秒。 periodSeconds：执行探测的频率。默认是10秒，最小1秒。 timeoutSeconds：探测超时时间。默认1秒，最小1秒。 successThreshold：探测失败后，最少连续探测成功多少次才被认定为成功。默认是1。对于liveness必须是1，最小值是1。 failureThreshold：探测成功后，最少连续探测失败多少次 才被认定为失败。默认是3，最小值是1。 重启策略：\nPod的重启策略（RestartPolicy）应用于Pod内的所有容器，并且仅在Pod所处的Node上由kubelet进行判断和重启操作。当某个容器异常退出或者健康检查失败时，kubelet将根据RestartPolicy的设置来进行相应的操作。 Pod的重启策略包括Always、OnFailure和Never，默认值为Always。\nAlways：当容器失败时，由kubelet自动重启该容器； OnFailure：当容器终止运行且退出码不为0时，有kubelet自动重启该容器； Never：不论容器运行状态如何，kubelet都不会重启该容器。 镜像拉取策略 spec: containers: - name: myblog image: 172.21.32.6:5000/demo/myblog imagePullPolicy: IfNotPresent 设置镜像的拉取策略，默认为IfNotPresent\nAlways，总是拉取镜像，即使本地有镜像也从仓库拉取 IfNotPresent ，本地有则使用本地镜像，本地没有则去仓库拉取 Never，只使用本地镜像，本地没有则报错 Pod资源限制 为了保证充分利用集群资源，且确保重要容器在运行周期内能够分配到足够的资源稳定运行，因此平台需要具备\nPod的资源限制的能力。 对于一个pod来说，资源最基础的2个的指标就是：CPU和内存。\nKubernetes提供了个采用requests和limits 两种类型参数对资源进行预分配和使用限制。\n完整文件路径：myblog/one-pod/pod-with-resourcelimits.yaml\n... containers: - name: myblog image: 172.21.32.6:5000/myblog env: - name: MYSQL_HOST # 指定root用户的用户名 value: \"127.0.0.1\" - name: MYSQL_PASSWD value: \"123456\" ports: - containerPort: 8002 resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m ... requests：\n容器使用的最小资源需求,作用于schedule阶段，作为容器调度时资源分配的判断依赖 只有当前节点上可分配的资源量 \u003e= request 时才允许将容器调度到该节点 request参数不限制容器的最大可使用资源 requests.cpu被转成docker的–cpu-shares参数，与cgroup cpu.shares功能相同 (无论宿主机有多少个cpu或者内核，–cpu-shares选项都会按照比例分配cpu资源） requests.memory没有对应的docker参数，仅作为k8s调度依据 limits：\n容器能使用资源的最大值 设置为0表示对使用的资源不做限制, 可无限的使用 当pod 内存超过limit时，会被oom 当cpu超过limit时，不会被kill，但是会限制不超过limit值 limits.cpu会被转换成docker的–cpu-quota参数。与cgroup cpu.cfs_quota_us功能相同 limits.memory会被转换成docker的–memory参数。用来限制容器使用的最大内存 对于 CPU，我们知道计算机里 CPU 的资源是按“时间片”的方式来进行分配的，系统里的每一个操作都需要 CPU 的处理，所以，哪个任务要是申请的 CPU 时间片越多，那么它得到的 CPU 资源就越多。\n然后还需要了解下 CGroup 里面对于 CPU 资源的单位换算：\n1 CPU = 1000 millicpu（1 Core = 1000m） 这里的 m 就是毫、毫核的意思，Kubernetes 集群中的每一个节点可以通过操作系统的命令来确认本节点的 CPU 内核数量，然后将这个数量乘以1000，得到的就是节点总 CPU 总毫数。比如一个节点有四核，那么该节点的 CPU 总毫量为 4000m。\ndocker run命令和 CPU 限制相关的所有选项如下：\n选项 描述 --cpuset-cpus=\"\" 允许使用的 CPU 集，值可以为 0-3,0,1 -c,--cpu-shares=0 CPU 共享权值（相对权重） cpu-period=0 限制 CPU CFS 的周期，范围从 100ms~1s，即[1000, 1000000] --cpu-quota=0 限制 CPU CFS 配额，必须不小于1ms，即 \u003e= 1000，绝对限制 docker run -it --cpu-period=50000 --cpu-quota=25000 ubuntu:16.04 /bin/bash 将 CFS 调度的周期设为 50000，将容器在每个周期内的 CPU 配额设置为 25000，表示该容器每 50ms 可以得到 50% 的 CPU 运行时间。\n注意：若内存使用超出限制，会引发系统的OOM机制，因CPU是可压缩资源，不会引发Pod退出或重建\nyaml优化 目前完善后的yaml，myblog/one-pod/pod-completed.yaml\napiVersion: v1 kind: Pod metadata: name: myblog namespace: demo labels: component: myblog spec: volumes: - name: mysql-data hostPath: path: /opt/mysql/data nodeSelector: # 使用节点选择器将Pod调度到指定label的节点 component: mysql containers: - name: myblog image: 172.21.32.6:5000/myblog env: - name: MYSQL_HOST # 指定root用户的用户名 value: \"127.0.0.1\" - name: MYSQL_PASSWD value: \"123456\" ports: - containerPort: 8002 resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m livenessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒 periodSeconds: 15 # 执行探测的频率 timeoutSeconds: 2\t# 探测超时时间 readinessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 timeoutSeconds: 2 periodSeconds: 15 - name: mysql image: 172.21.32.6:5000/mysql:5.7-utf8 ports: - containerPort: 3306 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" - name: MYSQL_DATABASE value: \"myblog\" resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m readinessProbe: tcpSocket: port: 3306 initialDelaySeconds: 5 periodSeconds: 10 livenessProbe: tcpSocket: port: 3306 initialDelaySeconds: 15 periodSeconds: 20 volumeMounts: - name: mysql-data mountPath: /var/lib/mysql 为什么要优化\n考虑真实的使用场景，像数据库这类中间件，是作为公共资源，为多个项目提供服务，不适合和业务容器绑定在同一个Pod中，因为业务容器是经常变更的，而数据库不需要频繁迭代 yaml的环境变量中存在敏感信息（账号、密码），存在安全隐患 解决问题一，需要拆分yaml\nmyblog/two-pod/mysql.yaml\napiVersion: v1 kind: Pod metadata: name: mysql namespace: demo labels: component: mysql spec: hostNetwork: true\t# 声明pod的网络模式为host模式，效果通docker run --net=host volumes: - name: mysql-data hostPath: path: /opt/mysql/data nodeSelector: # 使用节点选择器将Pod调度到指定label的节点 component: mysql containers: - name: mysql image: 172.21.32.6:5000/mysql:5.7-utf8 ports: - containerPort: 3306 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" - name: MYSQL_DATABASE value: \"myblog\" resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m readinessProbe: tcpSocket: port: 3306 initialDelaySeconds: 5 periodSeconds: 10 livenessProbe: tcpSocket: port: 3306 initialDelaySeconds: 15 periodSeconds: 20 volumeMounts: - name: mysql-data mountPath: /var/lib/mysql myblog.yaml\napiVersion: v1 kind: Pod metadata: name: myblog namespace: demo labels: component: myblog spec: containers: - name: myblog image: 172.21.32.6:5000/myblog imagePullPolicy: IfNotPresent env: - name: MYSQL_HOST # 指定root用户的用户名 value: \"172.21.32.6\" - name: MYSQL_PASSWD value: \"123456\" ports: - containerPort: 8002 resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m livenessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒 periodSeconds: 15 # 执行探测的频率 timeoutSeconds: 2\t# 探测超时时间 readinessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 timeoutSeconds: 2 periodSeconds: 15 创建测试\n## 先删除旧pod $ kubectl -n demo delete po myblog ## 分别创建mysql和myblog $ kubectl create -f mysql.yaml $ kubectl create -f myblog.yaml ## 查看pod，注意mysqlIP为宿主机IP，因为网络模式为host $ kubectl -n demo get po -o wide NAME READY STATUS RESTARTS AGE IP NODE myblog 1/1 Running 0 41s 10.244.1.152 k8s-slave1 mysql 1/1 Running 0 52s 192.168.136.131 k8s-slave1 ## 访问myblog服务正常 $ curl 10.244.1.152:8002/blog/index/ 解决问题二，环境变量中敏感信息带来的安全隐患\n为什么要统一管理环境变量\n环境变量中有很多敏感的信息，比如账号密码，直接暴漏在yaml文件中存在安全性问题 团队内部一般存在多个项目，这些项目直接存在配置相同环境变量的情况，因此可以统一维护管理 对于开发、测试、生产环境，由于配置均不同，每套环境部署的时候都要修改yaml，带来额外的开销 k8s提供两类资源，configMap和Secret，可以用来实现业务配置的统一管理， 允许将配置文件与镜像文件分离，以使容器化的应用程序具有可移植性 。\nconfigMap，通常用来管理应用的配置文件或者环境变量，myblog/two-pod/configmap.yaml\napiVersion: v1 kind: ConfigMap metadata: name: myblog namespace: demo data: MYSQL_HOST: \"172.21.32.6\" MYSQL_PORT: \"3306\" Secret，管理敏感类的信息，默认会base64编码存储，有三种类型\nService Account ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；创建ServiceAccount后，Pod中指定serviceAccount后，自动创建该ServiceAccount对应的secret； Opaque ： base64编码格式的Secret，用来存储密码、密钥等； kubernetes.io/dockerconfigjson ：用来存储私有docker registry的认证信息。 myblog/two-pod/secret.yaml\napiVersion: v1 kind: Secret metadata: name: myblog namespace: demo type: Opaque data: MYSQL_USER: cm9vdA==\t#注意加-n参数， echo -n root|base64 MYSQL_PASSWD: MTIzNDU2 创建并查看：\n$ kubectl create -f secret.yaml $ kubectl -n demo get secret 如果不习惯这种方式，可以通过如下方式：\n$ cat secret.txt MYSQL_USER=root MYSQL_PASSWD=123456 $ kubectl -n demo create secret generic myblog --from-env-file=secret.txt 修改后的mysql的yaml，资源路径：myblog/two-pod/mysql-with-config.yaml\n... spec: containers: - name: mysql image: 172.21.32.6:5000/mysql:5.7-utf8 env: - name: MYSQL_USER valueFrom: secretKeyRef: name: myblog key: MYSQL_USER - name: MYSQL_PASSWD valueFrom: secretKeyRef: name: myblog key: MYSQL_PASSWD - name: MYSQL_DATABASE value: \"myblog\" ... 修改后的myblog的yaml，资源路径：myblog/two-pod/myblog-with-config.yaml\nspec: containers: - name: myblog image: 172.21.32.6:5000/myblog imagePullPolicy: IfNotPresent env: - name: MYSQL_HOST valueFrom: configMapKeyRef: name: myblog key: MYSQL_HOST - name: MYSQL_PORT valueFrom: configMapKeyRef: name: myblog key: MYSQL_PORT - name: MYSQL_USER valueFrom: secretKeyRef: name: myblog key: MYSQL_USER - name: MYSQL_PASSWD valueFrom: secretKeyRef: name: myblog key: MYSQL_PASSWD 在部署不同的环境时，pod的yaml无须再变化，只需要在每套环境中维护一套ConfigMap和Secret即可。但是注意configmap和secret不能跨namespace使用，且更新后，pod内的env不会自动更新，重建后方可更新。\n如何编写资源yaml 拿来主义，从机器中已有的资源中拿\n$ kubectl -n kube-system get po,deployment,ds 学会在官网查找， https://kubernetes.io/docs/home/\n从kubernetes-api文档中查找， https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core\nkubectl explain 查看具体字段含义\npod状态与生命周期 Pod的状态如下表所示：\n状态值 描述 Pending API Server已经创建该Pod，等待调度器调度 ContainerCreating 镜像正在创建 Running Pod内容器均已创建，且至少有一个容器处于运行状态、正在启动状态或正在重启状态 Succeeded Pod内所有容器均已成功执行退出，且不再重启 Failed Pod内所有容器均已退出，但至少有一个容器退出为失败状态 CrashLoopBackOff Pod内有容器启动失败，比如配置文件丢失导致主进程启动失败 Unknown 由于某种原因无法获取该Pod的状态，可能由于网络通信不畅导致 生命周期示意图：\n启动和关闭示意：\napiVersion: v1 kind: Pod metadata: name: demo-start-stop namespace: demo labels: component: demo-start-stop spec: initContainers: - name: init image: busybox command: ['sh', '-c', 'echo $(date +%s): INIT \u003e\u003e /loap/timing'] volumeMounts: - mountPath: /loap name: timing containers: - name: main image: busybox command: ['sh', '-c', 'echo $(date +%s): START \u003e\u003e /loap/timing; sleep 10; echo $(date +%s): END \u003e\u003e /loap/timing;'] volumeMounts: - mountPath: /loap name: timing livenessProbe: exec: command: ['sh', '-c', 'echo $(date +%s): LIVENESS \u003e\u003e /loap/timing'] readinessProbe: exec: command: ['sh', '-c', 'echo $(date +%s): READINESS \u003e\u003e /loap/timing'] lifecycle: postStart: exec: command: ['sh', '-c', 'echo $(date +%s): POST-START \u003e\u003e /loap/timing'] preStop: exec: command: ['sh', '-c', 'echo $(date +%s): PRE-STOP \u003e\u003e /loap/timing'] volumes: - name: timing hostPath: path: /tmp/loap 创建pod测试：\n$ kubectl create -f demo-pod-start.yaml ## 查看demo状态 $ kubectl -n demo get po -o wide -w ## 查看调度节点的/tmp/loap/timing $ cat /tmp/loap/timing 1585424708: INIT 1585424746: START 1585424746: POST-START 1585424754: READINESS 1585424756: LIVENESS 1585424756: END 须主动杀掉 Pod 才会触发 pre-stop hook，如果是 Pod 自己 Down 掉，则不会执行 pre-stop hook\n小结 实现k8s平台与特定的容器运行时解耦，提供更加灵活的业务部署方式，引入了Pod概念 k8s使用yaml格式定义资源文件，yaml中Map与List的语法，与json做类比 通过kubectl create | get | exec | logs | delete 等操作k8s资源，必须指定namespace 每启动一个Pod，为了实现网络空间共享，会先创建Infra容器，并把其他容器网络加入该容器 通过livenessProbe和readinessProbe实现Pod的存活性和就绪健康检查 通过requests和limit分别限定容器初始资源申请与最高上限资源申请 通过Pod IP访问具体的Pod服务，实现是 Pod控制器 录屏！！！ 只使用Pod, 将会面临如下需求:\n业务应用启动多个副本 Pod重建后IP会变化，外部如何访问Pod服务 运行业务Pod的某个节点挂了，可以自动帮我把Pod转移到集群中的可用节点启动起来 我的业务应用功能是收集节点监控数据,需要把Pod运行在k8集群的各个节点上 Workload (工作负载) 控制器又称工作负载是用于实现管理pod的中间层，确保pod资源符合预期的状态，pod的资源出现故障时，会尝试 进行重启，当根据重启策略无效，则会重新新建pod的资源。\nReplicaSet: 代用户创建指定数量的pod副本数量，确保pod副本数量符合预期状态，并且支持滚动式自动扩容和缩容功能 Deployment：工作在ReplicaSet之上，用于管理无状态应用，目前来说最好的控制器。支持滚动更新和回滚功能，还提供声明式配置 DaemonSet：用于确保集群中的每一个节点只运行特定的pod副本，通常用于实现系统级后台任务。比如ELK服务 Job：只要完成就立即退出，不需要重启或重建 Cronjob：周期性任务控制，不需要持续后台运行 StatefulSet：管理有状态应用 Deployment myblog/deployment/deploy-mysql.yaml\napiVersion: apps/v1 kind: Deployment metadata: name: mysql namespace: demo spec: replicas: 1\t#指定Pod副本数 selector:\t#指定Pod的选择器 matchLabels: app: mysql template: metadata: labels:\t#给Pod打label app: mysql spec: hostNetwork: true\t# 声明pod的网络模式为host模式，效果通docker run --net=host volumes: - name: mysql-data hostPath: path: /opt/mysql/data nodeSelector: # 使用节点选择器将Pod调度到指定label的节点 component: mysql containers: - name: mysql image: 172.21.32.15:5000/mysql:5.7-utf8 ports: - containerPort: 3306 env: - name: MYSQL_USER valueFrom: secretKeyRef: name: myblog key: MYSQL_USER - name: MYSQL_PASSWD valueFrom: secretKeyRef: name: myblog key: MYSQL_PASSWD - name: MYSQL_DATABASE value: \"myblog\" resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m readinessProbe: tcpSocket: port: 3306 initialDelaySeconds: 5 periodSeconds: 10 livenessProbe: tcpSocket: port: 3306 initialDelaySeconds: 15 periodSeconds: 20 volumeMounts: - name: mysql-data mountPath: /var/lib/mysql deploy-myblog.yaml:\napiVersion: apps/v1 kind: Deployment metadata: name: myblog namespace: demo spec: replicas: 1\t#指定Pod副本数 selector:\t#指定Pod的选择器 matchLabels: app: myblog template: metadata: labels:\t#给Pod打label app: myblog spec: containers: - name: myblog image: 172.21.32.15:5000/myblog imagePullPolicy: IfNotPresent env: - name: MYSQL_HOST valueFrom: configMapKeyRef: name: myblog key: MYSQL_HOST - name: MYSQL_PORT valueFrom: configMapKeyRef: name: myblog key: MYSQL_PORT - name: MYSQL_USER valueFrom: secretKeyRef: name: myblog key: MYSQL_USER - name: MYSQL_PASSWD valueFrom: secretKeyRef: name: myblog key: MYSQL_PASSWD ports: - containerPort: 8002 resources: requests: memory: 100Mi cpu: 50m limits: memory: 500Mi cpu: 100m livenessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒 periodSeconds: 15 # 执行探测的频率 timeoutSeconds: 2\t# 探测超时时间 readinessProbe: httpGet: path: /blog/index/ port: 8002 scheme: HTTP initialDelaySeconds: 10 timeoutSeconds: 2 periodSeconds: 15 创建Deployment $ kubectl create -f deploy.yaml 查看Deployment # kubectl api-resources $ kubectl -n demo get deploy NAME READY UP-TO-DATE AVAILABLE AGE myblog 1/1 1 1 2m22s mysql 1/1 1 1 2d11h * `NAME` 列出了集群中 Deployments 的名称。 * `READY`显示当前正在运行的副本数/期望的副本数。 * `UP-TO-DATE`显示已更新以实现期望状态的副本数。 * `AVAILABLE`显示应用程序可供用户使用的副本数。 * `AGE` 显示应用程序运行的时间量。 # 查看pod $ kubectl -n demo get po NAME READY STATUS RESTARTS AGE myblog-7c96c9f76b-qbbg7 1/1 Running 0 109s mysql-85f4f65f99-w6jkj 1/1 Running 0 2m28s 副本保障机制 controller实时检测pod状态，并保障副本数一直处于期望的值。\n## 删除pod，观察pod状态变化 $ kubectl -n demo delete pod myblog-7c96c9f76b-qbbg7 # 观察pod $ kubectl get pods -o wide ## 设置两个副本, 或者通过kubectl -n demo edit deploy myblog的方式，最好通过修改文件，然后apply的方式，这样yaml文件可以保持同步 $ kubectl -n demo scale deploy myblog --replicas=2 deployment.extensions/myblog scaled # 观察pod $ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE myblog-7c96c9f76b-qbbg7 1/1 Running 0 11m myblog-7c96c9f76b-s6brm 1/1 Running 0 55s mysql-85f4f65f99-w6jkj 1/1 Running 0 11m Pod驱逐策略 K8S 有个特色功能叫 pod eviction，它在某些场景下如节点 NotReady，或者资源不足时，把 pod 驱逐至其它节点，这也是出于业务保护的角度去考虑的。\nKube-controller-manager: 周期性检查所有节点状态，当节点处于 NotReady 状态超过一段时间后，驱逐该节点上所有 pod。停掉kubelet\npod-eviction-timeout：NotReady 状态节点超过该时间后，执行驱逐，默认 5 min Kubelet: 周期性检查本节点资源，当资源不足时，按照优先级驱逐部分 pod\nmemory.available：节点可用内存 nodefs.available：节点根盘可用存储空间 nodefs.inodesFree：节点inodes可用数量 imagefs.available：镜像存储盘的可用空间 imagefs.inodesFree：镜像存储盘的inodes可用数量 服务更新 修改dockerfile，重新打tag模拟服务更新。\n更新方式：\n修改yaml文件，使用kubectl -n demo apply -f deploy-myblog.yaml来应用更新 kubectl -n demo edit deploy myblog在线更新 kubectl set image deploy myblog myblog=172.21.32.6:5000/myblog:v2 --record 修改文件测试：\n$ vi mybolg/blog/template/index.html $ docker build . -t 172.21.32.6:5000/myblog:v2 -f Dockerfile_optimized $ docker push 172.21.32.6:5000/myblog:v2 更新策略 ... spec: replicas: 2\t#指定Pod副本数 selector:\t#指定Pod的选择器 matchLabels: app: myblog strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate\t#指定更新方式为滚动更新，默认策略，通过get deploy yaml查看 ... 策略控制：\nmaxSurge：最大激增数, 指更新过程中, 最多可以比replicas预先设定值多出的pod数量, 可以为固定值或百分比,默认为desired Pods数的25%。计算时向上取整(比如3.4，取4)，更新过程中最多会有replicas + maxSurge个pod maxUnavailable： 指更新过程中, 最多有几个pod处于无法服务状态 , 可以为固定值或百分比，默认为desired Pods数的25%。计算时向下取整(比如3.6，取3) 在Deployment rollout时，需要保证Available(Ready) Pods数不低于 desired pods number - maxUnavailable; 保证所有的非异常状态Pods数不多于 desired pods number + maxSurge。\n以myblog为例，使用默认的策略，更新过程:\nmaxSurge 25%，2个实例，向上取整，则maxSurge为1，意味着最多可以有2+1=3个Pod，那么此时会新创建1个ReplicaSet，RS-new，把副本数置为1，此时呢，副本控制器就去创建这个新的Pod 同时，maxUnavailable是25%，副本数2*25%，向下取整，则为0，意味着，滚动更新的过程中，不能有少于2个可用的Pod，因此，旧的Replica（RS-old）会先保持不动，等RS-new管理的Pod状态Ready后，此时已经有3个Ready状态的Pod了，那么由于只要保证有2个可用的Pod即可，因此，RS-old的副本数会有2个变成1个，此时，会删掉一个旧的Pod 删掉旧的Pod的时候，由于总的Pod数量又变成2个了，因此，距离最大的3个还有1个Pod可以创建，所以，RS-new把管理的副本数由1改成2，此时又会创建1个新的Pod，等RS-new管理了2个Pod都ready后，那么就可以把RS-old的副本数由1置为0了，这样就完成了滚动更新 #查看滚动更新事件 $ kubectl -n demo describe deploy myblog ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 11s deployment-controller Scaled up replica set myblog-6cf56fc848 to 1 Normal ScalingReplicaSet 11s deployment-controller Scaled down replica set myblog-6fdcf98f9 to 1 Normal ScalingReplicaSet 11s deployment-controller Scaled up replica set myblog-6cf56fc848 to 2 Normal ScalingReplicaSet 6s deployment-controller Scaled down replica set myblog-6fdcf98f9 to 0 $ kubectl get rs NAME DESIRED CURRENT READY AGE myblog-6cf56fc848 2 2 2 16h myblog-6fdcf98f9 0 0 0 16h 服务回滚 通过滚动升级的策略可以平滑的升级Deployment，若升级出现问题，需要最快且最好的方式回退到上一次能够提供正常工作的版本。为此K8S提供了回滚机制。\nrevision：更新应用时，K8S都会记录当前的版本号，即为revision，当升级出现问题时，可通过回滚到某个特定的revision，默认配置下，K8S只会保留最近的几个revision，可以通过Deployment配置文件中的spec.revisionHistoryLimit属性增加revision数量，默认是10。\n查看当前：\n$ kubectl -n demo rollout history deploy myblog ##CHANGE-CAUSE为空 $ kubectl delete -f deploy-myblog.yaml ## 方便演示到具体效果，删掉已有deployment 记录回滚：\n$ kubectl create -f deploy-myblog.yaml --record $ kubectl -n demo set image deploy myblog myblog=172.21.32.6:5000/myblog:v2 --record=true 查看deployment更新历史：\n$ kubectl -n demo rollout history deploy myblog deployment.extensions/myblog REVISION CHANGE-CAUSE 1 kubectl create --filename=deploy-myblog.yaml --record=true 2 kubectl set image deploy myblog myblog=172.21.32.6:5000/demo/myblog:v1 --record=true 回滚到具体的REVISION:\n$ kubectl -n demo rollout undo deploy myblog --to-revision=1 deployment.extensions/myblog rolled back # 访问应用测试 Kubernetes调度 录屏！！！ 为何要控制Pod应该如何调度 集群中有些机器的配置高（SSD，更好的内存等），我们希望核心的服务（比如说数据库）运行在上面 某两个服务的网络传输很频繁，我们希望它们最好在同一台机器上 …… NodeSelector label是kubernetes中一个非常重要的概念，用户可以非常灵活的利用 label 来管理集群中的资源，POD 的调度可以根据节点的 label 进行特定的部署。\n查看节点的label：\n$ kubectl get nodes --show-labels 为节点打label：\n$ kubectl label node k8s-master disktype=ssd 当 node 被打上了相关标签后，在调度的时候就可以使用这些标签了，只需要在spec 字段中添加nodeSelector字段，里面是我们需要被调度的节点的 label。\n... spec: hostNetwork: true\t# 声明pod的网络模式为host模式，效果通docker run --net=host volumes: - name: mysql-data hostPath: path: /opt/mysql/data nodeSelector: # 使用节点选择器将Pod调度到指定label的节点 component: mysql containers: - name: mysql image: 172.21.32.6:5000/demo/mysql:5.7 ... nodeAffinity 节点亲和性 ， 比上面的nodeSelector更加灵活，它可以进行一些简单的逻辑组合，不只是简单的相等匹配 。分为两种，软策略和硬策略。\npreferredDuringSchedulingIgnoredDuringExecution：软策略，如果你没有满足调度要求的节点的话，Pod就会忽略这条规则，继续完成调度过程，说白了就是满足条件最好了，没有满足就忽略掉的策略。\nrequiredDuringSchedulingIgnoredDuringExecution ： 硬策略，如果没有满足条件的节点的话，就不断重试直到满足条件为止，简单说就是你必须满足我的要求，不然我就不会调度Pod。\n#要求 Pod 不能运行在128和132两个节点上，如果有个节点满足disktype=ssd的话就优先调度到这个节点上 ... spec: containers: - name: demo image: 172.21.32.6:5000/demo/myblog ports: - containerPort: 8002 affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: NotIn values: - 192.168.136.128 - 192.168.136.132 preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: disktype operator: In values: - ssd - sas ... 这里的匹配逻辑是 label 的值在某个列表中，现在Kubernetes提供的操作符有下面的几种：\nIn：label 的值在某个列表中 NotIn：label 的值不在某个列表中 Gt：label 的值大于某个值 Lt：label 的值小于某个值 Exists：某个 label 存在 DoesNotExist：某个 label 不存在 如果nodeSelectorTerms下面有多个选项的话，满足任何一个条件就可以了；如果matchExpressions有多个选项的话，则必须同时满足这些条件才能正常调度 Pod\n污点（Taints）与容忍（tolerations） 对于nodeAffinity无论是硬策略还是软策略方式，都是调度 Pod 到预期节点上，而Taints恰好与之相反，如果一个节点标记为 Taints ，除非 Pod 也被标识为可以容忍污点节点，否则该 Taints 节点不会被调度Pod。\nTaints(污点)是Node的一个属性，设置了Taints(污点)后，因为有了污点，所以Kubernetes是不会将Pod调度到这个Node上的。于是Kubernetes就给Pod设置了个属性Tolerations(容忍)，只要Pod能够容忍Node上的污点，那么Kubernetes就会忽略Node上的污点，就能够(不是必须)把Pod调度过去。\n比如用户希望把 Master 节点保留给 Kubernetes 系统组件使用，或者把一组具有特殊资源预留给某些 Pod，则污点就很有用了，Pod 不会再被调度到 taint 标记过的节点。taint 标记节点举例如下：\n设置污点：\n$ kubectl taint node [node_name] key=value:[effect] 其中[effect] 可取值： [ NoSchedule | PreferNoSchedule | NoExecute ] NoSchedule：一定不能被调度。 PreferNoSchedule：尽量不要调度。 NoExecute：不仅不会调度，还会驱逐Node上已有的Pod。 示例：kubectl taint node k8s-master smoke=true:NoSchedule 去除污点：\n去除指定key及其effect： kubectl taint nodes [node_name] key:[effect]- #这里的key不用指定value 去除指定key所有的effect: kubectl taint nodes node_name key- 示例： kubectl taint node k8s-master smoke=true:NoSchedule kubectl taint node k8s-master smoke:NoExecute- kubectl taint node k8s-master smoke- 污点演示：\n## 给k8s-slave1打上污点，smoke=true:NoSchedule $ kubectl taint node k8s-slave1 smoke=true:NoSchedule $ kubectl taint node k8s-slave2 drunk=true:NoSchedule ## 扩容myblog的Pod，观察新Pod的调度情况 $ kuebctl -n demo scale deploy myblog --replicas=3 $ kubectl -n demo get po -w ## pending Pod容忍污点示例：myblog/deployment/deploy-myblog-taint.yaml\n... spec: containers: - name: demo image: 172.21.32.6:5000/demo/myblog tolerations: #设置容忍性 - key: \"smoke\" operator: \"Equal\" #如果操作符为Exists，那么value属性可省略,不指定operator，默认为Equal value: \"true\" effect: \"NoSchedule\" - key: \"drunk\" operator: \"Equal\" #如果操作符为Exists，那么value属性可省略,不指定operator，默认为Equal value: \"true\" effect: \"NoSchedule\" #意思是这个Pod要容忍的有污点的Node的key是smoke Equal true,效果是NoSchedule， #tolerations属性下各值必须使用引号，容忍的值都是设置Node的taints时给的值。 $ kubectl apply -f deploy-myblog-taint.yaml spec: containers: - name: demo image: 172.21.32.6:5000/demo/myblog tolerations: - operator: \"Exists\" Kubernetes服务访问之Service 录屏！！！ 通过以前的学习，我们已经能够通过Deployment来创建一组Pod来提供具有高可用性的服务。虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两个问题：\nPod IP仅仅是集群内可见的虚拟IP，外部无法访问。 Pod IP会随着Pod的销毁而消失，当ReplicaSet对Pod进行动态伸缩时，Pod IP可能随时随地都会变化，这样对于我们访问这个服务带来了难度。 Service 负载均衡之Cluster IP service是一组pod的服务抽象，相当于一组pod的LB，负责将请求分发给对应的pod。service会为这个LB提供一个IP，一般称为cluster IP 。使用Service对象，通过selector进行标签选择，找到对应的Pod:\nmyblog/deployment/svc-myblog.yaml\napiVersion: v1 kind: Service metadata: name: myblog namespace: demo spec: ports: - port: 80 protocol: TCP targetPort: 8002 selector: app: myblog type: ClusterIP 操作演示：\n## 别名 $ alias kd='kubectl -n demo' ## 创建服务 $ kd create -f svc-myblog.yaml $ kd get po --show-labels NAME READY STATUS RESTARTS AGE LABELS myblog-5c97d79cdb-jn7km 1/1 Running 0 6m5s app=myblog mysql-85f4f65f99-w6jkj 1/1 Running 0 176m app=mysql $ kd get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93 \u003cnone\u003e 80/TCP 7m50s $ kd describe svc myblog Name: myblog Namespace: demo Labels: \u003cnone\u003e Annotations: \u003cnone\u003e Selector: app=myblog Type: ClusterIP IP: 10.99.174.93 Port: \u003cunset\u003e 80/TCP TargetPort: 8002/TCP Endpoints: 10.244.0.68:8002 Session Affinity: None Events: \u003cnone\u003e ## 扩容myblog服务 $ kd scale deploy myblog --replicas=2 deployment.extensions/myblog scaled ## 再次查看 $ kd describe svc myblog Name: myblog Namespace: demo Labels: \u003cnone\u003e Annotations: \u003cnone\u003e Selector: app=myblog Type: ClusterIP IP: 10.99.174.93 Port: \u003cunset\u003e 80/TCP TargetPort: 8002/TCP Endpoints: 10.244.0.68:8002,10.244.1.158:8002 Session Affinity: None Events: \u003cnone\u003e Service与Pod如何关联:\nservice对象创建的同时，会创建同名的endpoints对象，若服务设置了readinessProbe, 当readinessProbe检测失败时，endpoints列表中会剔除掉对应的pod_ip，这样流量就不会分发到健康检测失败的Pod中\n$ kd get endpoints myblog NAME ENDPOINTS AGE myblog 10.244.0.68:8002,10.244.1.158:8002 7m Service Cluster-IP如何访问:\n$ kd get svc myblog NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93 \u003cnone\u003e 80/TCP 13m $ curl 10.99.174.93/blog/index/ 为mysql服务创建service：\napiVersion: v1 kind: Service metadata: name: mysql namespace: demo spec: ports: - port: 3306 protocol: TCP targetPort: 3306 selector: app: mysql type: ClusterIP 访问mysql：\n$ kd get svc mysql mysql ClusterIP 10.108.214.84 \u003cnone\u003e 3306/TCP 3s $ curl 10.108.214.84:3306 目前使用hostNetwork部署，通过宿主机ip+port访问，弊端：\n服务使用hostNetwork，使得宿主机的端口大量暴漏，存在安全隐患 容易引发端口冲突 服务均属于k8s集群，尽可能使用k8s的网络访问，因此可以对目前myblog访问mysql的方式做改造：\n为mysql创建一个固定clusterIp的Service，把clusterIp配置在myblog的环境变量中 利用集群服务发现的能力，组件之间通过service name来访问 服务发现 在k8s集群中，组件之间可以通过定义的Service名称实现通信。\n演示服务发现：\n## 演示思路：在myblog的容器中直接通过service名称访问服务，观察是否可以访问通 # 先查看服务 $ kd get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93 \u003cnone\u003e 80/TCP 59m mysql ClusterIP 10.108.214.84 \u003cnone\u003e 3306/TCP 35m # 进入myblog容器 $ kd exec -ti myblog-5c97d79cdb-j485f bash [root@myblog-5c97d79cdb-j485f myblog]# curl mysql:3306 5.7.29 )→ (mysql_native_password ot packets out of order [root@myblog-5c97d79cdb-j485f myblog]# curl myblog/blog/index/ 我的博客列表 虽然podip和clusterip都不固定，但是service name是固定的，而且具有完全的跨集群可移植性，因此组件之间调用的同时，完全可以通过service name去通信，这样避免了大量的ip维护成本，使得服务的yaml模板更加简单。因此可以对mysql和myblog的部署进行优化改造：\nmysql可以去掉hostNetwork部署，使得服务只暴漏在k8s集群内部网络 configMap中数据库地址可以换成Service名称，这样跨环境的时候，配置内容基本上可以保持不用变化 修改deploy-mysql.yaml\nspec: hostNetwork: true\t# 去掉此行 volumes: - name: mysql-data hostPath: path: /opt/mysql/data 修改configmap.yaml\napiVersion: v1 kind: ConfigMap metadata: name: myblog namespace: demo data: MYSQL_HOST: \"mysql\"\t# 此处替换为mysql MYSQL_PORT: \"3306\" 应用修改：\n$ kubectl apply -f configmap.yaml $ kubectl apply -f deploy-mysql.yaml ## 重建pod $ kubectl -n demo delete po mysql-7f747644b8-6npzn #去掉taint $ kubectl taint node k8s-slave1 smoke- $ kubectl taint node k8s-slave2 drunk- ## myblog不用动，会自动因健康检测不过而重启 服务发现实现：\nCoreDNS是一个Go语言实现的链式插件DNS服务端，是CNCF成员，是一个高性能、易扩展的DNS服务端。\n$ kubectl -n kube-system get po -o wide|grep dns coredns-d4475785-2w4hk 1/1 Running 0 4d22h 10.244.0.64 coredns-d4475785-s49hq 1/1 Running 0 4d22h 10.244.0.65 # 查看myblog的pod解析配置 $ kubectl -n demo exec -ti myblog-5c97d79cdb-j485f bash [root@myblog-5c97d79cdb-j485f myblog]# cat /etc/resolv.conf nameserver 10.96.0.10 search demo.svc.cluster.local svc.cluster.local cluster.local options ndots:5 ## 10.96.0.10 从哪来 $ kubectl -n kube-system get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.96.0.10 \u003cnone\u003e 53/UDP,53/TCP 51d ## 启动pod的时候，会把kube-dns服务的cluster-ip地址注入到pod的resolve解析配置中，同时添加对应的namespace的search域。 因此跨namespace通过service name访问的话，需要添加对应的namespace名称， service_name.namespace_name $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 \u003cnone\u003e 443/TCP 26h Service负载均衡之NodePort cluster-ip为虚拟地址，只能在k8s集群内部进行访问，集群外部如果访问内部服务，实现方式之一为使用NodePort方式。NodePort会默认在 30000-32767 ，不指定的会随机使用其中一个。\nmyblog/deployment/svc-myblog-nodeport.yaml\napiVersion: v1 kind: Service metadata: name: myblog-np namespace: demo spec: ports: - port: 80 protocol: TCP targetPort: 8002 selector: app: myblog type: NodePort 查看并访问服务：\n$ kd create -f svc-myblog-nodeport.yaml service/myblog-np created $ kd get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93 \u003cnone\u003e 80/TCP 102m myblog-np NodePort 10.105.228.101 \u003cnone\u003e 80:30647/TCP 4s mysql ClusterIP 10.108.214.84 \u003cnone\u003e 3306/TCP 77m #集群内每个节点的NodePort端口都会进行监听 $ curl 192.168.136.128:30647/blog/index/ 我的博客列表 $ curl 192.168.136.131:30647/blog/index/ 我的博客列表 ## 浏览器访问 思考：\nNodePort的端口监听如何转发到对应的Pod服务？\nCLUSTER-IP为虚拟IP，集群内如何通过虚拟IP访问到具体的Pod服务？\nkube-proxy 运行在每个节点上，监听 API Server 中服务对象的变化，再通过创建流量路由规则来实现网络的转发。参照\n有三种模式：\nUser space, 让 Kube-Proxy 在用户空间监听一个端口，所有的 Service 都转发到这个端口，然后 Kube-Proxy 在内部应用层对其进行转发 ， 所有报文都走一遍用户态，性能不高，k8s v1.2版本后废弃。 Iptables， 当前默认模式，完全由 IPtables 来实现， 通过各个node节点上的iptables规则来实现service的负载均衡，但是随着service数量的增大，iptables模式由于线性查找匹配、全量更新等特点，其性能会显著下降。 IPVS， 与iptables同样基于Netfilter，但是采用的hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。 k8s 1.8版本开始引入，1.11版本开始稳定，需要开启宿主机的ipvs模块。 IPtables模式示意图：\n$ iptables-save |grep -v myblog-np|grep \"demo/myblog\" -A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.99.174.93/32 -p tcp -m comment --comment \"demo/myblog: cluster IP\" -m tcp --dport 80 -j KUBE-MARK-MASQ -A KUBE-SERVICES -d 10.99.174.93/32 -p tcp -m comment --comment \"demo/myblog: cluster IP\" -m tcp --dport 80 -j KUBE-SVC-WQNGJ7YFZKCTKPZK $ iptables-save |grep KUBE-SVC-WQNGJ7YFZKCTKPZK -A KUBE-SVC-WQNGJ7YFZKCTKPZK -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-GB5GNOM5CZH7ICXZ -A KUBE-SVC-WQNGJ7YFZKCTKPZK -j KUBE-SEP-7GWC3FN2JI5KLE47 $ iptables-save |grep KUBE-SEP-GB5GNOM5CZH7ICXZ -A KUBE-SEP-GB5GNOM5CZH7ICXZ -p tcp -m tcp -j DNAT --to-destination 10.244.1.158:8002 $ iptables-save |grep KUBE-SEP-7GWC3FN2JI5KLE47 -A KUBE-SEP-7GWC3FN2JI5KLE47 -p tcp -m tcp -j DNAT --to-destination 10.244.1.159:8002 Kubernetes服务访问之Ingress 对于Kubernetes的Service，无论是Cluster-Ip和NodePort均是四层的负载，集群内的服务如何实现七层的负载均衡，这就需要借助于Ingress，Ingress控制器的实现方式有很多，比如nginx, Contour, Haproxy, trafik, Istio，我们以nginx的实现为例做演示。\nIngress-nginx是7层的负载均衡器 ，负责统一管理外部对k8s cluster中service的请求。主要包含：\ningress-nginx-controller：根据用户编写的ingress规则（创建的ingress的yaml文件），动态的去更改nginx服务的配置文件，并且reload重载使其生效（是自动化的，通过lua脚本来实现）； ingress资源对象：将Nginx的配置抽象成一个Ingress对象，每添加一个新的Service资源对象只需写一个新的Ingress规则的yaml文件即可（或修改已存在的ingress规则的yaml文件） 示意图： 实现逻辑 1）ingress controller通过和kubernetes api交互，动态的去感知集群中ingress规则变化 2）然后读取ingress规则(规则就是写明了哪个域名对应哪个service)，按照自定义的规则，生成一段nginx配置 3）再写到nginx-ingress-controller的pod里，这个Ingress controller的pod里运行着一个Nginx服务，控制器把生成的nginx配置写入/etc/nginx.conf文件中 4）然后reload一下使配置生效。以此达到域名分别配置和动态更新的问题。\n安装 官方文档\n$ wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml ## 或者使用myblog/deployment/ingress/mandatory.yaml ## 修改部署节点 $ grep -n5 nodeSelector mandatory.yaml 212- spec: 213- hostNetwork: true #添加为host模式 214- # wait up to five minutes for the drain of connections 215- terminationGracePeriodSeconds: 300 216- serviceAccountName: nginx-ingress-serviceaccount 217: nodeSelector: 218- ingress: \"true\"\t#替换此处，来决定将ingress部署在哪些机器 219- containers: 220- - name: nginx-ingress-controller 221- image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0 222- args: 使用示例：myblog/deployment/ingress.yaml\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: myblog namespace: demo spec: rules: - host: myblog.devops.cn http: paths: - path: / backend: serviceName: myblog servicePort: 80 ingress-nginx动态生成upstream配置：\n... server_name myblog.devops.cn ; listen 80 ; listen [::]:80 ; listen 443 ssl http2 ; listen [::]:443 ssl http2 ; set $proxy_upstream_name \"-\"; ssl_certificate_by_lua_block { certificate.call() } location / { set $namespace \"demo\"; set $ingress_name \"myblog\"; ... 访问 域名解析服务，将 myblog.devops.cn解析到ingress的地址上。ingress是支持多副本的，高可用的情况下，生产的配置是使用lb服务（内网F5设备，公网elb、slb、clb，解析到各ingress的机器，如何域名指向lb地址）\n本机，添加如下hosts记录来演示效果。\n192.168.136.128 myblog.devops.cn 然后，访问 http://myblog.devops.cn/blog/index/\nHTTPS访问：\n#自签名证书 $ openssl req -x509 -nodes -days 2920 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=*.devops.cn/O=ingress-nginx\" # 证书信息保存到secret对象中，ingress-nginx会读取secret对象解析出证书加载到nginx配置中 $ kubectl -n demo create secret tls https-secret --key tls.key --cert tls.crt secret/https-secret created 修改yaml\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: myblog-tls namespace: demo spec: rules: - host: myblog.devops.cn http: paths: - path: / backend: serviceName: myblog servicePort: 80 tls: - hosts: - myblog.devops.cn secretName: https-secret 然后，访问 https://myblog.devops.cn/blog/index/\nKubernetes认证与授权 录屏！！！ APIService安全控制 Authentication：身份认证\n这个环节它面对的输入是整个http request，负责对来自client的请求进行身份校验，支持的方法包括: client证书验证（https双向验证）\nbasic auth\n普通token\njwt token(用于serviceaccount)\nAPIServer启动时，可以指定一种Authentication方法，也可以指定多种方法。如果指定了多种方法，那么APIServer将会逐个使用这些方法对客户端请求进行验证， 只要请求数据通过其中一种方法的验证，APIServer就会认为Authentication成功；\n使用kubeadm引导启动的k8s集群的apiserver初始配置中，默认支持client证书验证和serviceaccount两种身份验证方式。 证书认证通过设置--client-ca-file根证书以及--tls-cert-file和--tls-private-key-file来开启。\n在这个环节，apiserver会通过client证书或 http header中的字段(比如serviceaccount的jwt token)来识别出请求的用户身份，包括”user”、”group”等，这些信息将在后面的authorization环节用到。\nAuthorization：鉴权，你可以访问哪些资源\n这个环节面对的输入是http request context中的各种属性，包括：user、group、request path（比如：/api/v1、/healthz、/version等）、 request verb(比如：get、list、create等)。\nAPIServer会将这些属性值与事先配置好的访问策略(access policy）相比较。APIServer支持多种authorization mode，包括Node、RBAC、Webhook等。\nAPIServer启动时，可以指定一种authorization mode，也可以指定多种authorization mode，如果是后者，只要Request通过了其中一种mode的授权， 那么该环节的最终结果就是授权成功。在较新版本kubeadm引导启动的k8s集群的apiserver初始配置中，authorization-mode的默认配置是”Node,RBAC”。\nAdmission Control：准入控制，一个控制链(层层关卡)，偏集群安全控制、管理方面。为什么说是安全相关的机制？\n以NamespaceLifecycle为例， 该插件确保处于Termination状态的Namespace不再接收新的对象创建请求，并拒绝请求不存在的Namespace。该插件还可以防止删除系统保留的Namespace:default，kube-system，kube-public。 NodeRestriction， 此插件限制kubelet修改Node和Pod对象，这样的kubelets只允许修改绑定到Node的Pod API对象，以后版本可能会增加额外的限制 。 为什么我们执行命令kubectl命令，可以直接管理k8s集群资源？\nkubectl的认证授权 kubectl的日志调试级别：\n信息 描述 v=0 通常，这对操作者来说总是可见的。 v=1 当您不想要很详细的输出时，这个是一个合理的默认日志级别。 v=2 有关服务和重要日志消息的有用稳定状态信息，这些信息可能与系统中的重大更改相关。这是大多数系统推荐的默认日志级别。 v=3 关于更改的扩展信息。 v=4 调试级别信息。 v=6 显示请求资源。 v=7 显示 HTTP 请求头。 v=8 显示 HTTP 请求内容。 v=9 显示 HTTP 请求内容，并且不截断内容。 $ kubectl get nodes -v=7 I0329 20:20:08.633065 3979 loader.go:359] Config loaded from file /root/.kube/config I0329 20:20:08.633797 3979 round_trippers.go:416] GET https://192.168.136.128:6443/api/v1/nodes?limit=500 kubeadm init启动完master节点后，会默认输出类似下面的提示内容：\n... ... Your Kubernetes master has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config ... ... 这些信息是在告知我们如何配置kubeconfig文件。按照上述命令配置后，master节点上的kubectl就可以直接使用$HOME/.kube/config的信息访问k8s cluster了。 并且，通过这种配置方式，kubectl也拥有了整个集群的管理员(root)权限。\n很多K8s初学者在这里都会有疑问：\n当kubectl使用这种kubeconfig方式访问集群时，Kubernetes的kube-apiserver是如何对来自kubectl的访问进行身份验证(authentication)和授权(authorization)的呢？ 为什么来自kubectl的请求拥有最高的管理员权限呢？ 查看/root/.kube/config文件：\n前面提到过apiserver的authentication支持通过tls client certificate、basic auth、token等方式对客户端发起的请求进行身份校验， 从kubeconfig信息来看，kubectl显然在请求中使用了tls client certificate的方式，即客户端的证书。\n证书base64解码：\n$ echo xxxxxxxxxxxxxx |base64 -d \u003e kubectl.crt 说明在认证阶段，apiserver会首先使用--client-ca-file配置的CA证书去验证kubectl提供的证书的有效性,基本的方式 ：\n$ openssl verify -CAfile /etc/kubernetes/pki/ca.crt kubectl.crt kubectl.crt: OK 除了认证身份，还会取出必要的信息供授权阶段使用，文本形式查看证书内容：\n$ openssl x509 -in kubectl.crt -text Certificate: Data: Version: 3 (0x2) Serial Number: 4736260165981664452 (0x41ba9386f52b74c4) Signature Algorithm: sha256WithRSAEncryption Issuer: CN=kubernetes Validity Not Before: Feb 10 07:33:39 2020 GMT Not After : Feb 9 07:33:40 2021 GMT Subject: O=system:masters, CN=kubernetes-admin ... 认证通过后，提取出签发证书时指定的CN(Common Name),kubernetes-admin，作为请求的用户名 (User Name), 从证书中提取O(Organization)字段作为请求用户所属的组 (Group)，group = system:masters，然后传递给后面的授权模块。\nkubeadm在init初始引导集群启动过程中，创建了许多default的role、clusterrole、rolebinding和clusterrolebinding， 在k8s有关RBAC的官方文档中，我们看到下面一些default clusterrole列表:\n其中第一个cluster-admin这个cluster role binding绑定了system:masters group，这和authentication环节传递过来的身份信息不谋而合。 沿着system:masters group对应的cluster-admin clusterrolebinding“追查”下去，真相就会浮出水面。\n我们查看一下这一binding：\n$ kubectl describe clusterrolebinding cluster-admin Name: cluster-admin Labels: kubernetes.io/bootstrapping=rbac-defaults Annotations: rbac.authorization.kubernetes.io/autoupdate: true Role: Kind: ClusterRole Name: cluster-admin Subjects: Kind Name Namespace ---- ---- --------- Group system:masters 我们看到在kube-system名字空间中，一个名为cluster-admin的clusterrolebinding将cluster-admin cluster role与system:masters Group绑定到了一起， 赋予了所有归属于system:masters Group中用户cluster-admin角色所拥有的权限。\n我们再来查看一下cluster-admin这个role的具体权限信息：\n$ kubectl describe clusterrole cluster-admin Name: cluster-admin Labels: kubernetes.io/bootstrapping=rbac-defaults Annotations: rbac.authorization.kubernetes.io/autoupdate: true PolicyRule: Resources Non-Resource URLs Resource Names Verbs --------- ----------------- -------------- ----- *.* [] [] [*] [*] [] [*] 非资源类，如查看集群健康状态。\nRBAC Role-Based Access Control，基于角色的访问控制， apiserver启动参数添加–authorization-mode=RBAC 来启用RBAC认证模式，kubeadm安装的集群默认已开启。官方介绍\n查看开启：\n# master节点查看apiserver进程 $ ps aux |grep apiserver RBAC模式引入了4个资源：\nRole，角色\n一个Role只能授权访问单个namespace\n## 示例定义一个名为pod-reader的角色，该角色具有读取default这个命名空间下的pods的权限 kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: default name: pod-reader rules: - apiGroups: [\"\"] # \"\" indicates the core API group resources: [\"pods\"] verbs: [\"get\", \"watch\", \"list\"] ## apiGroups: \"\",\"apps\", \"autoscaling\", \"batch\", kubectl api-versions ## resources: \"services\", \"pods\",\"deployments\"... kubectl api-resources ## verbs: \"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\", \"exec\" ClusterRole\n一个ClusterRole能够授予和Role一样的权限，但是它是集群范围内的。\n## 定义一个集群角色，名为secret-reader，该角色可以读取所有的namespace中的secret资源 kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: # \"namespace\" omitted since ClusterRoles are not namespaced name: secret-reader rules: - apiGroups: [\"\"] resources: [\"secrets\"] verbs: [\"get\", \"watch\", \"list\"] Rolebinding\n将role中定义的权限分配给用户和用户组。RoleBinding包含主题（users,groups,或service accounts）和授予角色的引用。对于namespace内的授权使用RoleBinding，集群范围内使用ClusterRoleBinding。\n## 定义一个角色绑定，将pod-reader这个role的权限授予给jane这个User，使得jane可以在读取default这个命名空间下的所有的pod数据 kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: read-pods namespace: default subjects: - kind: User #这里可以是User,Group,ServiceAccount name: jane apiGroup: rbac.authorization.k8s.io roleRef: kind: Role #这里可以是Role或者ClusterRole,若是ClusterRole，则权限也仅限于rolebinding的内部 name: pod-reader # match the name of the Role or ClusterRole you wish to bind to apiGroup: rbac.authorization.k8s.io 注意：rolebinding既可以绑定role，也可以绑定clusterrole，当绑定clusterrole的时候，subject的权限也会被限定于rolebinding定义的namespace内部，若想跨namespace，需要使用clusterrolebinding\n## 定义一个角色绑定，将dave这个用户和secret-reader这个集群角色绑定，虽然secret-reader是集群角色，但是因为是使用rolebinding绑定的，因此dave的权限也会被限制在development这个命名空间内 apiVersion: rbac.authorization.k8s.io/v1 # This role binding allows \"dave\" to read secrets in the \"development\" namespace. # You need to already have a ClusterRole named \"secret-reader\". kind: RoleBinding metadata: name: read-secrets # # The namespace of the RoleBinding determines where the permissions are granted. # This only grants permissions within the \"development\" namespace. namespace: development subjects: - kind: User name: dave # Name is case sensitive apiGroup: rbac.authorization.k8s.io - kind: ServiceAccount name: dave # Name is case sensitive namespace: demo roleRef: kind: ClusterRole name: secret-reader apiGroup: rbac.authorization.k8s.io 考虑一个场景： 如果集群中有多个namespace分配给不同的管理员，每个namespace的权限是一样的，就可以只定义一个clusterrole，然后通过rolebinding将不同的namespace绑定到管理员身上，否则就需要每个namespace定义一个Role，然后做一次rolebinding。\nClusterRolebingding\n允许跨namespace进行授权\napiVersion: rbac.authorization.k8s.io/v1 # This cluster role binding allows anyone in the \"manager\" group to read secrets in any namespace. kind: ClusterRoleBinding metadata: name: read-secrets-global subjects: - kind: Group name: manager # Name is case sensitive apiGroup: rbac.authorization.k8s.io roleRef: kind: ClusterRole name: secret-reader apiGroup: rbac.authorization.k8s.io kubelet的认证授权 查看kubelet进程\n$ systemctl status kubelet ● kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled) Drop-In: /etc/systemd/system/kubelet.service.d └─10-kubeadm.conf Active: active (running) since Wed 2020-04-01 02:34:13 CST; 1 day 14h ago Docs: https://kubernetes.io/docs/ Main PID: 851 (kubelet) Tasks: 21 Memory: 127.1M CGroup: /system.slice/kubelet.service └─851 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf 查看/etc/kubernetes/kubelet.conf，解析证书：\n$ echo xxxxx |base64 -d \u003ekubelet.crt $ openssl x509 -in kubelet.crt -text Certificate: Data: Version: 3 (0x2) Serial Number: 9059794385454520113 (0x7dbadafe23185731) Signature Algorithm: sha256WithRSAEncryption Issuer: CN=kubernetes Validity Not Before: Feb 10 07:33:39 2020 GMT Not After : Feb 9 07:33:40 2021 GMT Subject: O=system:nodes, CN=system:node:master-1 得到我们期望的内容：\nSubject: O=system:nodes, CN=system:node:k8s-master 我们知道，k8s会把O作为Group来进行请求，因此如果有权限绑定给这个组，肯定在clusterrolebinding的定义中可以找得到。因此尝试去找一下绑定了system:nodes组的clusterrolebinding\n$ kubectl get clusterrolebinding|awk 'NR\u003e1{print $1}'|xargs kubectl get clusterrolebinding -oyaml|grep -n10 system:nodes 98- roleRef: 99- apiGroup: rbac.authorization.k8s.io 100- kind: ClusterRole 101- name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient 102- subjects: 103- - apiGroup: rbac.authorization.k8s.io 104- kind: Group 105: name: system:nodes 106-- apiVersion: rbac.authorization.k8s.io/v1 107- kind: ClusterRoleBinding 108- metadata: 109- creationTimestamp: \"2020-02-10T07:34:02Z\" 110- name: kubeadm:node-proxier 111- resourceVersion: \"213\" 112- selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/kubeadm%3Anode-proxier $ kubectl describe clusterrole system:certificates.k8s.io:certificatesigningrequests:selfnodeclient Name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient Labels: kubernetes.io/bootstrapping=rbac-defaults Annotations: rbac.authorization.kubernetes.io/autoupdate: true PolicyRule: Resources Non-Resource URLs Resource Names Verbs --------- ----------------- -------------- ----- certificatesigningrequests.certificates.k8s.io/selfnodeclient [] [] [create] 结局有点意外，除了system:certificates.k8s.io:certificatesigningrequests:selfnodeclient外，没有找到system相关的rolebindings，显然和我们的理解不一样。 尝试去找资料，发现了这么一段 :\nDefault ClusterRole Default ClusterRoleBinding Description system:kube-scheduler system:kube-scheduler user Allows access to the resources required by the schedulercomponent. system:volume-scheduler system:kube-scheduler user Allows access to the volume resources required by the kube-scheduler component. system:kube-controller-manager system:kube-controller-manager user Allows access to the resources required by the controller manager component. The permissions required by individual controllers are detailed in the controller roles. system:node None Allows access to resources required by the kubelet, including read access to all secrets, and write access to all pod status objects. You should use the Node authorizer and NodeRestriction admission plugin instead of the system:node role, and allow granting API access to kubelets based on the Pods scheduled to run on them. The system:node role only exists for compatibility with Kubernetes clusters upgraded from versions prior to v1.8. system:node-proxier system:kube-proxy user Allows access to the resources required by the kube-proxycomponent. 大致意思是说：之前会定义system:node这个角色，目的是为了kubelet可以访问到必要的资源，包括所有secret的读权限及更新pod状态的写权限。如果1.8版本后，是建议使用 Node authorizer and NodeRestriction admission plugin 来代替这个角色的。\n我们目前使用1.16，查看一下授权策略：\n$ ps axu|grep apiserver kube-apiserver --authorization-mode=Node,RBAC --enable-admission-plugins=NodeRestriction 查看一下官网对Node authorizer的介绍：\nNode authorization is a special-purpose authorization mode that specifically authorizes API requests made by kubelets.\nIn future releases, the node authorizer may add or remove permissions to ensure kubelets have the minimal set of permissions required to operate correctly.\nIn order to be authorized by the Node authorizer, kubelets must use a credential that identifies them as being in the system:nodes group, with a username of system:node:\nService Account 前面说，认证可以通过证书，也可以通过使用ServiceAccount（服务账户）的方式来做认证。大多数时候，我们在基于k8s做二次开发时都是选择通过serviceaccount的方式。我们之前访问dashboard的时候，是如何做的？\n## 新建一个名为admin的serviceaccount，并且把名为cluster-admin的这个集群角色的权限授予新建的serviceaccount apiVersion: v1 kind: ServiceAccount metadata: name: admin namespace: kubernetes-dashboard --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: admin annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" roleRef: kind: ClusterRole name: cluster-admin apiGroup: rbac.authorization.k8s.io subjects: - kind: ServiceAccount name: admin namespace: kubernetes-dashboard 我们查看一下：\n$ kubectl -n kubernetes-dashboard get sa admin -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2020-04-01T11:59:21Z\" name: admin namespace: kubernetes-dashboard resourceVersion: \"1988878\" selfLink: /api/v1/namespaces/kubernetes-dashboard/serviceaccounts/admin uid: 639ecc3e-74d9-11ea-a59b-000c29dfd73f secrets: - name: admin-token-lfsrf 注意到serviceaccount上默认绑定了一个名为admin-token-lfsrf的secret，我们查看一下secret\n$ kubectl -n kubernetes-dashboard describe secret admin-token-lfsrf Name: admin-token-lfsrf Namespace: kubernetes-dashboard Labels: \u003cnone\u003e Annotations: kubernetes.io/service-account.name: admin kubernetes.io/service-account.uid: 639ecc3e-74d9-11ea-a59b-000c29dfd73f Type: kubernetes.io/service-account-token Data ==== ca.crt: 1025 bytes namespace: 4 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZW1vIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFkbWluLXRva2VuLWxmc3JmIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNjM5ZWNjM2UtNzRkOS0xMWVhLWE1OWItMDAwYzI5ZGZkNzNmIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlbW86YWRtaW4ifQ.ffGCU4L5LxTsMx3NcNixpjT6nLBi-pmstb4I-W61nLOzNaMmYSEIwAaugKMzNR-2VwM14WbuG04dOeO67niJeP6n8-ALkl-vineoYCsUjrzJ09qpM3TNUPatHFqyjcqJ87h4VKZEqk2qCCmLxB6AGbEHpVFkoge40vHs56cIymFGZLe53JZkhu3pwYuS4jpXytV30Ad-HwmQDUu_Xqcifni6tDYPCfKz2CZlcOfwqHeGIHJjDGVBKqhEeo8PhStoofBU6Y4OjObP7HGuTY-Foo4QindNnpp0QU6vSb7kiOiQ4twpayybH8PTf73dtdFt46UF6mGjskWgevgolvmO8A 开发的时候如何去调用k8s的api:\ncurl演示 $ curl -k -H \"Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZW1vIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFkbWluLXRva2VuLWxmc3JmIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNjM5ZWNjM2UtNzRkOS0xMWVhLWE1OWItMDAwYzI5ZGZkNzNmIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlbW86YWRtaW4ifQ.ffGCU4L5LxTsMx3NcNixpjT6nLBi-pmstb4I-W61nLOzNaMmYSEIwAaugKMzNR-2VwM14WbuG04dOeO67niJeP6n8-ALkl-vineoYCsUjrzJ09qpM3TNUPatHFqyjcqJ87h4VKZEqk2qCCmLxB6AGbEHpVFkoge40vHs56cIymFGZLe53JZkhu3pwYuS4jpXytV30Ad-HwmQDUu_Xqcifni6tDYPCfKz2CZlcOfwqHeGIHJjDGVBKqhEeo8PhStoofBU6Y4OjObP7HGuTY-Foo4QindNnpp0QU6vSb7kiOiQ4twpayybH8PTf73dtdFt46UF6mGjskWgevgolvmO8A\" https://62.234.214.206:6443/api/v1/namespaces/demo/pods?limit=500 postman 查看etcd数据 拷贝etcdctl命令行工具：\n$ docker exec -ti etcd_container which etcdctl $ docker cp etcd_container:/usr/local/bin/etcdctl /usr/bin/etcdctl 查看所有key值：\n$ ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get / --prefix --keys-only 查看具体的key对应的数据：\n$ ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get /registry/pods/jenkins/sonar-postgres-7fc5d748b6-gtmsb 基于EFK实现kubernetes集群的日志平台（扩展） 录屏！！！ EFK介绍 EFK工作示意\nElasticsearch\n一个开源的分布式、Restful 风格的搜索和数据分析引擎，它的底层是开源库Apache Lucene。它可以被下面这样准确地形容：\n一个分布式的实时文档存储，每个字段可以被索引与搜索； 一个分布式实时分析搜索引擎； 能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据。 Fluentd\n一个针对日志的收集、处理、转发系统。通过丰富的插件系统，可以收集来自于各种系统或应用的日志，转化为用户指定的格式后，转发到用户所指定的日志存储系统之中。\nFluentd 通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如 Elasticsearch、对象存储、kafka等等。Fluentd 支持超过300个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下\n首先 Fluentd 从多个日志源获取数据 结构化并且标记这些数据 然后根据匹配的标签将数据发送到多个目标服务 Kibana\nKibana是一个开源的分析和可视化平台，设计用于和Elasticsearch一起工作。可以通过Kibana来搜索，查看，并和存储在Elasticsearch索引中的数据进行交互。也可以轻松地执行高级数据分析，并且以各种图标、表格和地图的形式可视化数据。\n部署es服务 部署分析 es生产环境是部署es集群，通常会使用statefulset进行部署，此例由于演示环境资源问题，部署为单点 数据存储挂载主机路径 es默认使用elasticsearch用户启动进程，es的数据目录是通过宿主机的路径挂载，因此目录权限被主机的目录权限覆盖，因此可以利用init container容器在es进程启动之前把目录的权限修改掉，注意init container要用特权模式启动。 部署并验证 efk/elasticsearch.yaml\napiVersion: apps/v1 kind: StatefulSet metadata: labels: addonmanager.kubernetes.io/mode: Reconcile k8s-app: elasticsearch-logging version: v7.4.2 name: elasticsearch-logging namespace: logging spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: k8s-app: elasticsearch-logging version: v7.4.2 serviceName: elasticsearch-logging template: metadata: labels: k8s-app: elasticsearch-logging version: v7.4.2 spec: nodeSelector: log: \"true\"\t## 指定部署在哪个节点。需根据环境来修改 containers: - env: - name: NAMESPACE valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.namespace - name: cluster.initial_master_nodes value: elasticsearch-logging-0 - name: ES_JAVA_OPTS value: \"-Xms512m -Xmx512m\" image: 172.21.32.6:5000/elasticsearch/elasticsearch:7.4.2 name: elasticsearch-logging ports: - containerPort: 9200 name: db protocol: TCP - containerPort: 9300 name: transport protocol: TCP volumeMounts: - mountPath: /usr/share/elasticsearch/data name: elasticsearch-logging dnsConfig: options: - name: single-request-reopen initContainers: - command: - /sbin/sysctl - -w - vm.max_map_count=262144 image: alpine:3.6 imagePullPolicy: IfNotPresent name: elasticsearch-logging-init resources: {} securityContext: privileged: true - name: fix-permissions image: alpine:3.6 command: [\"sh\", \"-c\", \"chown -R 1000:1000 /usr/share/elasticsearch/data\"] securityContext: privileged: true volumeMounts: - name: elasticsearch-logging mountPath: /usr/share/elasticsearch/data volumes: - name: elasticsearch-logging hostPath: path: /esdata --- apiVersion: v1 kind: Service metadata: labels: k8s-app: elasticsearch-logging name: elasticsearch namespace: logging spec: ports: - port: 9200 protocol: TCP targetPort: db selector: k8s-app: elasticsearch-logging type: ClusterIP $ kubectl create namespace logging ## 给slave1节点打上label，将es服务调度到slave1节点 $ kubectl label node k8s-slave1 log=true ## 部署服务，可以先去部署es的节点把镜像下载到本地 $ kubectl create -f elasticsearch.yaml statefulset.apps/elasticsearch-logging created service/elasticsearch created ## 等待片刻，查看一下es的pod部署到了k8s-slave1节点，状态变为running $ kubectl -n logging get po -o wide NAME READY STATUS RESTARTS AGE IP NODE elasticsearch-logging-0 1/1 Running 0 69m 10.244.1.104 k8s-slave1 # 然后通过curl命令访问一下服务，验证es是否部署成功 $ kubectl -n logging get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE elasticsearch ClusterIP 10.109.174.58 \u003cnone\u003e 9200/TCP 71m $ curl 10.109.174.58:9200 { \"name\" : \"elasticsearch-logging-0\", \"cluster_name\" : \"docker-cluster\", \"cluster_uuid\" : \"uic8xOyNSlGwvoY9DIBT1g\", \"version\" : { \"number\" : \"7.4.2\", \"build_flavor\" : \"default\", \"build_type\" : \"docker\", \"build_hash\" : \"2f90bbf7b93631e52bafb59b3b049cb44ec25e96\", \"build_date\" : \"2019-10-28T20:40:44.881551Z\", \"build_snapshot\" : false, \"lucene_version\" : \"8.2.0\", \"minimum_wire_compatibility_version\" : \"6.8.0\", \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" }, \"tagline\" : \"You Know, for Search\" } 部署kibana 部署分析 kibana需要暴漏web页面给前端使用，因此使用ingress配置域名来实现对kibana的访问 kibana为无状态应用，直接使用Deployment来启动 kibana需要访问es，直接利用k8s服务发现访问此地址即可，http://elasticsearch:9200 部署并验证 资源文件 efk/kibana.yaml\napiVersion: apps/v1 kind: Deployment metadata: name: kibana namespace: logging labels: app: kibana spec: selector: matchLabels: app: kibana template: metadata: labels: app: kibana spec: containers: - name: kibana image: 172.21.32.6:5000/kibana/kibana:7.4.2 resources: limits: cpu: 1000m requests: cpu: 100m env: - name: ELASTICSEARCH_URL value: http://elasticsearch:9200 ports: - containerPort: 5601 --- apiVersion: v1 kind: Service metadata: name: kibana namespace: logging labels: app: kibana spec: ports: - port: 5601 protocol: TCP targetPort: 5601 type: ClusterIP selector: app: kibana --- apiVersion: extensions/v1beta1 kind: Ingress metadata: name: kibana namespace: logging spec: rules: - host: kibana.devops.cn http: paths: - path: / backend: serviceName: kibana servicePort: 5601 $ kubectl create -f kibana.yaml deployment.apps/kibana created service/kibana created ingress/kibana created # 然后查看pod，等待状态变成running $ kubectl -n logging get po NAME READY STATUS RESTARTS AGE elasticsearch-logging-0 1/1 Running 0 88m kibana-944c57766-ftlcw 1/1 Running 0 15m ## 配置域名解析 kibana.devops.cn，并访问服务进行验证，若可以访问，说明连接es成功 部署fluentd 部署分析 fluentd为日志采集服务，kubernetes集群的每个业务节点都有日志产生，因此需要使用daemonset的模式进行部署 为进一步控制资源，会为daemonset指定一个选择表情，fluentd=true来做进一步过滤，只有带有此标签的节点才会部署fluentd 日志采集，需要采集哪些目录下的日志，采集后发送到es端，因此需要配置的内容比较多，我们选择使用configmap的方式把配置文件整个挂载出来 部署服务 配置文件，efk/fluentd-es-main.yaml\napiVersion: v1 data: fluent.conf: |- # This is the root config file, which only includes components of the actual configuration # # Do not collect fluentd's own logs to avoid infinite loops. @type null @include /fluentd/etc/config.d/*.conf kind: ConfigMap metadata: labels: addonmanager.kubernetes.io/mode: Reconcile name: fluentd-es-config-main namespace: logging 配置文件，fluentd-config.yaml，注意点：\n数据源source的配置，k8s会默认把容器的标准和错误输出日志重定向到宿主机中 默认集成了 kubernetes_metadata_filter 插件，来解析日志格式，得到k8s相关的元数据，raw.kubernetes match输出到es端的flush配置 kind: ConfigMap apiVersion: v1 metadata: name: fluentd-config namespace: logging labels: addonmanager.kubernetes.io/mode: Reconcile data: system.conf: |- root_dir /tmp/fluentd-buffers/ containers.input.conf: |- @id fluentd-containers.log @type tail path /var/log/containers/*.log pos_file /var/log/es-containers.log.pos time_format %Y-%m-%dT%H:%M:%S.%NZ localtime tag raw.kubernetes.* format json read_from_head true # Detect exceptions in the log output and forward them as one log entry. @id raw.kubernetes @type detect_exceptions remove_tag_prefix raw message log stream stream multiline_flush_interval 5 max_bytes 500000 max_lines 1000 forward.input.conf: |- # Takes the messages sent over TCP @type forward output.conf: |- # Enriches records with Kubernetes metadata @type kubernetes_metadata @id elasticsearch @type elasticsearch @log_level info include_tag_key true host elasticsearch port 9200 logstash_format true request_timeout 30s @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size 2M queue_limit_length 8 overflow_action block daemonset定义文件，fluentd.yaml，注意点：\n需要配置rbac规则，因为需要访问k8s api去根据日志查询元数据 需要将/var/log/containers/目录挂载到容器中 需要将fluentd的configmap中的配置文件挂载到容器内 想要部署fluentd的节点，需要添加fluentd=true的标签 efk/fluentd.yaml\napiVersion: v1 kind: ServiceAccount metadata: name: fluentd-es namespace: logging labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile rules: - apiGroups: - \"\" resources: - \"namespaces\" - \"pods\" verbs: - \"get\" - \"watch\" - \"list\" --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile subjects: - kind: ServiceAccount name: fluentd-es namespace: logging apiGroup: \"\" roleRef: kind: ClusterRole name: fluentd-es apiGroup: \"\" --- apiVersion: apps/v1 kind: DaemonSet metadata: labels: addonmanager.kubernetes.io/mode: Reconcile k8s-app: fluentd-es name: fluentd-es namespace: logging spec: selector: matchLabels: k8s-app: fluentd-es template: metadata: labels: k8s-app: fluentd-es spec: containers: - env: - name: FLUENTD_ARGS value: --no-supervisor -q image: 172.21.32.6:5000/fluentd-es-root:v1.6.2-1.0 imagePullPolicy: IfNotPresent name: fluentd-es resources: limits: memory: 500Mi requests: cpu: 100m memory: 200Mi volumeMounts: - mountPath: /var/log name: varlog - mountPath: /var/lib/docker/containers name: varlibdockercontainers readOnly: true - mountPath: /home/docker/containers name: varlibdockercontainershome readOnly: true - mountPath: /fluentd/etc/config.d name: config-volume - mountPath: /fluentd/etc/fluent.conf name: config-volume-main subPath: fluent.conf nodeSelector: fluentd: \"true\" securityContext: {} serviceAccount: fluentd-es serviceAccountName: fluentd-es volumes: - hostPath: path: /var/log type: \"\" name: varlog - hostPath: path: /var/lib/docker/containers type: \"\" name: varlibdockercontainers - hostPath: path: /home/docker/containers type: \"\" name: varlibdockercontainershome - configMap: defaultMode: 420 name: fluentd-config name: config-volume - configMap: defaultMode: 420 items: - key: fluent.conf path: fluent.conf name: fluentd-es-config-main name: config-volume-main ## 给slave1和slave2打上标签，进行部署fluentd日志采集服务 $ kubectl label node k8s-slave1 fluentd=true node/k8s-slave1 labeled $ kubectl label node k8s-slave2 fluentd=true node/k8s-slave2 labeled # 创建服务 $ kubectl create -f fluentd-es-config-main.yaml configmap/fluentd-es-config-main created $ kubectl create -f fluentd-configmap.yaml configmap/fluentd-config created $ kubectl create -f fluentd.yaml serviceaccount/fluentd-es created clusterrole.rbac.authorization.k8s.io/fluentd-es created clusterrolebinding.rbac.authorization.k8s.io/fluentd-es created daemonset.extensions/fluentd-es created ## 然后查看一下pod是否已经在k8s-slave1和k8s-slave2节点启动成功 $ kubectl -n logging get po -o wide NAME READY STATUS RESTARTS AGE elasticsearch-logging-0 1/1 Running 0 123m fluentd-es-246pl 1/1 Running 0 2m2s fluentd-es-4e21w 1/1 Running 0 2m10s kibana-944c57766-ftlcw 1/1 Running 0 50m EFK功能验证 验证思路 k8s-slave1和slave2中启动服务，同时往标准输出中打印测试日志，到kibana中查看是否可以收集\n创建测试容器 apiVersion: v1 kind: Pod metadata: name: counter spec: nodeSelector: fluentd: \"true\" containers: - name: count image: alpine:3.6 args: [/bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done'] $ kubectl get po NAME READY STATUS RESTARTS AGE counter 1/1 Running 0 6s 配置kibana 登录kibana界面，按照截图的顺序操作：\n也可以通过其他元数据来过滤日志数据，比如可以单击任何日志条目以查看其他元数据，如容器名称，Kubernetes 节点，命名空间等，比如kubernetes.pod_name : counter\n到这里，我们就在 Kubernetes 集群上成功部署了 EFK ，要了解如何使用 Kibana 进行日志数据分析，可以参考 Kibana 用户指南文档：https://www.elastic.co/guide/en/kibana/current/index.html\n","wordCount":"8052","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wandong1.github.io/post/%E5%9F%BA%E4%BA%8Edocker%E5%92%8Ckubernetes%E7%9A%84%E4%BC%81%E4%B8%9A%E7%BA%A7devops%E5%AE%9E%E8%B7%B5%E8%AE%AD%E7%BB%83%E8%90%A5/"},"publisher":{"@type":"Organization","name":"万东的云计算运维博客","logo":{"@type":"ImageObject","url":"https://wandong1.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wandong1.github.io accesskey=h title="万东的云计算运维博客 (Alt + H)"><img src=https://wandong1.github.io/img-icon.png alt=logo aria-label=logo height=35>万东的云计算运维博客</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wandong1.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wandong1.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://wandong1.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://wandong1.github.io/search title=搜索><span>搜索</span></a></li></ul></nav></header><main class="main page"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wandong1.github.io>Home</a>&nbsp;»&nbsp;<a href=https://wandong1.github.io/post/>Posts</a></div><h1 class=post-title></h1><div class=post-meta>38 min&nbsp;·&nbsp;8052 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/post/%e5%9f%ba%e4%ba%8eDocker%e5%92%8cKubernetes%e7%9a%84%e4%bc%81%e4%b8%9a%e7%ba%a7DevOps%e5%ae%9e%e8%b7%b5%e8%ae%ad%e7%bb%83%e8%90%a5.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#基于docker和kubernetes的企业级devops实践训练营>基于Docker和Kubernetes的企业级DevOps实践训练营</a><ul><li><a href=#课程准备>课程准备</a></li><li><a href=#关于本人>关于本人</a></li><li><a href=#课程安排>课程安排</a></li><li><a href=#课程介绍>课程介绍</a></li><li><a href=#流程示意>流程示意</a></li><li><a href=#你将学到哪些>你将学到哪些</a></li><li><a href=#第一章--走进docker的世界>第一章 走进Docker的世界</a></li><li><a href=#第二章--kubernetes实践之旅----录屏>第二章 Kubernetes实践之旅 录屏！！！</a></li></ul></li></ul></nav></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=基于docker和kubernetes的企业级devops实践训练营>基于Docker和Kubernetes的企业级DevOps实践训练营<a hidden class=anchor aria-hidden=true href=#基于docker和kubernetes的企业级devops实践训练营>#</a></h2><h3 id=课程准备>课程准备<a hidden class=anchor aria-hidden=true href=#课程准备>#</a></h3><ol><li><p>离线镜像包</p><p>百度：https://pan.baidu.com/s/1N1AYGCYftYGn6L0QPMWIMw 提取码：ev2h</p><p>天翼云：https://cloud.189.cn/t/ENjUbmRR7FNz</p></li><li><p>CentOS7.4版本以上 虚拟机3台（4C+8G+50G），内网互通，可连外网</p></li><li><p>课件文档</p><ul><li>《训练营课件》</li><li>《安装手册》</li></ul></li><li><p>git仓库</p><p><a href=https://gitee.com/agagin/python-demo.git>https://gitee.com/agagin/python-demo.git</a> python demo项目</p><p><a href=https://gitee.com/agagin/demo-resources.git>https://gitee.com/agagin/demo-resources.git</a> demo项目演示需要的资源文件</p></li></ol><h3 id=关于本人>关于本人<a hidden class=anchor aria-hidden=true href=#关于本人>#</a></h3><p>李永信</p><p>2012-2017，云平台开发工程师，先后对接过Vmware、OpenStack、Docker平台</p><p>2017-2019， 运维开发工程师，Docker+Kubernetes的Paas平台运维开发</p><p>2019至今，DevOps工程师</p><p>8年多的时间，积攒了一定的开发和运维经验，跟大家分享。</p><h3 id=课程安排>课程安排<a hidden class=anchor aria-hidden=true href=#课程安排>#</a></h3><p>2020.4.11 Docker + kubernetes</p><p>2020.4.18 DevOps平台实践</p><p>2天的时间，节奏会相对快一些</p><p>小调研：</p><ul><li>A : 只听过docker，几乎没有docker的使用经验</li><li>B：有一定的docker实践经验，不熟悉或者几乎没用过k8s</li><li>C：对于docker和k8s都有一定的实践经验，想更多了解如何基于docker+k8s构建devops平台</li><li>D：其他</li></ul><h3 id=课程介绍>课程介绍<a hidden class=anchor aria-hidden=true href=#课程介绍>#</a></h3><p>最近的三年多时间，关注容器圈的话应该会知道这么几个事情：</p><ul><li><p>容器技术持续火爆</p><p><img loading=lazy src=images%5cdeplpment.png alt></p></li><li><p>Kubernetes(k8s)成为容器编排管理的标准</p></li><li><p>国内外厂商均已开始了全面拥抱Kubernetes的转型， 无数中小型企业已经落地 Kubernetes，或正走落地的道路上 。基于目前的发展趋势可以预见，未来几年以kubernetes平台为核心的容器运维管理、DevOps等将迎来全面的发展。</p></li></ul><p>本着实践为核心的思想，本课程使用企业常见的基于Django + uwsgi + Nginx架构的Python Demo项目，分别讲述三个事情：</p><ul><li><p>项目的容器化</p><p>教大家如何把公司的项目做成容器，并且运行在docker环境中</p></li><li><p>使用Kubernetes集群来管理容器化的项目</p><p>带大家一步一步部署k8s集群，并把容器化后的demo项目使用k8s来管理起来</p></li><li><p>使用Jenkins和Kubernetes集成，实现demo项目的持续集成/持续交付(CI/CD)</p><p>会使用k8s管理应用生命周期后，还差最后的环节，就是如何把开发、测试、部署的流程使用自动化工具整合起来，最后一部分呢，课程会教会大家如何优雅的使用gitlab+Jenkins+k8s构建企业级的DevOps平台</p></li></ul><h3 id=流程示意>流程示意<a hidden class=anchor aria-hidden=true href=#流程示意>#</a></h3><p><img loading=lazy src=images%5cdevops.png alt></p><h3 id=你将学到哪些>你将学到哪些<a hidden class=anchor aria-hidden=true href=#你将学到哪些>#</a></h3><ul><li><p>Docker相关</p><ul><li>如何使用Dockerfile快速构建镜像</li><li>Docker镜像、容器、仓库的常用操作</li><li>Docker容器的网络（Bridge下的SNAT、DNAT）</li></ul></li><li><p>Kubernetes相关</p><ul><li>集群的快速搭建</li><li>kubernetes的架构及工作流程</li><li>使用Pod控制器管理业务应用的生命周期</li><li>使用CoreDNS、Service和Ingress实现服务发现、负载均衡及四层、七层网络的访问</li><li>Kubernetes的认证授权体系</li></ul></li><li><p>使用EFK构建集群业务应用的日志收集系统</p></li><li><p>基于Gitlab+Jenkins+k8s构建DevOps平台</p><ul><li>Jenkins介绍及流水线的使用</li><li>Jenkinsfile及多分支流水线的实际应用</li><li>Jenkins集成sonarQube、Docker、Kubernetes</li><li>使用groovy编写sharedLibrary，实现CI/CD流程的优化</li></ul></li></ul><h3 id=第一章--走进docker的世界>第一章 走进Docker的世界<a hidden class=anchor aria-hidden=true href=#第一章--走进docker的世界>#</a></h3><p>介绍docker的前世今生，了解docker的实现原理，以Django项目为例，带大家如何编写最佳的Dockerfile构建镜像。通过本章的学习，大家会知道docker的概念及基本操作，并学会构建自己的业务镜像，并通过抓包的方式掌握Docker最常用的bridge网络模式的通信。</p><h4 id=认识docker>认识docker<a hidden class=anchor aria-hidden=true href=#认识docker>#</a></h4><h6 id=怎么出现的>怎么出现的<a hidden class=anchor aria-hidden=true href=#怎么出现的>#</a></h6><ul><li><p>轻量、高效的虚拟化</p><p>Docker 公司位于旧金山,原名dotCloud，底层利用了Linux容器技术（在操作系统中实现资源隔离与限制）。为了方便创建和管理这些容器，dotCloud 开发了一套内部工具，之后被命名为“Docker”。Docker就是这样诞生的。</p><p>（思考为啥要用Linux容器技术？）</p><p><img loading=lazy src=images%5cdocker-differents.svg alt></p></li></ul><p>Hypervisor： 一种运行在基础物理服务器和操作系统之间的中间软件层，可允许多个操作系统和应用共享硬件 。常见的VMware的 Workstation 、ESXi、微软的Hyper-V或者思杰的XenServer。</p><p>Container Runtime：通过Linux内核虚拟化能力管理多个容器，多个容器共享一套操作系统内核。因此摘掉了内核占用的空间及运行所需要的耗时，使得容器极其轻量与快速。</p><ul><li><p>软件交付过程中的环境依赖</p><p><img loading=lazy src=images%5cwhy.png alt></p></li></ul><h6 id=几个知识点>几个知识点<a hidden class=anchor aria-hidden=true href=#几个知识点>#</a></h6><ul><li><p>可以把应用程序代码及运行依赖环境打包成镜像，作为交付介质，在各环境部署</p></li><li><p>可以将镜像（image）启动成为容器(container)，并且提供多容器的生命周期进行管理（启、停、删）</p></li><li><p>container容器之间相互隔离，且每个容器可以设置资源限额</p></li><li><p>提供轻量级虚拟化功能，容器就是在宿主机中的一个个的虚拟的空间，彼此相互隔离，完全独立</p></li><li><p>CS架构的软件产品</p><p><img loading=lazy src=images%5cdocker-engine.png alt></p></li></ul><h6 id=版本管理>版本管理<a hidden class=anchor aria-hidden=true href=#版本管理>#</a></h6><ul><li>Docker 引擎主要有两个版本：企业版（EE）和社区版（CE）</li><li>每个季度(1-3,4-6,7-9,10-12)，企业版和社区版都会发布一个稳定版本(Stable)。社区版本会提供 4 个月的支持，而企业版本会提供 12 个月的支持</li><li>每个月社区版还会通过 Edge 方式发布月度版</li><li>从 2017 年第一季度开始，Docker 版本号遵循 YY.MM-xx 格式，类似于 Ubuntu 等项目。例如，2018 年 6 月第一次发布的社区版本为 18.06.0-ce</li></ul><p><img loading=lazy src=images%5cdocker-version.png alt></p><h6 id=发展史>发展史<a hidden class=anchor aria-hidden=true href=#发展史>#</a></h6><p>13年成立，15年开始，迎来了飞速发展。</p><p><img loading=lazy src=C:%5cUsers%5cliyongxin%5cDesktop%5cwework%5c%e8%80%81%e7%94%b7%e5%ad%a9%5c%e8%ae%ad%e7%bb%83%e8%90%a5%5cimages%5cdeplpment.png alt></p><p>Docker 1.8之前，使用<a href=https://linuxcontainers.org/fr/lxc/introduction/>LXC</a>，Docker在上层做了封装， 把LXC复杂的容器创建与使用方式简化为自己的一套命令体系。</p><p>之后，为了实现跨平台等复杂的场景，Docker抽出了libcontainer项目，把对namespace、cgroup的操作封装在libcontainer项目里，支持不同的平台类型。</p><p>2015年6月，Docker牵头成立了 OCI（Open Container Initiative开放容器计划）组织，这个组织的目的是建立起一个围绕容器的通用标准 。 容器格式标准是一种不受上层结构绑定的协议，即不限于某种特定操作系统、硬件、CPU架构、公有云等 ， 允许任何人在遵循该标准的情况下开发应用容器技术，这使得容器技术有了一个更广阔的发展空间。</p><p>OCI成立后，libcontainer 交给OCI组织来维护，但是libcontainer中只包含了与kernel交互的库，因此基于libcontainer项目，后面又加入了一个CLI工具，并且项目改名为runC (<a href=https://github.com/opencontainers/runc>https://github.com/opencontainers/runc</a> )， 目前runC已经成为一个功能强大的runtime工具。</p><p>Docker也做了架构调整。将容器运行时相关的程序从docker daemon剥离出来，形成了<strong>containerd</strong>。containerd向上为Docker Daemon提供了<code>gRPC接口</code>，使得Docker Daemon屏蔽下面的结构变化，确保原有接口向下兼容。向下通过<code>containerd-shim</code>结合<code>runC</code>，使得引擎可以独立升级，避免之前Docker Daemon升级会导致所有容器不可用的问题。</p><p><img loading=lazy src=images%5ccontainerd.png alt></p><p>也就是说</p><ul><li>runC（libcontainer）是符合OCI标准的一个实现，与底层系统交互</li><li>containerd是实现了OCI之上的容器的高级功能，比如镜像管理、容器执行的调用等</li><li>Dockerd目前是最上层与CLI交互的进程，接收cli的请求并与containerd协作</li></ul><h6 id=小结>小结<a hidden class=anchor aria-hidden=true href=#小结>#</a></h6><ol><li>为了解决软件交付过程中的环境依赖，同时提供一种更加轻量的虚拟化技术，Docker出现了</li><li>Docker是一种CS架构的软件产品，可以把代码及依赖打包成镜像，作为交付介质，并且把镜像启动成为容器，提供容器生命周期的管理</li><li>docker-ce，每季度发布stable版本。18.06，18.09，19.03</li><li>发展至今，docker已经通过制定OCI标准对最初的项目做了拆分，其中runC和containerd是docker的核心项目，理解docker整个请求的流程，对我们深入理解docker有很大的帮助</li></ol><h4 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h4><h6 id=配置宿主机网卡转发>配置宿主机网卡转发<a hidden class=anchor aria-hidden=true href=#配置宿主机网卡转发>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 配置网卡转发,看值是否为1</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>sysctl</span> <span class=n>-a</span> <span class=p>|</span><span class=n>grep</span> <span class=n>-w</span> <span class=n>net</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>ip_forward</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>ip_forward</span> <span class=p>=</span> <span class=n>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 若未配置，需要执行如下</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>cat </span><span class=p>&lt;&lt;</span><span class=n>EOF</span> <span class=p>&gt;</span>  <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>sysctl</span><span class=p>.</span><span class=n>d</span><span class=p>/</span><span class=n>docker</span><span class=p>.</span><span class=n>conf</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=p>.</span><span class=n>bridge</span><span class=p>.</span><span class=nb>bridge-nf</span><span class=n>-call-ip6tables</span> <span class=p>=</span> <span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=p>.</span><span class=n>bridge</span><span class=p>.</span><span class=nb>bridge-nf</span><span class=n>-call-iptables</span> <span class=p>=</span> <span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>ip_forward</span><span class=p>=</span><span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>EOF</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>sysctl</span> <span class=n>-p</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>sysctl</span><span class=p>.</span><span class=n>d</span><span class=p>/</span><span class=n>docker</span><span class=p>.</span><span class=n>conf</span>
</span></span></code></pre></div><h6 id=yum安装配置docker>Yum安装配置docker<a hidden class=anchor aria-hidden=true href=#yum安装配置docker>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 下载阿里源repo文件</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>-o</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>yum</span><span class=p>.</span><span class=n>repos</span><span class=p>.</span><span class=n>d</span><span class=p>/</span><span class=n>Centos</span><span class=p>-</span><span class=n>7</span><span class=p>.</span><span class=n>repo</span> <span class=n>http</span><span class=err>:</span><span class=p>//</span><span class=n>mirrors</span><span class=p>.</span><span class=n>aliyun</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>repo</span><span class=p>/</span><span class=n>Centos</span><span class=p>-</span><span class=n>7</span><span class=p>.</span><span class=n>repo</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>-o</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>yum</span><span class=p>.</span><span class=n>repos</span><span class=p>.</span><span class=n>d</span><span class=p>/</span><span class=nb>docker-ce</span><span class=p>.</span><span class=n>repo</span> <span class=n>http</span><span class=err>:</span><span class=p>//</span><span class=n>mirrors</span><span class=p>.</span><span class=n>aliyun</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=nb>docker-ce</span><span class=p>/</span><span class=n>linux</span><span class=p>/</span><span class=n>centos</span><span class=p>/</span><span class=nb>docker-ce</span><span class=p>.</span><span class=n>repo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>yum</span> <span class=n>clean</span> <span class=n>all</span> <span class=p>&amp;&amp;</span> <span class=n>yum</span> <span class=n>makecache</span>
</span></span><span class=line><span class=cl><span class=c>## yum安装</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>yum</span> <span class=n>install</span> <span class=n>-y</span> <span class=nb>docker-ce</span>
</span></span><span class=line><span class=cl><span class=c>## 查看源中可用版本</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>yum</span> <span class=n>list</span> <span class=nb>docker-ce</span> <span class=p>-</span><span class=n>-showduplicates</span> <span class=p>|</span> <span class=nb>sort </span><span class=n>-r</span>
</span></span><span class=line><span class=cl><span class=c>## 安装指定版本</span>
</span></span><span class=line><span class=cl><span class=c>##yum install -y docker-ce-18.09.9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 配置源加速</span>
</span></span><span class=line><span class=cl><span class=c>## https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</span>
</span></span><span class=line><span class=cl><span class=n>mkdir</span> <span class=n>-p</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>docker</span>
</span></span><span class=line><span class=cl><span class=n>vi</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>docker</span><span class=p>/</span><span class=n>daemon</span><span class=p>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;registry-mirrors&#34;</span> <span class=err>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://8xpk5wnt.mirror.aliyuncs.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://dockerhub.azk8s.cn&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://registry.docker-cn.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://ot2k4d59.mirror.aliyuncs.com/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 设置开机自启</span>
</span></span><span class=line><span class=cl><span class=n>systemctl</span> <span class=n>enable</span> <span class=n>docker</span>  
</span></span><span class=line><span class=cl><span class=n>systemctl</span> <span class=nb>daemon-reload</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 启动docker</span>
</span></span><span class=line><span class=cl><span class=n>systemctl</span> <span class=nb>start </span><span class=n>docker</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看docker信息</span>
</span></span><span class=line><span class=cl><span class=n>docker</span> <span class=n>info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## docker-client</span>
</span></span><span class=line><span class=cl><span class=n>which</span> <span class=n>docker</span>
</span></span><span class=line><span class=cl><span class=c>## docker daemon</span>
</span></span><span class=line><span class=cl><span class=nb>ps </span><span class=n>aux</span> <span class=p>|</span><span class=n>grep</span> <span class=n>docker</span>
</span></span></code></pre></div><h4 id=核心要素及常用操作详解>核心要素及常用操作详解<a hidden class=anchor aria-hidden=true href=#核心要素及常用操作详解>#</a></h4><p><img loading=lazy src=images%5cdocker%e6%9e%b6%e6%9e%84.png alt></p><p>三大核心要素：镜像(Image)、容器(Container)、仓库(Registry)</p><p>（先整体看下流程，再逐个演示）</p><h6 id=镜像image>镜像（Image）<a hidden class=anchor aria-hidden=true href=#镜像image>#</a></h6><p>打包了业务代码及运行环境的包，是静态的文件，不能直接对外提供服务。</p><h6 id=容器container>容器（Container）<a hidden class=anchor aria-hidden=true href=#容器container>#</a></h6><p>镜像的运行时，可以对外提供服务。本质上讲是利用namespace和cgroup等技术在宿主机中创建的独立的虚拟空间。</p><h6 id=仓库registry>仓库（Registry）<a hidden class=anchor aria-hidden=true href=#仓库registry>#</a></h6><ul><li>公有仓库，Docker Hub，阿里，网易&mldr;</li><li>私有仓库，企业内部搭建<ul><li>Docker Registry，Docker官方提供的镜像仓库存储服务</li><li>Harbor, 是Docker Registry的更高级封装，它除了提供友好的Web UI界面，角色和用户权限管理，用户操作审计等功能</li></ul></li><li>镜像访问地址形式 registry.devops.com/demo/hello:latest,若没有前面的url地址，则默认寻找Docker Hub中的镜像，若没有tag标签，则使用latest作为标签</li><li>公有的仓库中，一般存在这么几类镜像<ul><li>操作系统基础镜像（centos，ubuntu，suse，alpine）</li><li>中间件（nginx，redis，mysql，tomcat）</li><li>语言编译环境（python，java，golang）</li><li>业务镜像（django-demo&mldr;）</li></ul></li></ul><h6 id=操作演示>操作演示<a hidden class=anchor aria-hidden=true href=#操作演示>#</a></h6><p><img loading=lazy src=images%5c%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4.jpg alt></p><ol><li><p>解压离线包</p><p>为了保证镜像下载的速度，因此提前在一台节点下载了离线镜像包，做解压：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>tar</span> <span class=n>zxf</span> <span class=n>registry</span><span class=p>.</span><span class=n>tar</span><span class=p>.</span><span class=n>gz</span> <span class=n>-C</span> <span class=p>/</span><span class=n>opt</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>ll</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=nb>registry-data</span>
</span></span><span class=line><span class=cl><span class=n>total</span> <span class=n>25732</span>
</span></span><span class=line><span class=cl><span class=nb>drwxr-xr</span><span class=n>-x</span> <span class=n>3</span> <span class=n>root</span> <span class=n>root</span>     <span class=n>4096</span> <span class=n>Apr</span>  <span class=n>9</span> <span class=n>20</span><span class=err>:</span><span class=n>11</span> <span class=n>registry</span>
</span></span><span class=line><span class=cl><span class=n>-rw</span><span class=p>-------</span> <span class=n>1</span> <span class=n>root</span> <span class=n>root</span> <span class=n>26344448</span> <span class=n>Apr</span>  <span class=n>9</span> <span class=n>22</span><span class=err>:</span><span class=n>15</span> <span class=nb>registry-v2</span><span class=p>.</span><span class=n>tar</span>
</span></span></code></pre></div></li><li><p>查看所有镜像：</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>images</span>
</span></span></code></pre></div><ol start=2><li>拉取镜像:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>pull</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span></code></pre></div><ol start=3><li>如何唯一确定镜像:</li></ol><ul><li>image_id</li><li>repository:tag</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>images</span>
</span></span><span class=line><span class=cl><span class=n>REPOSITORY</span>    <span class=n>TAG</span>                 <span class=n>IMAGE</span> <span class=n>ID</span>            <span class=n>CREATED</span>             <span class=n>SIZE</span>
</span></span><span class=line><span class=cl><span class=n>nginx</span>         <span class=n>alpine</span>              <span class=n>377c0837328f</span>        <span class=n>2</span> <span class=n>weeks</span> <span class=n>ago</span>         <span class=n>19</span><span class=p>.</span><span class=n>7MB</span>
</span></span></code></pre></div><ol start=4><li><p>导出镜像到文件中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell></code></pre></div></li></ol><p>$ docker save -o nginx-alpine.tar nginx:alpine</p><pre tabindex=0><code>
5. 从文件中加载镜像

```powershell
$ docker load -i nginx-alpine.tar
</code></pre><ol start=6><li><p>部署镜像仓库</p><p><a href=https://docs.docker.com/registry/>https://docs.docker.com/registry/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 使用docker镜像启动镜像仓库服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=n>-p</span> <span class=n>5000</span><span class=err>:</span><span class=n>5000</span> <span class=p>-</span><span class=n>-restart</span> <span class=n>always</span> <span class=n>-v</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=nb>registry-data</span><span class=p>/</span><span class=n>registry</span><span class=err>:</span><span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>lib</span><span class=p>/</span><span class=n>registry</span> <span class=p>-</span><span class=n>-name</span> <span class=n>registry</span> <span class=n>registry</span><span class=err>:</span><span class=n>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 默认仓库不带认证，若需要认证，参考https://docs.docker.com/registry/deploying/#restricting-access</span>
</span></span></code></pre></div><p>假设启动镜像仓库服务的主机地址为172.21.32.6，该目录中已存在的镜像列表：</p><table><thead><tr><th>现镜像仓库地址</th><th>原镜像仓库地址</th></tr></thead><tbody><tr><td>172.21.32.6:5000/coreos/flannel:v0.11.0-amd64</td><td>quay.io/coreos/flannel:v0.11.0-amd64</td></tr><tr><td>172.21.32.6:5000/mysql:5.7</td><td>mysql:5.7</td></tr><tr><td>172.21.32.6:5000/nginx:alpine</td><td>nginx:alpine</td></tr><tr><td>172.21.32.6:5000/centos:centos7.5.1804</td><td>centos:centos7.5.1804</td></tr><tr><td>172.21.32.6:5000/elasticsearch/elasticsearch:7.4.2</td><td>docker.elastic.co/elasticsearch/elasticsearch:7.4.2</td></tr><tr><td>172.21.32.6:5000/fluentd-es-root:v1.6.2-1.0</td><td>gcr.io/google_containers/fluentd-elasticsearch:v2.4.0</td></tr><tr><td>172.21.32.6:5000/kibana/kibana:7.4.2</td><td>docker.elastic.co/kibana/kibana:7.4.2</td></tr><tr><td>172.21.32.6:5000/kubernetesui/dashboard:v2.0.0-beta5</td><td>kubernetesui/dashboard:v2.0.0-beta5</td></tr><tr><td>172.21.32.6:5000/kubernetesui/metrics-scraper:v1.0.1</td><td>kubernetesui/metrics-scraper:v1.0.1</td></tr><tr><td>172.21.32.6:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</td><td>quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</td></tr></tbody></table></li><li><p>推送本地镜像到镜像仓库中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>tag</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span> <span class=n>localhost</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>push</span> <span class=n>localhost</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=c>## 我的镜像仓库给外部访问，不能通过localhost，尝试使用内网地址172.21.16.3:5000/nginx:alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>tag</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>push</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>push</span> <span class=n>refers</span> <span class=n>to</span> <span class=n>repository</span> <span class=p>[</span><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Get</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>v2</span><span class=p>/</span><span class=err>:</span> <span class=n>http</span><span class=err>:</span> <span class=n>server</span> <span class=n>gave</span> <span class=n>HTTP</span> <span class=n>response</span> <span class=n>to</span> <span class=n>HTTPS</span> <span class=n>client</span>
</span></span><span class=line><span class=cl><span class=c>## docker默认不允许向http的仓库地址推送，如何做成https的，参考：https://docs.docker.com/registry/deploying/#run-an-externally-accessible-registry</span>
</span></span><span class=line><span class=cl><span class=c>## 我们没有可信证书机构颁发的证书和域名，自签名证书需要在每个节点中拷贝证书文件，比较麻烦，因此我们通过配置daemon的方式，来跳过证书的验证：</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>cat </span><span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>docker</span><span class=p>/</span><span class=n>daemon</span><span class=p>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;registry-mirrors&#34;</span><span class=err>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://8xpk5wnt.mirror.aliyuncs.com&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;insecure-registries&#34;</span><span class=err>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>     <span class=s2>&#34;172.21.16.3:5000&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>systemctl</span> <span class=n>restart</span> <span class=n>docker</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>push</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>images</span>	<span class=c># IMAGE ID相同，等于起别名或者加快捷方式</span>
</span></span><span class=line><span class=cl><span class=n>REPOSITORY</span>               <span class=n>TAG</span>                 <span class=n>IMAGE</span> <span class=n>ID</span>            <span class=n>CREATED</span>             <span class=n>SIZE</span>
</span></span><span class=line><span class=cl><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>alpine</span>              <span class=n>377c0837328f</span>        <span class=n>4</span> <span class=n>weeks</span> <span class=n>ago</span>         
</span></span><span class=line><span class=cl><span class=n>nginx</span>                    <span class=n>alpine</span>              <span class=n>377c0837328f</span>        <span class=n>4</span> <span class=n>weeks</span> <span class=n>ago</span>         
</span></span><span class=line><span class=cl><span class=n>localhost</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>nginx</span>     <span class=n>alpine</span>              <span class=n>377c0837328f</span>        <span class=n>4</span> <span class=n>weeks</span> <span class=n>ago</span>         
</span></span><span class=line><span class=cl><span class=n>registry</span>                 <span class=n>2</span>                   <span class=n>708bc6af7e5e</span>        <span class=n>2</span> <span class=n>months</span> <span class=n>ago</span>       
</span></span></code></pre></div></li><li><p>删除镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>docker</span> <span class=n>rmi</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span></code></pre></div></li><li><p>查看容器列表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 查看运行状态的容器列表</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>ps
</span></span></span><span class=line><span class=cl><span class=nb></span>
</span></span><span class=line><span class=cl><span class=c>## 查看全部状态的容器列表</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>ps </span><span class=n>-a</span>
</span></span></code></pre></div></li><li><p>启动容器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 后台启动</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>nginx</span> <span class=n>-d</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=c>##查看run流程#</span>
</span></span><span class=line><span class=cl><span class=c>##查看容器进程</span>
</span></span><span class=line><span class=cl><span class=c>## 等同于在虚拟机中开辟了一块隔离的独立的虚拟空间</span>
</span></span><span class=line><span class=cl><span class=c>## 启动容器的同时进入容器，-ti与/bin/sh或者/bin/bash配套使用，意思未分配一个tty终端</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>nginx</span> <span class=n>-ti</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span> <span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=err>（</span><span class=n>注意</span><span class=err>：</span><span class=n>退出容器后</span><span class=err>，</span><span class=n>该容器会变成退出状态</span><span class=err>，</span><span class=n>因为容器内部的1号进程退出</span><span class=err>）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 实际上，在运行容器的时候，镜像地址后面跟的命令等于是覆盖了原有的容器的CMD命令，因此，执行的这些命令在容器内部就是1号进程，若该进程不存在了，那么容器就会处于退出的状态，比如，宿主机中执行</span>
</span></span><span class=line><span class=cl><span class=n>1</span><span class=p>.</span> <span class=nb>echo </span><span class=n>1</span><span class=p>,</span><span class=n>执行完后</span><span class=err>，</span><span class=n>该命令立马就结束了</span>
</span></span><span class=line><span class=cl><span class=n>2</span><span class=p>.</span> <span class=n>ping</span> <span class=n>www</span><span class=p>.</span><span class=n>baidu</span><span class=p>.</span><span class=n>com</span><span class=p>,</span><span class=n>执行完后</span><span class=err>，</span><span class=n>命令的进程会持续运行</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=p>-</span><span class=n>-name</span> <span class=n>test_echo</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span> <span class=nb>echo </span><span class=n>1</span><span class=p>,</span><span class=n>容器会立马退出</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=p>-</span><span class=n>-name</span> <span class=n>test_ping</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span> <span class=n>ping</span> <span class=n>www</span><span class=p>.</span><span class=n>baidu</span><span class=p>.</span><span class=n>com</span><span class=p>,</span><span class=n>容器不会退出</span><span class=err>，</span><span class=n>但是因为没有加-d参数</span><span class=err>，</span><span class=n>因此一直在前台运行</span><span class=err>，</span><span class=n>若ctrl</span><span class=p>+</span><span class=n>C终止</span><span class=err>，</span><span class=n>则容器退出</span><span class=err>，</span><span class=n>因为1号进程被终止了</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 映射端口,把容器的端口映射到宿主机中,-p &lt;host_port&gt;:&lt;container_port&gt;</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>nginx</span> <span class=n>-d</span> <span class=n>-p</span> <span class=n>8080</span><span class=err>:</span><span class=n>80</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 资源限制,-cpuset-cpus用于设置容器可以使用的 vCPU 核。-c,--cpu-shares用于设置多个容器竞争 CPU 时，各个容器相对能分配到的 CPU 时间比例。假设有三个正在运行的容器，这三个容器中的任务都是 CPU 密集型的。第一个容器的 cpu 共享权值是 1024，其它两个容器的 cpu 共享权值是 512。第一个容器将得到 50% 的 CPU 时间，而其它两个容器就只能各得到 25% 的 CPU 时间了。如果再添加第四个 cpu 共享值为 1024 的容器，每个容器得到的 CPU 时间将重新计算。第一个容器的CPU 时间变为 33%，其它容器分得的 CPU 时间分别为 16.5%、16.5%、33%。必须注意的是，这个比例只有在 CPU 密集型的任务执行时才有用。在四核的系统上，假设有四个单进程的容器，它们都能各自使用一个核的 100% CPU 时间，不管它们的 cpu 共享权值是多少。</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-cpuset-cpus</span><span class=p>=</span><span class=s2>&#34;0-3&#34;</span> <span class=p>-</span><span class=n>-cpu-shares</span><span class=p>=</span><span class=n>512</span> <span class=p>-</span><span class=n>-memory</span><span class=p>=</span><span class=n>500m</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span></code></pre></div><p><img loading=lazy src=images%5crun%e5%ae%b9%e5%99%a8%e6%b5%81%e7%a8%8b%e5%9b%be.jpg alt></p></li><li><p>容器数据持久化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 挂载主机目录</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>nginx</span> <span class=n>-d</span>  <span class=n>-v</span> <span class=p>/</span><span class=n>opt</span><span class=err>:</span><span class=p>/</span><span class=n>opt</span> <span class=n>-v</span> <span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>log</span><span class=err>:</span><span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>log</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>mysql</span> <span class=n>-e</span> <span class=n>MYSQL_ROOT_PASSWORD</span><span class=p>=</span><span class=n>123456</span> <span class=n>-d</span> <span class=n>-v</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=err>:</span><span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>lib</span><span class=p>/</span><span class=n>mysql</span> <span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 使用volumes卷</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>volume</span> <span class=nb>ls
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=p>$</span> <span class=n>docker</span> <span class=n>volume</span> <span class=n>create</span> <span class=nb>my-vol</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>nginx</span> <span class=n>-d</span> <span class=n>-v</span> <span class=nb>my-vol</span><span class=err>:</span><span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=nb>my-vol</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>nginx</span> <span class=n>touch</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=nb>my-vol</span><span class=p>/</span><span class=n>a</span><span class=p>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 验证数据共享</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>nginx2</span> <span class=n>-d</span> <span class=n>-v</span> <span class=nb>my-vol</span><span class=err>:</span><span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>hh</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>nginx2</span> <span class=nb>ls </span><span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>hh</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>.</span><span class=n>txt</span>
</span></span></code></pre></div></li><li><p>进入容器或者执行容器内的命令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=p>&lt;</span><span class=n>container_id_or_name</span><span class=p>&gt;</span> <span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=p>&lt;</span><span class=n>container_id_or_name</span><span class=p>&gt;</span> <span class=n>hostname</span>
</span></span></code></pre></div></li><li><p>主机与容器之间拷贝数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 主机拷贝到容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>echo </span><span class=s1>&#39;123&#39;</span><span class=p>&gt;/</span><span class=n>tmp</span><span class=p>/</span><span class=n>test</span><span class=p>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>cp </span><span class=p>/</span><span class=n>tmp</span><span class=p>/</span><span class=n>test</span><span class=p>.</span><span class=n>txt</span> <span class=n>nginx</span><span class=err>:</span><span class=p>/</span><span class=n>tmp</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>nginx</span> <span class=nb>cat </span><span class=p>/</span><span class=n>tmp</span><span class=p>/</span><span class=n>test</span><span class=p>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=n>123</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 容器拷贝到主机</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>cp </span><span class=n>nginx</span><span class=err>:</span><span class=p>/</span><span class=n>tmp</span><span class=p>/</span><span class=n>test</span><span class=p>.</span><span class=n>txt</span> <span class=p>./</span>
</span></span></code></pre></div></li><li><p>查看容器日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 查看全部日志</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>logs</span> <span class=n>nginx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 实时查看最新日志</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>logs</span> <span class=o>-f</span> <span class=n>nginx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 从最新的100条开始查看</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>logs</span> <span class=p>-</span><span class=n>-tail</span><span class=p>=</span><span class=n>100</span> <span class=o>-f</span> <span class=n>nginx</span>
</span></span></code></pre></div></li><li><p>停止或者删除容器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 停止运行中的容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>stop</span> <span class=n>nginx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 启动退出容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>start </span><span class=n>nginx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 删除退出容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>rm </span><span class=n>nginx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 删除运行中的容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>rm </span><span class=o>-f</span> <span class=n>nginx</span>
</span></span></code></pre></div></li><li><p>查看容器或者镜像的明细</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 查看容器详细信息，包括容器IP地址等</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>inspect</span> <span class=n>nginx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看镜像的明细信息</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>inspect</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span></code></pre></div></li></ol><h4 id=django应用容器化实践>Django应用容器化实践<a hidden class=anchor aria-hidden=true href=#django应用容器化实践>#</a></h4><h6 id=django项目介绍>django项目介绍<a hidden class=anchor aria-hidden=true href=#django项目介绍>#</a></h6><ul><li><p>项目地址：https://gitee.com/agagin/python-demo.git</p></li><li><p>python3 + uwsgi + nginx + mysql</p></li><li><p>内部服务端口8002</p></li></ul><h6 id=构建命令>构建命令<a hidden class=anchor aria-hidden=true href=#构建命令>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>.</span> <span class=n>-t</span> <span class=n>ImageName</span><span class=err>:</span><span class=n>ImageTag</span> <span class=o>-f</span> <span class=n>Dockerfile</span>
</span></span></code></pre></div><p>如何理解构建镜像的过程？</p><p>Dockerfile是一堆指令，在docker build的时候，按照该指令进行操作，最终生成我们期望的镜像</p><ul><li><p>FROM 指定基础镜像，必须为第一个命令</p><pre tabindex=0><code>格式：
	FROM &lt;image&gt;
	FROM &lt;image&gt;:&lt;tag&gt;
示例：
	FROM mysql:5.7
注意：
	tag是可选的，如果不使用tag时，会使用latest版本的基础镜像
</code></pre></li><li><p>MAINTAINER 镜像维护者的信息</p><pre tabindex=0><code>格式：
	MAINTAINER &lt;name&gt;
示例：
	MAINTAINER Yongxin Li
    MAINTAINER inspur_lyx@hotmail.com
    MAINTAINER Yongxin Li &lt;inspur_lyx@hotmail.com&gt;
</code></pre></li><li><p>COPY|ADD 添加本地文件到镜像中</p><pre tabindex=0><code>格式：
	COPY &lt;src&gt;... &lt;dest&gt;
示例：
    ADD hom* /mydir/          # 添加所有以&#34;hom&#34;开头的文件
    ADD test relativeDir/     # 添加 &#34;test&#34; 到 `WORKDIR`/relativeDir/
    ADD test /absoluteDir/    # 添加 &#34;test&#34; 到 /absoluteDir/
</code></pre></li><li><p>WORKDIR 工作目录</p><pre tabindex=0><code>格式：
	WORKDIR /path/to/workdir
示例：
    WORKDIR /a  (这时工作目录为/a)
注意：
	通过WORKDIR设置工作目录后，Dockerfile中其后的命令RUN、CMD、ENTRYPOINT、ADD、COPY等命令都会在该目录下执行
</code></pre></li><li><p>RUN 构建镜像过程中执行命令</p><pre tabindex=0><code>格式：
	RUN &lt;command&gt;
示例：
    RUN yum install nginx
    RUN pip install django
    RUN mkdir test &amp;&amp; rm -rf /var/lib/unusedfiles
注意：
	RUN指令创建的中间镜像会被缓存，并会在下次构建中使用。如果不想使用这些缓存镜像，可以在构建时指定--no-cache参数，如：docker build --no-cache
</code></pre></li><li><p>CMD 构建容器后调用，也就是在容器启动时才进行调用</p><pre tabindex=0><code>格式：
    CMD [&#34;executable&#34;,&#34;param1&#34;,&#34;param2&#34;] (执行可执行文件，优先)
    CMD [&#34;param1&#34;,&#34;param2&#34;] (设置了ENTRYPOINT，则直接调用ENTRYPOINT添加参数)
    CMD command param1 param2 (执行shell内部命令)
示例：
    CMD [&#34;/usr/bin/wc&#34;,&#34;--help&#34;]
    CMD ping www.baidu.com
注意：
	CMD不同于RUN，CMD用于指定在容器启动时所要执行的命令，而RUN用于指定镜像构建时所要执行的命令。
</code></pre></li><li><p>ENTRYPOINT 设置容器初始化命令，使其可执行化</p><pre tabindex=0><code>格式：
    ENTRYPOINT [&#34;executable&#34;, &#34;param1&#34;, &#34;param2&#34;] (可执行文件, 优先)
    ENTRYPOINT command param1 param2 (shell内部命令)
示例：
    ENTRYPOINT [&#34;/usr/bin/wc&#34;,&#34;--help&#34;]
注意：
	ENTRYPOINT与CMD非常类似，不同的是通过docker run执行的命令不会覆盖ENTRYPOINT，而docker run命令中指定的任何参数，都会被当做参数再次传递给ENTRYPOINT。Dockerfile中只允许有一个ENTRYPOINT命令，多指定时会覆盖前面的设置，而只执行最后的ENTRYPOINT指令
</code></pre></li><li><p>ENV</p><pre tabindex=0><code>格式：
    ENV &lt;key&gt; &lt;value&gt;
    ENV &lt;key&gt;=&lt;value&gt;
示例：
    ENV myName John
    ENV myCat=fluffy
</code></pre></li><li><p>EXPOSE</p><pre tabindex=0><code>格式：
    EXPOSE &lt;port&gt; [&lt;port&gt;...]
示例：
    EXPOSE 80 443
    EXPOSE 8080
    EXPOSE 11211/tcp 11211/udp
注意：
    EXPOSE并不会让容器的端口访问到主机。要使其可访问，需要在docker run运行容器时通过-p来发布这些端口，或通过-P参数来发布EXPOSE导出的所有端口
</code></pre><p><img loading=lazy src=images%5cDockerfile%e8%a7%a3%e9%87%8a.png alt></p></li></ul><h6 id=dockerfile>Dockerfile<a hidden class=anchor aria-hidden=true href=#dockerfile>#</a></h6><p><em>dockerfiles/myblog/Dockerfile</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># This my first django Dockerfile</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Version 1.0</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Base images 基础镜像</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> centos:centos7.5.1804</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#MAINTAINER 维护者信息</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>LABEL</span> <span class=nv>maintainer</span><span class=o>=</span><span class=s2>&#34;inspur_lyx@hotmail.com&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#ENV 设置环境变量</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    ENV LANG en_US.UTF-8<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    ENV LC_ALL en_US.UTF-8<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#RUN 执行以下命令</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -so /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> yum install -y  python36 python3-devel gcc pcre-devel zlib-devel make net-tools<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#工作目录</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /opt/myblog</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#拷贝文件至工作目录</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#安装nginx</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> tar -zxf nginx-1.13.7.tar.gz -C /opt  <span class=o>&amp;&amp;</span> <span class=nb>cd</span> /opt/nginx-1.13.7 <span class=o>&amp;&amp;</span> ./configure --prefix<span class=o>=</span>/usr/local/nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=o>&amp;&amp;</span> make <span class=o>&amp;&amp;</span> make install <span class=o>&amp;&amp;</span> ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> cp myblog.conf /usr/local/nginx/conf/myblog.conf<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#安装依赖的插件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod +x run.sh <span class=o>&amp;&amp;</span> rm -rf ~/.cache/pip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#EXPOSE 映射端口</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8002</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#容器启动时执行命令</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;./run.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>执行构建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>.</span> <span class=n>-t</span> <span class=n>myblog</span><span class=err>:</span><span class=n>v1</span> <span class=o>-f</span> <span class=n>Dockerfile</span>
</span></span></code></pre></div><h6 id=定制化基础镜像>定制化基础镜像<a hidden class=anchor aria-hidden=true href=#定制化基础镜像>#</a></h6><p><code>dockerfiles/myblog/Dockerfile-base</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># Base images 基础镜像</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> centos:centos7.5.1804</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#MAINTAINER 维护者信息</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>LABEL</span> <span class=nv>maintainer</span><span class=o>=</span><span class=s2>&#34;inspur_lyx@hotmail.com&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#ENV 设置环境变量</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> LANG en_US.UTF-8<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> LC_ALL en_US.UTF-8<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#RUN 执行以下命令</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -so /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> yum install -y  python36 python3-devel gcc pcre-devel zlib-devel make net-tools<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> nginx-1.13.7.tar.gz  /opt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#安装nginx</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> tar -zxf /opt/nginx-1.13.7.tar.gz -C /opt  <span class=o>&amp;&amp;</span> <span class=nb>cd</span> /opt/nginx-1.13.7 <span class=o>&amp;&amp;</span> ./configure --prefix<span class=o>=</span>/usr/local/nginx <span class=o>&amp;&amp;</span> make <span class=o>&amp;&amp;</span> make install <span class=o>&amp;&amp;</span> ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx<span class=err>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 构建基础镜像</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>.</span> <span class=n>-t</span> <span class=nb>centos-python3</span><span class=n>-nginx</span><span class=err>:</span><span class=n>v1</span> <span class=o>-f</span> <span class=nb>Dockerfile-base</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>tag</span> <span class=nb>centos-python3</span><span class=n>-nginx</span><span class=err>:</span><span class=n>v1</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>base</span><span class=p>/</span><span class=nb>centos-python3</span><span class=n>-nginx</span><span class=err>:</span><span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>push</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>base</span><span class=p>/</span><span class=nb>centos-python3</span><span class=n>-nginx</span><span class=err>:</span><span class=n>v1</span>
</span></span></code></pre></div><h6 id=简化dockerfile>简化Dockerfile<a hidden class=anchor aria-hidden=true href=#简化dockerfile>#</a></h6><p><code>dockerfiles/myblog/Dockerfile-optimized</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># This my first django Dockerfile</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Version 1.0</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Base images 基础镜像</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> centos-python3-nginx:v1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#MAINTAINER 维护者信息</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>LABEL</span> <span class=nv>maintainer</span><span class=o>=</span><span class=s2>&#34;inspur_lyx@hotmail.com&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#工作目录</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /opt/myblog</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#拷贝文件至工作目录</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> cp myblog.conf /usr/local/nginx/conf/myblog.conf<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#安装依赖的插件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod +x run.sh <span class=o>&amp;&amp;</span> rm -rf ~/.cache/pip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#EXPOSE 映射端口</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8002</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#容器启动时执行命令</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;./run.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>.</span> <span class=n>-t</span> <span class=n>myblog</span> <span class=o>-f</span> <span class=nb>Dockerfile-optimized</span>
</span></span></code></pre></div><h6 id=运行mysql>运行mysql<a hidden class=anchor aria-hidden=true href=#运行mysql>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=n>-p</span> <span class=n>3306</span><span class=err>:</span><span class=n>3306</span> <span class=p>-</span><span class=n>-name</span> <span class=n>mysql</span>  <span class=n>-v</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=nb>mysql-data</span><span class=p>/</span><span class=err>:</span><span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>lib</span><span class=p>/</span><span class=n>mysql</span> <span class=n>-e</span> <span class=n>MYSQL_DATABASE</span><span class=p>=</span><span class=n>myblog</span> <span class=n>-e</span> <span class=n>MYSQL_ROOT_PASSWORD</span><span class=p>=</span><span class=n>123456</span> <span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看数据库</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>mysql</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=c>#/ mysql -uroot -p123456</span>
</span></span><span class=line><span class=cl><span class=c>#/ show databases;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## navicator连接</span>
</span></span></code></pre></div><h6 id=启动django应用>启动Django应用<a hidden class=anchor aria-hidden=true href=#启动django应用>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 启动容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=n>-p</span> <span class=n>8002</span><span class=err>:</span><span class=n>8002</span> <span class=p>-</span><span class=n>-name</span> <span class=n>myblog</span> <span class=n>-e</span> <span class=n>MYSQL_HOST</span><span class=p>=</span><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span> <span class=n>-e</span> <span class=n>MYSQL_USER</span><span class=p>=</span><span class=n>root</span> <span class=n>-e</span> <span class=n>MYSQL_PASSWD</span><span class=p>=</span><span class=n>123456</span>  <span class=n>myblog</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## migrate</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=c>#/ python3 manage.py makemigrations</span>
</span></span><span class=line><span class=cl><span class=c>#/ python3 manage.py migrate</span>
</span></span><span class=line><span class=cl><span class=c>#/ python3 manage.py createsuperuser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 创建超级用户</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>python3</span> <span class=n>manage</span><span class=p>.</span><span class=n>py</span> <span class=n>createsuperuser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 收集静态文件</span>
</span></span><span class=line><span class=cl><span class=c>## $ docker exec -ti myblog python3 manage.py collectstatic</span>
</span></span></code></pre></div><p>访问62.234.214.206:8002/admin</p><p>构建镜像，替换默认编码：</p><p><code>dockerfiles/mysql/my.cnf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>cat </span><span class=n>my</span><span class=p>.</span><span class=n>cnf</span>
</span></span><span class=line><span class=cl><span class=no>[mysqld]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>=</span><span class=n>root</span>
</span></span><span class=line><span class=cl><span class=nb>character-set</span><span class=n>-server</span><span class=p>=</span><span class=n>utf8</span>
</span></span><span class=line><span class=cl><span class=n>lower_case_table_names</span><span class=p>=</span><span class=n>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>[client]</span>
</span></span><span class=line><span class=cl><span class=nb>default-character</span><span class=n>-set</span><span class=p>=</span><span class=n>utf8</span>
</span></span><span class=line><span class=cl><span class=no>[mysql]</span>
</span></span><span class=line><span class=cl><span class=nb>default-character</span><span class=n>-set</span><span class=p>=</span><span class=n>utf8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>!</span><span class=n>includedir</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=n>conf</span><span class=p>.</span><span class=n>d</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=p>!</span><span class=n>includedir</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=n>mysql</span><span class=p>.</span><span class=n>conf</span><span class=p>.</span><span class=n>d</span><span class=p>/</span>
</span></span></code></pre></div><p><code>dockerfiles/mysql/Dockerfile</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mysql:5.7</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> my.cnf /etc/mysql/my.cnf<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>## CMD或者ENTRYPOINT默认继承</span><span class=err>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>.</span> <span class=n>-t</span> <span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7-utf8</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>tag</span> <span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7-utf8</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7-utf8</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>push</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>16</span><span class=p>.</span><span class=n>3</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7-utf8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 删除旧的mysql容器，使用新镜像启动,不用再次初始化</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>rm </span><span class=o>-f</span> <span class=n>mysql</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>rm </span><span class=n>-rf</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=nb>mysql-data</span><span class=p>/*</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=n>-p</span> <span class=n>3306</span><span class=err>:</span><span class=n>3306</span> <span class=p>-</span><span class=n>-name</span> <span class=n>mysql</span> <span class=n>-v</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=nb>mysql-data</span><span class=p>/</span><span class=err>:</span><span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>lib</span><span class=p>/</span><span class=n>mysql</span> <span class=n>-e</span> <span class=n>MYSQL_DATABASE</span><span class=p>=</span><span class=n>myblog</span> <span class=n>-e</span> <span class=n>MYSQL_ROOT_PASSWORD</span><span class=p>=</span><span class=n>123456</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7-utf8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 重新migrate</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=c>#/ python3 manage.py makemigrations</span>
</span></span><span class=line><span class=cl><span class=c>#/ python3 manage.py migrate</span>
</span></span><span class=line><span class=cl><span class=c>#/ python3 manage.py createsuperuser</span>
</span></span></code></pre></div><h4 id=实现原理--录屏>实现原理 录屏！！！<a hidden class=anchor aria-hidden=true href=#实现原理--录屏>#</a></h4><p>虚拟化核心需要解决的问题：资源隔离与资源限制</p><ul><li>虚拟机硬件虚拟化技术， 通过一个 hypervisor 层实现对资源的彻底隔离。</li><li>容器则是操作系统级别的虚拟化，利用的是内核的 Cgroup 和 Namespace 特性，此功能完全通过软件实现。</li></ul><h6 id=namespace-资源隔离>Namespace 资源隔离<a hidden class=anchor aria-hidden=true href=#namespace-资源隔离>#</a></h6><p>命名空间是全局资源的一种抽象，将资源放到不同的命名空间中，各个命名空间中的资源是相互隔离的。 通俗来讲，就是docker在启动一个容器的时候，会调用Linux Kernel Namespace的接口，来创建一块虚拟空间，创建的时候，可以支持设置下面这几种（可以随意选择）,docker默认都设置。</p><ul><li>pid：用于进程隔离（PID：进程ID）</li><li>net：管理网络接口（NET：网络）</li><li>ipc：管理对 IPC 资源的访问（IPC：进程间通信（信号量、消息队列和共享内存））</li><li>mnt：管理文件系统挂载点（MNT：挂载）</li><li>uts：隔离主机名和域名</li><li>user：隔离用户和用户组（3.8以后的内核才支持）</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>setNamespaces</span><span class=p>(</span><span class=nx>daemon</span> <span class=o>*</span><span class=nx>Daemon</span><span class=p>,</span> <span class=nx>s</span> <span class=o>*</span><span class=nx>specs</span><span class=p>.</span><span class=nx>Spec</span><span class=p>,</span> <span class=nx>c</span> <span class=o>*</span><span class=nx>container</span><span class=p>.</span><span class=nx>Container</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// user
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// network
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ipc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// uts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// pid
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>HostConfig</span><span class=p>.</span><span class=nx>PidMode</span><span class=p>.</span><span class=nf>IsContainer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ns</span> <span class=o>:=</span> <span class=nx>specs</span><span class=p>.</span><span class=nx>LinuxNamespace</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span> <span class=s>&#34;pid&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>pc</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>daemon</span><span class=p>.</span><span class=nf>getPidContainer</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>ns</span><span class=p>.</span><span class=nx>Path</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;/proc/%d/ns/pid&#34;</span><span class=p>,</span> <span class=nx>pc</span><span class=p>.</span><span class=nx>State</span><span class=p>.</span><span class=nf>GetPID</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nf>setNamespace</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>ns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>HostConfig</span><span class=p>.</span><span class=nx>PidMode</span><span class=p>.</span><span class=nf>IsHost</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>oci</span><span class=p>.</span><span class=nf>RemoveNamespace</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>specs</span><span class=p>.</span><span class=nf>LinuxNamespaceType</span><span class=p>(</span><span class=s>&#34;pid&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ns</span> <span class=o>:=</span> <span class=nx>specs</span><span class=p>.</span><span class=nx>LinuxNamespace</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span> <span class=s>&#34;pid&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>setNamespace</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>ns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h6 id=cgroup-资源限制>CGroup 资源限制<a hidden class=anchor aria-hidden=true href=#cgroup-资源限制>#</a></h6><p>通过namespace可以保证容器之间的隔离，但是无法控制每个容器可以占用多少资源， 如果其中的某一个容器正在执行 CPU 密集型的任务，那么就会影响其他容器中任务的性能与执行效率，导致多个容器相互影响并且抢占资源。如何对多个容器的资源使用进行限制就成了解决进程虚拟资源隔离之后的主要问题。</p><p><img loading=lazy src=images%5ccgroup.png alt></p><p>Control Groups（简称 CGroups）就是能够隔离宿主机器上的物理资源，例如 CPU、内存、磁盘 I/O 和网络带宽。每一个 CGroup 都是一组被相同的标准和参数限制的进程。而我们需要做的，其实就是把容器这个进程加入到指定的Cgroup中。深入理解CGroup，请<a href=!%5Bimage-20200323195718300%5D(C:%5CUsers%5Cliyongxin%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200323195718300.png)>点此</a>。</p><h6 id=unionfs-联合文件系统>UnionFS 联合文件系统<a hidden class=anchor aria-hidden=true href=#unionfs-联合文件系统>#</a></h6><p>Linux namespace和cgroup分别解决了容器的资源隔离与资源限制，那么容器是很轻量的，通常每台机器中可以运行几十上百个容器， 这些个容器是共用一个image，还是各自将这个image复制了一份，然后各自独立运行呢？ 如果每个容器之间都是全量的文件系统拷贝，那么会导致至少如下问题：</p><ul><li>运行容器的速度会变慢</li><li>容器和镜像对宿主机的磁盘空间的压力</li></ul><p>怎么解决这个问题&mdash;&mdash;Docker的存储驱动</p><ul><li>镜像分层存储</li><li>UnionFS</li></ul><p>Docker 镜像是由一系列的层组成的，每层代表 Dockerfile 中的一条指令，比如下面的 Dockerfile 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu:15.04</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> make /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> python /app/app.py<span class=err>
</span></span></span></code></pre></div><p>这里的 Dockerfile 包含4条命令，其中每一行就创建了一层，下面显示了上述Dockerfile构建出来的镜像运行的容器层的结构：</p><p><img loading=lazy src=images%5ccontainer-layers.jpg alt></p><p>镜像就是由这些层一层一层堆叠起来的，镜像中的这些层都是只读的，当我们运行容器的时候，就可以在这些基础层至上添加新的可写层，也就是我们通常说的<code>容器层</code>，对于运行中的容器所做的所有更改（比如写入新文件、修改现有文件、删除文件）都将写入这个容器层。</p><p>对容器层的操作，主要利用了写时复制（CoW）技术。CoW就是copy-on-write，表示只在需要写时才去复制，这个是针对已有文件的修改场景。 CoW技术可以让所有的容器共享image的文件系统，所有数据都从image中读取，只有当要对文件进行写操作时，才从image里把要写的文件复制到自己的文件系统进行修改。所以无论有多少个容器共享同一个image，所做的写操作都是对从image中复制到自己的文件系统中的复本上进行，并不会修改image的源文件，且多个容器操作同一个文件，会在每个容器的文件系统里生成一个复本，每个容器修改的都是自己的复本，相互隔离，相互不影响。使用CoW可以有效的提高磁盘的利用率。</p><p><img loading=lazy src=images%5csharing-layers.jpg alt></p><p>镜像中每一层的文件都是分散在不同的目录中的，如何把这些不同目录的文件整合到一起呢？</p><p>UnionFS 其实是一种为 Linux 操作系统设计的用于把多个文件系统联合到同一个挂载点的文件系统服务。 它能够将不同文件夹中的层联合（Union）到了同一个文件夹中，整个联合的过程被称为联合挂载（Union Mount）。</p><p><img loading=lazy src=images%5caufs.png alt></p><p>上图是AUFS的实现，AUFS是作为Docker存储驱动的一种实现，Docker 还支持了不同的存储驱动，包括 aufs、devicemapper、overlay2、zfs 和 Btrfs 等等，在最新的 Docker 中，overlay2 取代了 aufs 成为了推荐的存储驱动，但是在没有 overlay2 驱动的机器上仍然会使用 aufs 作为 Docker 的默认驱动。</p><h4 id=docker网络--------录屏>Docker网络 录屏！！！<a hidden class=anchor aria-hidden=true href=#docker网络--------录屏>#</a></h4><p>docker容器是一块具有隔离性的虚拟系统，容器内可以有自己独立的网络空间，</p><ul><li>多个容器之间是如何实现通信的呢？</li><li>容器和宿主机之间又是如何实现的通信呢？</li><li>使用-p参数是怎么实现的端口映射?</li></ul><p>带着我们就这些问题，我们来学习一下docker的网络模型，最后我会通过抓包的方式，给大家演示一下数据包在容器和宿主机之间的转换过程。</p><h5 id=网络模式>网络模式<a hidden class=anchor aria-hidden=true href=#网络模式>#</a></h5><p>我们在使用docker run创建Docker容器时，可以用&ndash;net选项指定容器的网络模式，Docker有以下4种网络模式：</p><ul><li><p>bridge模式，使用&ndash;net=bridge指定，默认设置</p></li><li><p>host模式，使用&ndash;net=host指定，容器内部网络空间共享宿主机的空间，效果类似直接在宿主机上启动一个进程，端口信息和宿主机共用。</p></li><li><p>container模式，使用&ndash;net=container:NAME_or_ID指定</p><p>指定容器与特定容器共享网络命名空间</p></li><li><p>none模式，使用&ndash;net=none指定</p><p>网络模式为空，即仅保留网络命名空间，但是不做任何网络相关的配置(网卡、IP、路由等)</p></li></ul><h5 id=bridge模式>bridge模式<a hidden class=anchor aria-hidden=true href=#bridge模式>#</a></h5><p>那我们之前在演示创建docker容器的时候其实是没有指定的网络模式的，如果不指定的话默认就会使用bridge模式，bridge本意是桥的意思，其实就是网桥模式，那我们怎么理解网桥，如果需要做类比的话，我们可以把网桥看成一个二层的交换机设备，我们来看下这张图：</p><p>交换机通信简图</p><p><img loading=lazy src=images%5c%e4%ba%a4%e6%8d%a2%e6%9c%ba.png alt></p><p>网桥模式示意图</p><p><img loading=lazy src=images%5cdocker-bridge.jpeg alt></p><p>网桥在哪，查看网桥</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>yum</span> <span class=n>install</span> <span class=n>-y</span> <span class=nb>bridge-utils</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>brctl</span> <span class=n>show</span>
</span></span><span class=line><span class=cl><span class=n>bridge</span> <span class=n>name</span>     <span class=n>bridge</span> <span class=n>id</span>               <span class=n>STP</span> <span class=n>enabled</span>     <span class=n>interfaces</span>
</span></span><span class=line><span class=cl><span class=n>docker0</span>         <span class=n>8000</span><span class=p>.</span><span class=n>0242b5fbe57b</span>       <span class=n>no</span>              <span class=n>veth3a496ed</span>
</span></span></code></pre></div><p>有了网桥之后，那我们看下docker在启动一个容器的时候做了哪些事情才能实现容器间的互联互通</p><p>Docker 创建一个容器的时候，会执行如下操作：</p><ul><li>创建一对虚拟接口/网卡，也就是veth pair；</li><li>本地主机一端桥接 到默认的 docker0 或指定网桥上，并具有一个唯一的名字，如 veth9953b75；</li><li>容器一端放到新启动的容器内部，并修改名字作为 eth0，这个网卡/接口只在容器的命名空间可见；</li><li>从网桥可用地址段中（也就是与该bridge对应的network）获取一个空闲地址分配给容器的 eth0</li><li>配置默认路由到网桥</li></ul><p>那整个过程其实是docker自动帮我们完成的，清理掉所有容器，来验证。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 清掉所有容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>rm </span><span class=o>-f</span> <span class=p>`</span><span class=n>docker</span> <span class=nb>ps </span><span class=n>-aq</span><span class=p>`</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>ps
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=p>$</span> <span class=n>brctl</span> <span class=n>show</span> <span class=c># 查看网桥中的接口，目前没有</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 创建测试容器test1</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=p>-</span><span class=n>-name</span> <span class=n>test1</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>brctl</span> <span class=n>show</span> <span class=c># 查看网桥中的接口，已经把test1的veth端接入到网桥中</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>ip</span> <span class=n>a</span> <span class=p>|</span><span class=n>grep</span> <span class=n>veth</span> <span class=c># 已在宿主机中可以查看到</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>test1</span> <span class=n>sh</span> 
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># ifconfig  # 查看容器的eth0网卡及分配的容器ip</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># route -n  # 观察默认网关都指向了网桥的地址，即所有流量都转向网桥，等于是在veth pair接通了网线</span>
</span></span><span class=line><span class=cl><span class=n>Kernel</span> <span class=n>IP</span> <span class=n>routing</span> <span class=n>table</span>
</span></span><span class=line><span class=cl><span class=n>Destination</span>     <span class=n>Gateway</span>         <span class=n>Genmask</span>         <span class=n>Flags</span> <span class=n>Metric</span> <span class=k>Ref</span>    <span class=n>Use</span> <span class=n>Iface</span>
</span></span><span class=line><span class=cl><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span>         <span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span>      <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span>         <span class=n>UG</span>    <span class=n>0</span>      <span class=n>0</span>        <span class=n>0</span> <span class=n>eth0</span>
</span></span><span class=line><span class=cl><span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span>      <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span>         <span class=n>255</span><span class=p>.</span><span class=n>255</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span>     <span class=n>U</span>     <span class=n>0</span>      <span class=n>0</span>        <span class=n>0</span> <span class=n>eth0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 再来启动一个测试容器，测试容器间的通信</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=p>-</span><span class=n>-name</span> <span class=n>test2</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>test</span> <span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># sed -i &#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39; /etc/apk/repositories</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># apk add curl</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># curl 172.17.0.8:80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 为啥可以通信，因为两个容器是接在同一个网桥中的，通信其实是通过mac地址和端口的的记录来做转发的。test1访问test2，通过test1的eth0发送ARP广播，网桥会维护一份mac映射表，我们可以大概通过命令来看一下，</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>brctl</span> <span class=n>showmacs</span> <span class=n>docker0</span>
</span></span><span class=line><span class=cl><span class=c>## 这些mac地址是主机端的veth网卡对应的mac，可以查看一下</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>ip</span> <span class=n>a</span> 
</span></span></code></pre></div><p>我们如何知道网桥上的这些虚拟网卡与容器端是如何对应？</p><p>通过ifindex，网卡索引号</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 查看test1容器的网卡索引</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>test1</span> <span class=nb>cat </span><span class=p>/</span><span class=n>sys</span><span class=p>/</span><span class=n>class</span><span class=p>/</span><span class=n>net</span><span class=p>/</span><span class=n>eth0</span><span class=p>/</span><span class=n>ifindex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 主机中找到虚拟网卡后面这个@ifxx的值，如果是同一个值，说明这个虚拟网卡和这个容器的eth0网卡是配对的。</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>ip</span> <span class=n>a</span> <span class=p>|</span><span class=n>grep</span> <span class=nv>@if</span>
</span></span></code></pre></div><p>整理脚本，快速查看对应：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=k>for</span> <span class=n>container</span> <span class=k>in</span> <span class=p>$(</span><span class=n>docker</span> <span class=nb>ps </span><span class=n>-q</span><span class=p>);</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>iflink</span><span class=p>=`</span><span class=n>docker</span> <span class=n>exec</span> <span class=n>-it</span> <span class=nv>$container</span> <span class=n>sh</span> <span class=n>-c</span> <span class=s1>&#39;cat /sys/class/net/eth0/iflink&#39;</span><span class=p>`</span>
</span></span><span class=line><span class=cl>    <span class=n>iflink</span><span class=p>=`</span><span class=nb>echo </span><span class=nv>$iflink</span><span class=p>|</span><span class=n>tr</span> <span class=n>-d</span> <span class=s1>&#39;\r&#39;</span><span class=p>`</span>
</span></span><span class=line><span class=cl>    <span class=n>veth</span><span class=p>=`</span><span class=n>grep</span> <span class=n>-l</span> <span class=nv>$iflink</span> <span class=p>/</span><span class=n>sys</span><span class=p>/</span><span class=n>class</span><span class=p>/</span><span class=n>net</span><span class=p>/</span><span class=n>veth</span><span class=p>*/</span><span class=n>ifindex</span><span class=p>`</span>
</span></span><span class=line><span class=cl>    <span class=n>veth</span><span class=p>=`</span><span class=nb>echo </span><span class=nv>$veth</span><span class=p>|</span><span class=n>sed</span> <span class=n>-e</span> <span class=s1>&#39;s;^.*net/\(.*\)/ifindex$;\1;&#39;</span><span class=p>`</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo </span><span class=nv>$container</span><span class=err>:</span><span class=nv>$veth</span>
</span></span><span class=line><span class=cl><span class=n>done</span>
</span></span></code></pre></div><p>上面我们讲解了容器之间的通信，那么容器与宿主机的通信是如何做的？</p><p><img loading=lazy src=images%5c2017-11-30-docker-network-topology.png alt></p><p>添加端口映射：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 启动容器的时候通过-p参数添加宿主机端口与容器内部服务端口的映射</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-name</span> <span class=n>test</span> <span class=n>-d</span> <span class=n>-p</span> <span class=n>8088</span><span class=err>:</span><span class=n>80</span> <span class=n>nginx</span><span class=err>:</span><span class=n>alpine</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>localhost</span><span class=err>:</span><span class=n>8088</span>
</span></span></code></pre></div><p>端口映射如何实现的？先来回顾iptables链表图</p><p><img loading=lazy src=images%5ciptables.png alt></p><p>访问本机的8088端口，数据包会从流入方向进入本机，因此涉及到PREROUTING和INPUT链，我们是通过做宿主机与容器之间加的端口映射，所以肯定会涉及到端口转换，那哪个表是负责存储端口转换信息的呢，就是nat表，负责维护网络地址转换信息的。因此我们来查看一下PREROUTING链的nat表：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>iptables</span> <span class=n>-t</span> <span class=n>nat</span> <span class=n>-nvL</span> <span class=n>PREROUTING</span>
</span></span><span class=line><span class=cl><span class=n>Chain</span> <span class=n>PREROUTING</span> <span class=p>(</span><span class=n>policy</span> <span class=n>ACCEPT</span> <span class=n>159</span> <span class=n>packets</span><span class=p>,</span> <span class=n>20790</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=n>pkts</span> <span class=n>bytes</span> <span class=n>target</span>     <span class=n>prot</span> <span class=n>opt</span> <span class=k>in</span>     <span class=n>out</span>     <span class=n>source</span>               <span class=n>destination</span>
</span></span><span class=line><span class=cl>    <span class=n>3</span>   <span class=n>156</span> <span class=n>DOCKER</span>     <span class=n>all</span>  <span class=p>--</span>  <span class=p>*</span>      <span class=p>*</span>       <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>            <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>            <span class=n>ADDRTYPE</span> <span class=n>match</span> <span class=nb>dst-type</span> <span class=n>LOCAL</span>
</span></span></code></pre></div><p>规则利用了iptables的addrtype拓展，匹配网络类型为本地的包，如何确定哪些是匹配本地，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>ip</span> <span class=n>route</span> <span class=n>show</span> <span class=n>table</span> <span class=n>local</span> <span class=nb>type </span><span class=n>local</span>
</span></span><span class=line><span class=cl><span class=n>local</span> <span class=n>127</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>8</span> <span class=n>dev</span> <span class=n>lo</span> <span class=n>proto</span> <span class=n>kernel</span> <span class=n>scope</span> <span class=n>host</span> <span class=n>src</span> <span class=n>127</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>local</span> <span class=n>127</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span> <span class=n>dev</span> <span class=n>lo</span> <span class=n>proto</span> <span class=n>kernel</span> <span class=n>scope</span> <span class=n>host</span> <span class=n>src</span> <span class=n>127</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>local</span> <span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span> <span class=n>dev</span> <span class=n>docker0</span> <span class=n>proto</span> <span class=n>kernel</span> <span class=n>scope</span> <span class=n>host</span> <span class=n>src</span> <span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>local</span> <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>136</span><span class=p>.</span><span class=n>133</span> <span class=n>dev</span> <span class=n>ens33</span> <span class=n>proto</span> <span class=n>kernel</span> <span class=n>scope</span> <span class=n>host</span> <span class=n>src</span> <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>136</span><span class=p>.</span><span class=n>133</span>
</span></span></code></pre></div><p>也就是说目标地址类型匹配到这些的，会转发到我们的TARGET中，TARGET是动作，意味着对符合要求的数据包执行什么样的操作，最常见的为ACCEPT或者DROP，此处的TARGET为DOCKER，很明显DOCKER不是标准的动作，那DOCKER是什么呢？我们通常会定义自定义的链，这样把某类对应的规则放在自定义链中，然后把自定义的链绑定到标准的链路中，因此此处DOCKER 是自定义的链。那我们现在就来看一下DOCKER这个自定义链上的规则。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>iptables</span> <span class=n>-t</span> <span class=n>nat</span> <span class=n>-nvL</span> <span class=n>DOCKER</span>
</span></span><span class=line><span class=cl><span class=n>Chain</span> <span class=n>DOCKER</span> <span class=p>(</span><span class=n>2</span> <span class=n>references</span><span class=p>)</span>                                                                                                
</span></span><span class=line><span class=cl> <span class=n>pkts</span> <span class=n>bytes</span> <span class=n>target</span>     <span class=n>prot</span> <span class=n>opt</span> <span class=k>in</span>     <span class=n>out</span>     <span class=n>source</span>               <span class=n>destination</span>                                            
</span></span><span class=line><span class=cl>    <span class=n>0</span>     <span class=n>0</span> <span class=k>RETURN</span>     <span class=n>all</span>  <span class=p>--</span>  <span class=n>docker0</span> <span class=p>*</span>       <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>            <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>                                             
</span></span><span class=line><span class=cl>    <span class=n>0</span>     <span class=n>0</span> <span class=n>DNAT</span>       <span class=n>tcp</span>  <span class=p>--</span>  <span class=p>!</span><span class=n>docker0</span> <span class=p>*</span>       <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>            <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>            <span class=n>tcp</span> <span class=n>dpt</span><span class=err>:</span><span class=n>8088</span> <span class=n>to</span><span class=err>:</span><span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>2</span><span class=err>:</span><span class=n>80</span> 
</span></span></code></pre></div><p>此条规则就是对主机收到的目的端口为8088的tcp流量进行DNAT转换，将流量发往172.17.0.2:80，172.17.0.2地址是不是就是我们上面创建的Docker容器的ip地址，流量走到网桥上了，后面就走网桥的转发就ok了。
所以，外界只需访问192.168.136.133:8088就可以访问到容器中的服务了。</p><p>数据包在出口方向走POSTROUTING链，我们查看一下规则：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>iptables</span> <span class=n>-t</span> <span class=n>nat</span> <span class=n>-nvL</span> <span class=n>POSTROUTING</span>
</span></span><span class=line><span class=cl><span class=n>Chain</span> <span class=n>POSTROUTING</span> <span class=p>(</span><span class=n>policy</span> <span class=n>ACCEPT</span> <span class=n>1099</span> <span class=n>packets</span><span class=p>,</span> <span class=n>67268</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=n>pkts</span> <span class=n>bytes</span> <span class=n>target</span>     <span class=n>prot</span> <span class=n>opt</span> <span class=k>in</span>     <span class=n>out</span>     <span class=n>source</span>               <span class=n>destination</span>
</span></span><span class=line><span class=cl>   <span class=n>86</span>  <span class=n>5438</span> <span class=n>MASQUERADE</span>  <span class=n>all</span>  <span class=p>--</span>  <span class=p>*</span>      <span class=p>!</span><span class=n>docker0</span>  <span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>16</span>        <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>0</span>
</span></span><span class=line><span class=cl>    <span class=n>0</span>     <span class=n>0</span> <span class=n>MASQUERADE</span>  <span class=n>tcp</span>  <span class=p>--</span>  <span class=p>*</span>      <span class=p>*</span>       <span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>4</span>           <span class=n>172</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>4</span>           <span class=n>tcp</span> <span class=n>dpt</span><span class=err>:</span><span class=n>80</span>
</span></span></code></pre></div><p>大家注意MASQUERADE这个动作是什么意思，其实是一种更灵活的SNAT，把源地址转换成主机的出口ip地址，那解释一下这条规则的意思:</p><p>这条规则会将源地址为172.17.0.0/16的包（也就是从Docker容器产生的包），并且不是从docker0网卡发出的，进行源地址转换，转换成主机网卡的地址。大概的过程就是ACK的包在容器里面发出来，会路由到网桥docker0，网桥根据宿主机的路由规则会转给宿主机网卡eth0，这时候包就从docker0网卡转到eth0网卡了，并从eth0网卡发出去，这时候这条规则就会生效了，把源地址换成了eth0的ip地址。</p><blockquote><p>注意一下，刚才这个过程涉及到了网卡间包的传递，那一定要打开主机的ip_forward转发服务，要不然包转不了，服务肯定访问不到。</p></blockquote><h6 id=抓包演示>抓包演示<a hidden class=anchor aria-hidden=true href=#抓包演示>#</a></h6><p>我们先想一下，我们要抓哪个网卡的包</p><ul><li><p>首先访问宿主机的8088端口，我们抓一下宿主机的eth0</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>tcpdump</span> <span class=n>-i</span> <span class=n>eth0</span> <span class=n>port</span> <span class=n>8088</span> <span class=n>-w</span> <span class=n>host</span><span class=p>.</span><span class=n>cap</span>
</span></span></code></pre></div></li><li><p>然后最终包会流入容器内，那我们抓一下容器内的eth0网卡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># 容器内安装一下tcpdump</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>sed</span> <span class=n>-i</span> <span class=s1>&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>apk</span><span class=p>/</span><span class=n>repositories</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>apk</span> <span class=n>add</span> <span class=n>tcpdump</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>tcpdump</span> <span class=n>-i</span> <span class=n>eth0</span> <span class=n>port</span> <span class=n>80</span> <span class=n>-w</span> <span class=n>container</span><span class=p>.</span><span class=n>cap</span>
</span></span></code></pre></div></li></ul><p>到另一台机器访问一下，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>8088</span><span class=p>/</span>
</span></span></code></pre></div><p>停止抓包，拷贝容器内的包到宿主机</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>cp </span><span class=n>test</span><span class=err>:</span><span class=p>/</span><span class=n>root</span><span class=p>/</span><span class=n>container</span><span class=p>.</span><span class=n>cap</span> <span class=p>/</span><span class=n>root</span><span class=p>/</span>
</span></span></code></pre></div><p>把抓到的内容拷贝到本地，使用wireshark进行分析。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>scp</span> <span class=n>root</span><span class=nv>@172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=p>/</span><span class=n>root</span><span class=p>/*.</span><span class=n>cap</span> <span class=p>/</span><span class=n>d</span><span class=p>/</span><span class=n>packages</span>
</span></span></code></pre></div><p>（wireshark合并包进行分析）</p><p><img loading=lazy src=images%5cdocker-dnat.jpeg alt></p><p><img loading=lazy src=images%5cdocker-snat.jpeg alt></p><p>进到容器内的包做DNAT，出去的包做SNAT，这样对外面来讲，根本就不知道机器内部是谁提供服务，其实这就和一个内网多个机器公用一个外网IP地址上网的效果是一样的，对吧，那这也属于NAT功能的一个常见的应用场景。</p><h5 id=host模式>Host模式<a hidden class=anchor aria-hidden=true href=#host模式>#</a></h5><p>容器内部不会创建网络空间，共享宿主机的网络空间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-net</span> <span class=n>host</span> <span class=n>-d</span> <span class=p>-</span><span class=n>-name</span> <span class=n>mysql</span> <span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7</span>
</span></span></code></pre></div><h5 id=conatiner模式>Conatiner模式<a hidden class=anchor aria-hidden=true href=#conatiner模式>#</a></h5><p>这个模式指定新创建的容器和已经存在的一个容器共享一个 Network Namespace，而不是和宿主机共享。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过 lo 网卡设备通信。</p><p><img loading=lazy src=images%5cdocker-network-container.jpeg alt></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 启动测试容器，共享mysql的网络空间</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=n>-ti</span> <span class=p>-</span><span class=n>-rm</span> <span class=p>-</span><span class=n>-net</span><span class=p>=</span><span class=n>container</span><span class=err>:</span><span class=n>mysql</span> <span class=n>busybox</span> <span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># ip a</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># netstat -tlp|grep 3306</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># telnet localhost 3306</span>
</span></span></code></pre></div><h4 id=实用技巧>实用技巧<a hidden class=anchor aria-hidden=true href=#实用技巧>#</a></h4><ol><li><p>清理主机上所有退出的容器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>rm </span> <span class=p>$(</span><span class=n>docker</span> <span class=nb>ps </span><span class=n>-aq</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>调试或者排查容器启动错误</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 若有时遇到容器启动失败的情况，可以先使用相同的镜像启动一个临时容器，先进入容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=p>-</span><span class=n>-rm</span> <span class=p>&lt;</span><span class=n>image_id</span><span class=p>&gt;</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=c>## 进入容器后，手动执行该容器对应的ENTRYPOINT或者CMD命令，这样即使出错，容器也不会退出，因为bash作为1号进程，我们只要不退出容器，该容器就不会自动退出</span>
</span></span></code></pre></div></li></ol><h4 id=本章小结>本章小结<a hidden class=anchor aria-hidden=true href=#本章小结>#</a></h4><ol><li><p>为了解决软件交付过程中的环境依赖，同时提供一种更加轻量的虚拟化技术，Docker出现了</p></li><li><p>2013年诞生，15年开始迅速发展，从17.03月开始，使用时间日期管理版本，稳定版以每季度为准</p></li><li><p>Docker是一种CS架构的软件产品，可以把代码及依赖打包成镜像，作为交付介质，并且把镜像启动成为容器，提供容器生命周期的管理</p></li><li><p>使用yum部署docker，启动后通过操作docker这个命令行，自动调用docker daemon完成容器相关操作</p></li><li><p>常用操作</p><ul><li>systemctl start|stop|restart docker</li><li>docker build | pull -> docker tag -> docker push</li><li>docker run &ndash;name my-demo -d -p 8080:80 -v /opt/data:/data demo:v20200327</li><li>docker cp /path/a.txt mycontainer:/opt</li><li>docker exec -ti mycontainer /bin/sh</li><li>docker logs -f mycontainer</li></ul></li><li><p>通过dockerfile构建业务镜像，先使用基础镜像，然后通过一系列的指令把我们的业务应用所需要的运行环境和依赖都打包到镜像中，然后通过CMD或者ENTRYPOINT指令把镜像启动时的入口制定好，完成封装即可。有点类似于，先找来一个空的集装箱(基础镜像)，然后把项目依赖的服务都扔到集装箱中，然后设置好服务的启动入口，关闭箱门，即完成了业务镜像的制作。</p></li><li><p>容器的实现依赖于内核模块提供的namespace和control-group的功能，通过namespace创建一块虚拟空间，空间内实现了各类资源(进程、网络、文件系统)的隔离，提供control-group实现了对隔离的空间的资源使用的限制。</p></li><li><p>docker镜像使用分层的方式进行存储，根据主机的存储驱动的不同，实现方式会不同，kernel在3.10.0-514以上自动支持overlay2 存储驱动，也是目前Docker推荐的方式。</p></li><li><p>得益于分层存储的模式，多个容器可以通过copy-on-write的策略，在镜像的最上层加一个可写层，实现一个镜像快速启动多个容器的场景</p></li><li><p>docker的网络模式分为4种，最常用的为bridge和host模式。bridge模式通过docker0网桥，启动容器的时候通过创建一对虚拟网卡，将容器连接在桥上，同时维护了虚拟网卡与网桥端口的关系，实现容器间的通信。容器与宿主机之间的通信通过iptables端口映射的方式，docker利用iptables的PREROUTING和POSTROUTING的nat功能，实现了SNAT与DNAT，使得容器内部的服务被完美的保护起来。</p></li></ol><h3 id=第二章--kubernetes实践之旅----录屏>第二章 Kubernetes实践之旅 录屏！！！<a hidden class=anchor aria-hidden=true href=#第二章--kubernetes实践之旅----录屏>#</a></h3><p>本章学习kubernetes的架构及工作流程，重点介绍如何使用Deployment管理Pod生命周期，实现服务不中断的滚动更新，通过服务发现来实现集群内部的服务间访问，并通过ingress-nginx实现外部使用域名访问集群内部的服务。同时介绍基于EFK如何搭建Kubernetes集群的日志收集系统。</p><p>学完本章，我们的Django demo项目已经可以运行在k8s集群中，同时我们可以使用域名进行服务的访问。</p><ul><li>架构及核心组件介绍</li><li>使用kubeadm快速搭建集群</li><li>运行第一个Pod应用</li><li>Pod进阶</li><li>Pod控制器的使用</li><li>实现服务与Node绑定的几种方式</li><li>负载均衡与服务发现</li><li>使用Ingress实现集群服务的7层代理</li><li>Django项目k8s落地实践</li><li>基于EFK实现kubernetes集群的日志平台（扩展）</li><li>集群认证与授权</li></ul><h4 id=纯容器模式的问题>纯容器模式的问题<a hidden class=anchor aria-hidden=true href=#纯容器模式的问题>#</a></h4><ol><li>业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？</li><li>跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？</li><li>跨主机容器间互相调用，配置如何写？写死固定IP+端口？</li><li>如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？</li><li>容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器?</li><li>如何实现滚动升级保证业务的连续性？</li><li>&mldr;&mldr;</li></ol><h4 id=容器调度管理平台>容器调度管理平台<a hidden class=anchor aria-hidden=true href=#容器调度管理平台>#</a></h4><p>Docker Swarm Mesos Google Kubernetes</p><p>2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀</p><p><a href=https://kubernetes.io/>https://kubernetes.io/</a></p><h4 id=架构图>架构图<a hidden class=anchor aria-hidden=true href=#架构图>#</a></h4><p>区分组件与资源</p><p><img loading=lazy src=images/architecture.png alt></p><h4 id=核心组件>核心组件<a hidden class=anchor aria-hidden=true href=#核心组件>#</a></h4><ul><li><p>ETCD：分布式高性能键值数据库,存储整个集群的所有元数据</p></li><li><p>ApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制</p></li><li><p>Scheduler：调度器,负责把业务容器调度到最合适的Node节点</p></li><li><p>Controller Manager：控制器管理,确保集群资源按照期望的方式运行</p><ul><li>Replication Controller</li><li>Node controller</li><li>ResourceQuota Controller</li><li>Namespace Controller</li><li>ServiceAccount Controller</li><li>Tocken Controller</li><li>Service Controller</li><li>Endpoints Controller</li></ul></li><li><p>kubelet：运行在每运行在每个节点上的主要的“节点代理”个节点上的主要的“节点代理”</p><ul><li>pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。</li><li>容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理.</li><li>容器监控：kubelet 会监控所在节点的资源使用情况，并定时向 master 报告，资源使用数据都是通过 cAdvisor 获取的。知道整个集群所有节点的资源情况，对于 pod 的调度和正常运行至关重要</li></ul></li><li><p>kubectl: 命令行接口，用于对 Kubernetes 集群运行命令 <a href=https://kubernetes.io/zh/docs/reference/kubectl/>https://kubernetes.io/zh/docs/reference/kubectl/</a></p></li><li><p>CNI实现: 通用网络接口, 我们使用flannel来作为k8s集群的网络插件, 实现跨节点通信</p></li></ul><h4 id=工作流程>工作流程<a hidden class=anchor aria-hidden=true href=#工作流程>#</a></h4><p><img loading=lazy src=images%5cprocess.png alt></p><ol><li>用户准备一个资源文件（记录了业务应用的名称、镜像地址等信息），通过调用APIServer执行创建Pod</li><li>APIServer收到用户的Pod创建请求，将Pod信息写入到etcd中</li><li>调度器通过list-watch的方式，发现有新的pod数据，但是这个pod还没有绑定到某一个节点中</li><li>调度器通过调度算法，计算出最适合该pod运行的节点，并调用APIServer，把信息更新到etcd中</li><li>kubelet同样通过list-watch方式，发现有新的pod调度到本机的节点了，因此调用容器运行时，去根据pod的描述信息，拉取镜像，启动容器，同时生成事件信息</li><li>同时，把容器的信息、事件及状态也通过APIServer写入到etcd中</li></ol><h4 id=实践--集群安装-------录屏>实践&ndash;集群安装 录屏！！！<a hidden class=anchor aria-hidden=true href=#实践--集群安装-------录屏>#</a></h4><p>kubeadm <a href=https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/>https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/</a></p><p>《Kubernetes安装手册（非高可用版）》</p><h6 id=核心组件-1>核心组件<a hidden class=anchor aria-hidden=true href=#核心组件-1>#</a></h6><p>静态Pod的方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## etcd、apiserver、controller-manager、kube-scheduler</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=nb>kube-system</span> <span class=n>get</span> <span class=n>po</span>
</span></span></code></pre></div><p>systemd服务方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>systemctl</span> <span class=n>status</span> <span class=n>kubelet</span>
</span></span></code></pre></div><p>kubectl：二进制命令行工具</p><h6 id=理解集群资源>理解集群资源<a hidden class=anchor aria-hidden=true href=#理解集群资源>#</a></h6><p>组件是为了支撑k8s平台的运行，安装好的软件。</p><p>资源是如何去使用k8s的能力的定义。比如，k8s可以使用Pod来管理业务应用，那么Pod就是k8s集群中的一类资源，集群中的所有资源可以提供如下方式查看：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=nb>api-resources</span>
</span></span></code></pre></div><p>如何理解namespace：</p><p>命名空间，集群内一个虚拟的概念，类似于资源池的概念，一个池子里可以有各种资源类型，绝大多数的资源都必须属于某一个namespace。集群初始化安装好之后，会默认有如下几个namespace：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>namespaces</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                   <span class=n>STATUS</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=k>default</span>                <span class=n>Active</span>   <span class=n>84m</span>
</span></span><span class=line><span class=cl><span class=nb>kube-node</span><span class=n>-lease</span>        <span class=n>Active</span>   <span class=n>84m</span>
</span></span><span class=line><span class=cl><span class=nb>kube-public</span>            <span class=n>Active</span>   <span class=n>84m</span>
</span></span><span class=line><span class=cl><span class=nb>kube-system</span>            <span class=n>Active</span>   <span class=n>84m</span>
</span></span><span class=line><span class=cl><span class=nb>kubernetes-dashboard</span>   <span class=n>Active</span>   <span class=n>71m</span>
</span></span></code></pre></div><ul><li>所有NAMESPACED的资源，在创建的时候都需要指定namespace，若不指定，默认会在default命名空间下</li><li>相同namespace下的同类资源不可以重名，不同类型的资源可以重名</li><li>不同namespace下的同类资源可以重名</li><li>通常在项目使用的时候，我们会创建带有业务含义的namespace来做逻辑上的整合</li></ul><h6 id=kubectl的使用>kubectl的使用<a hidden class=anchor aria-hidden=true href=#kubectl的使用>#</a></h6><p>类似于docker，kubectl是命令行工具，用于与APIServer交互，内置了丰富的子命令，功能极其强大。 <a href=https://kubernetes.io/docs/reference/kubectl/overview/>https://kubernetes.io/docs/reference/kubectl/overview/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-h</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>-h</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=n>-h</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=n>namespace</span> <span class=n>-h</span>
</span></span></code></pre></div><p>kubectl如何管理集群资源</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-v</span><span class=p>=</span><span class=n>7</span>
</span></span></code></pre></div><h4 id=实践--使用k8s管理业务应用>实践&ndash;使用k8s管理业务应用<a hidden class=anchor aria-hidden=true href=#实践--使用k8s管理业务应用>#</a></h4><h5 id=最小调度单元-pod-------------------录屏>最小调度单元 Pod 录屏！！！<a hidden class=anchor aria-hidden=true href=#最小调度单元-pod-------------------录屏>#</a></h5><p>docker调度的是容器，在k8s集群中，最小的调度单元是Pod（豆荚）</p><p><img loading=lazy src=images%5cpod-demo.png alt></p><h6 id=为什么引入pod>为什么引入Pod<a hidden class=anchor aria-hidden=true href=#为什么引入pod>#</a></h6><ul><li><p>与容器引擎解耦</p><p>Docker、Rkt。平台设计与引擎的具体的实现解耦</p></li><li><p>多容器共享网络|存储|进程 空间, 支持的业务场景更加灵活</p></li></ul><h6 id=使用yaml格式定义pod>使用yaml格式定义Pod<a hidden class=anchor aria-hidden=true href=#使用yaml格式定义pod>#</a></h6><p><em>myblog/one-pod/pod.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST  </span><span class=w> </span><span class=c>#  指定root用户的用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/mysql:5.7-utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_DATABASE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myblog&#34;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span><span class=p>,</span>		
</span></span><span class=line><span class=cl>	<span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;Pod&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;myblog&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;namespace&#34;</span><span class=p>:</span> <span class=s2>&#34;demo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;labels&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;myblog&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;spec&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;containers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;myblog&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nt>&#34;image&#34;</span><span class=p>:</span> <span class=s2>&#34;172.21.32.6:5000/myblog&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;env&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;MYSQL_HOST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;MYSQL_PASSWD&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;123456&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nt>&#34;ports&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nt>&#34;containerPort&#34;</span><span class=p>:</span> <span class=mi>8002</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>    		<span class=p>{</span>
</span></span><span class=line><span class=cl>    			<span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;mysql&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=err>...</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>apiVersion</th><th style=text-align:left>含义</th></tr></thead><tbody><tr><td style=text-align:left>alpha</td><td style=text-align:left>进入K8s功能的早期候选版本，可能包含Bug，最终不一定进入K8s</td></tr><tr><td style=text-align:left>beta</td><td style=text-align:left>已经过测试的版本，最终会进入K8s，但功能、对象定义可能会发生变更。</td></tr><tr><td style=text-align:left>stable</td><td style=text-align:left>可安全使用的稳定版本</td></tr><tr><td style=text-align:left>v1</td><td style=text-align:left>stable 版本之后的首个版本，包含了更多的核心对象</td></tr><tr><td style=text-align:left>apps/v1</td><td style=text-align:left>使用最广泛的版本，像Deployment、ReplicaSets都已进入该版本</td></tr></tbody></table><p>资源类型与apiVersion对照表</p><table><thead><tr><th style=text-align:left>Kind</th><th style=text-align:left>apiVersion</th></tr></thead><tbody><tr><td style=text-align:left>ClusterRoleBinding</td><td style=text-align:left>rbac.authorization.k8s.io/v1</td></tr><tr><td style=text-align:left>ClusterRole</td><td style=text-align:left>rbac.authorization.k8s.io/v1</td></tr><tr><td style=text-align:left>ConfigMap</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>CronJob</td><td style=text-align:left>batch/v1beta1</td></tr><tr><td style=text-align:left>DaemonSet</td><td style=text-align:left>extensions/v1beta1</td></tr><tr><td style=text-align:left>Node</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>Namespace</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>Secret</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>PersistentVolume</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>PersistentVolumeClaim</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>Pod</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>Deployment</td><td style=text-align:left>v1、apps/v1、apps/v1beta1、apps/v1beta2</td></tr><tr><td style=text-align:left>Service</td><td style=text-align:left>v1</td></tr><tr><td style=text-align:left>Ingress</td><td style=text-align:left>extensions/v1beta1</td></tr><tr><td style=text-align:left>ReplicaSet</td><td style=text-align:left>apps/v1、apps/v1beta2</td></tr><tr><td style=text-align:left>Job</td><td style=text-align:left>batch/v1</td></tr><tr><td style=text-align:left>StatefulSet</td><td style=text-align:left>apps/v1、apps/v1beta1、apps/v1beta2</td></tr></tbody></table><p>快速获得资源和版本</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>explain</span> <span class=n>pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>explain</span> <span class=n>Pod</span><span class=p>.</span><span class=n>apiVersion</span>
</span></span></code></pre></div><h6 id=创建和访问pod>创建和访问Pod<a hidden class=anchor aria-hidden=true href=#创建和访问pod>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 创建namespace, namespace是逻辑上的资源池</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=n>namespace</span> <span class=n>demo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 使用指定文件创建Pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>demo-pod</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看pod，可以简写po</span>
</span></span><span class=line><span class=cl><span class=c>## 所有的操作都需要指定namespace，如果是在default命名空间下，则可以省略</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>pods</span> <span class=n>-o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>    <span class=n>IP</span>             <span class=n>NODE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>2</span><span class=p>/</span><span class=n>2</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>3m</span>     <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>146</span>   <span class=nb>k8s-slave1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 使用Pod Ip访问服务,3306和8002</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>146</span><span class=err>:</span><span class=n>8002</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 进入容器,执行初始化, 不必到对应的主机执行docker exec</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>-c</span> <span class=n>myblog</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># env</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># python3 manage.py migrate</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>-c</span> <span class=n>mysql</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># mysql -p123456</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 再次访问服务,3306和8002</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>146</span><span class=err>:</span><span class=n>8002</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span></code></pre></div><h6 id=infra容器>Infra容器<a hidden class=anchor aria-hidden=true href=#infra容器>#</a></h6><p>登录<code>k8s-slave1</code>节点</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>ps </span><span class=n>-a</span> <span class=p>|</span><span class=n>grep</span> <span class=n>myblog</span>  <span class=c>## 发现有三个容器</span>
</span></span><span class=line><span class=cl><span class=c>## 其中包含mysql和myblog程序以及Infra容器</span>
</span></span><span class=line><span class=cl><span class=c>## 为了实现Pod内部的容器可以通过localhost通信，每个Pod都会启动Infra容器，然后Pod内部的其他容器的网络空间会共享该Infra容器的网络空间(Docker网络的container模式)，Infra容器只需要hang住网络空间，不需要额外的功能，因此资源消耗极低。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 登录master节点，查看pod内部的容器ip均相同，为pod ip</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>-c</span> <span class=n>myblog</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># ifconfig</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>-c</span> <span class=n>mysql</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=p>/</span> <span class=c># ifconfig</span>
</span></span></code></pre></div><p>pod容器命名: <code>k8s_&lt;container_name>_&lt;pod_name>_&lt;namespace>_&lt;random_string></code></p><h6 id=查看pod详细信息>查看pod详细信息<a hidden class=anchor aria-hidden=true href=#查看pod详细信息>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 查看pod调度节点及pod_ip</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>pods</span> <span class=n>-o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=c>## 查看完整的yaml</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span> <span class=n>myblog</span> <span class=n>-o</span> <span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=c>## 查看pod的明细信息及事件</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>describe</span> <span class=n>pod</span> <span class=n>myblog</span>
</span></span></code></pre></div><h6 id=troubleshooting-and-debugging>Troubleshooting and Debugging<a hidden class=anchor aria-hidden=true href=#troubleshooting-and-debugging>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>#进入Pod内的容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=p>&lt;</span><span class=n>namespace</span><span class=p>&gt;</span> <span class=n>exec</span> <span class=p>&lt;</span><span class=n>pod_name</span><span class=p>&gt;</span> <span class=n>-c</span> <span class=p>&lt;</span><span class=n>container_name</span><span class=p>&gt;</span> <span class=n>-ti</span> <span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#查看Pod内容器日志,显示标准或者错误输出日志</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=p>&lt;</span><span class=n>namespace</span><span class=p>&gt;</span> <span class=n>logs</span> <span class=o>-f</span> <span class=p>&lt;</span><span class=n>pod_name</span><span class=p>&gt;</span> <span class=n>-c</span> <span class=p>&lt;</span><span class=n>container_name</span><span class=p>&gt;</span>
</span></span></code></pre></div><h6 id=更新服务版本>更新服务版本<a hidden class=anchor aria-hidden=true href=#更新服务版本>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>apply</span> <span class=o>-f</span> <span class=nb>demo-pod</span><span class=p>.</span><span class=n>yaml</span>
</span></span></code></pre></div><h6 id=删除pod服务>删除Pod服务<a hidden class=anchor aria-hidden=true href=#删除pod服务>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>#根据文件删除</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>delete</span> <span class=o>-f</span> <span class=nb>demo-pod</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#根据pod_name删除</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=p>&lt;</span><span class=n>namespace</span><span class=p>&gt;</span> <span class=n>delete</span> <span class=n>pod</span> <span class=p>&lt;</span><span class=n>pod_name</span><span class=p>&gt;</span>
</span></span></code></pre></div><h6 id=pod数据持久化>Pod数据持久化<a hidden class=anchor aria-hidden=true href=#pod数据持久化>#</a></h6><p>若删除了Pod，由于mysql的数据都在容器内部，会造成数据丢失，因此需要数据进行持久化。</p><ul><li><p>定点使用hostpath挂载，nodeSelector定点</p><p><code>myblog/one-pod/pod-with-volume.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/mysql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>   </span><span class=c># 使用节点选择器将Pod调度到指定label的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST  </span><span class=w> </span><span class=c>#  指定root用户的用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/mysql:5.7-utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_DATABASE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myblog&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span></code></pre></div><p>保存文件为<code>pod-with-volume.yaml</code>，执行创建</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 若存在旧的同名服务，先删除掉，后创建</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>delete</span> <span class=n>pod</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=c>## 创建</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>pod-with</span><span class=n>-volume</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 此时pod状态Pending</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>0</span><span class=p>/</span><span class=n>2</span>     <span class=n>Pending</span>   <span class=n>0</span>          <span class=n>32s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看原因，提示调度失败，因为节点不满足node selector</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>describe</span> <span class=n>po</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Events</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=nb>Type </span>    <span class=n>Reason</span>            <span class=n>Age</span>                <span class=n>From</span>               <span class=n>Message</span>
</span></span><span class=line><span class=cl>  <span class=p>----</span>     <span class=p>------</span>            <span class=p>----</span>               <span class=p>----</span>               <span class=p>-------</span>
</span></span><span class=line><span class=cl>  <span class=n>Warning</span>  <span class=n>FailedScheduling</span>  <span class=n>12s</span> <span class=p>(</span><span class=n>x2</span> <span class=n>over</span> <span class=n>12s</span><span class=p>)</span>  <span class=nb>default-scheduler</span>  <span class=n>0</span><span class=p>/</span><span class=n>3</span> <span class=n>nodes</span> <span class=n>are</span> <span class=n>available</span><span class=err>:</span> <span class=n>3</span> <span class=n>node</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=n>didn</span><span class=err>&#39;</span><span class=n>t</span> <span class=n>match</span> <span class=n>node</span> <span class=n>selector</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 为节点打标签</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>label</span> <span class=n>node</span> <span class=nb>k8s-slave1</span> <span class=n>component</span><span class=p>=</span><span class=n>mysql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 再次查看，已经运行成功</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>     <span class=n>IP</span>             <span class=n>NODE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>2</span><span class=p>/</span><span class=n>2</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>3m54s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>150</span>   <span class=nb>k8s-slave1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 到k8s-slave1节点，查看/opt/mysql/data</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>ll</span> <span class=p>/</span><span class=n>opt</span><span class=p>/</span><span class=n>mysql</span><span class=p>/</span><span class=n>data</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>total</span> <span class=n>188484</span>
</span></span><span class=line><span class=cl><span class=n>-rw-r</span><span class=p>-----</span> <span class=n>1</span> <span class=n>polkitd</span> <span class=n>input</span>       <span class=n>56</span> <span class=n>Mar</span> <span class=n>29</span> <span class=n>09</span><span class=err>:</span><span class=n>20</span> <span class=n>auto</span><span class=p>.</span><span class=n>cnf</span>
</span></span><span class=line><span class=cl><span class=n>-rw</span><span class=p>-------</span> <span class=n>1</span> <span class=n>polkitd</span> <span class=n>input</span>     <span class=n>1676</span> <span class=n>Mar</span> <span class=n>29</span> <span class=n>09</span><span class=err>:</span><span class=n>20</span> <span class=nb>ca-key</span><span class=p>.</span><span class=n>pem</span>
</span></span><span class=line><span class=cl><span class=n>-rw-r</span><span class=p>-</span><span class=n>-r</span><span class=p>--</span> <span class=n>1</span> <span class=n>polkitd</span> <span class=n>input</span>     <span class=n>1112</span> <span class=n>Mar</span> <span class=n>29</span> <span class=n>09</span><span class=err>:</span><span class=n>20</span> <span class=n>ca</span><span class=p>.</span><span class=n>pem</span>
</span></span><span class=line><span class=cl><span class=nb>drwxr-x</span><span class=p>---</span> <span class=n>2</span> <span class=n>polkitd</span> <span class=n>input</span>     <span class=n>8192</span> <span class=n>Mar</span> <span class=n>29</span> <span class=n>09</span><span class=err>:</span><span class=n>20</span> <span class=n>sys</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 执行migrate，创建数据库表，然后删掉pod，再次创建后验证数据是否存在</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span> <span class=n>python3</span> <span class=n>manage</span><span class=p>.</span><span class=n>py</span> <span class=n>migrate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 访问服务，正常</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>150</span><span class=err>:</span><span class=n>8002</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 删除pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>delete</span> <span class=o>-f</span> <span class=nb>pod-with</span><span class=n>-volume</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 再次创建Pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>pod-with</span><span class=n>-volume</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看pod ip并访问服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>             <span class=n>NODE</span>  
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>2</span><span class=p>/</span><span class=n>2</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>7s</span>    <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>151</span>   <span class=nb>k8s-slave1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 未做migrate，服务正常</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>151</span><span class=err>:</span><span class=n>8002</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span></code></pre></div></li><li><p>使用PV+PVC连接分布式存储解决方案</p><ul><li>ceph</li><li>glusterfs</li><li>nfs</li></ul></li></ul><h6 id=服务健康检查>服务健康检查<a hidden class=anchor aria-hidden=true href=#服务健康检查>#</a></h6><p>检测容器服务是否健康的手段，若不健康，会根据设置的重启策略（restartPolicy）进行操作，两种检测机制可以分别单独设置，若不设置，默认认为Pod是健康的。</p><p>两种机制：</p><ul><li>LivenessProbe探针
用于判断容器是否存活，即Pod是否为running状态，如果LivenessProbe探针探测到容器不健康，则kubelet将kill掉容器，并根据容器的重启策略是否重启，如果一个容器不包含LivenessProbe探针，则Kubelet认为容器的LivenessProbe探针的返回值永远成功。</li><li>ReadinessProbe探针
用于判断容器是否正常提供服务，即容器的Ready是否为True，是否可以接收请求，如果ReadinessProbe探测失败，则容器的Ready将为False，控制器将此Pod的Endpoint从对应的service的Endpoint列表中移除，从此不再将任何请求调度此Pod上，直到下次探测成功。（剔除此pod不参与接收请求不会将流量转发给此Pod）。</li></ul><p>三种类型：</p><ul><li>exec：通过执行命令来检查服务是否正常，回值为0则表示容器健康</li><li>httpGet方式：通过发送http请求检查服务是否正常，返回200-399状态码则表明容器健康</li><li>tcpSocket：通过容器的IP和Port执行TCP检查，如果能够建立TCP连接，则表明容器健康</li></ul><p>示例：</p><p>完整文件路径 <code>myblog/one-pod/pod-with-healthcheck.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST  </span><span class=w> </span><span class=c>#  指定root用户的用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>  </span><span class=c># 容器启动后第一次执行探测是需要等待多少秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w> 	</span><span class=c># 执行探测的频率</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>		</span><span class=c># 探测超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span></code></pre></div><ul><li>initialDelaySeconds：容器启动后第一次执行探测是需要等待多少秒。</li><li>periodSeconds：执行探测的频率。默认是10秒，最小1秒。</li><li>timeoutSeconds：探测超时时间。默认1秒，最小1秒。</li><li>successThreshold：探测失败后，最少连续探测成功多少次才被认定为成功。默认是1。对于liveness必须是1，最小值是1。</li><li>failureThreshold：探测成功后，最少连续探测失败多少次
才被认定为失败。默认是3，最小值是1。</li></ul><p>重启策略：</p><p>Pod的重启策略（RestartPolicy）应用于Pod内的所有容器，并且仅在Pod所处的Node上由kubelet进行判断和重启操作。当某个容器异常退出或者健康检查失败时，kubelet将根据RestartPolicy的设置来进行相应的操作。
Pod的重启策略包括Always、OnFailure和Never，默认值为Always。</p><ul><li>Always：当容器失败时，由kubelet自动重启该容器；</li><li>OnFailure：当容器终止运行且退出码不为0时，有kubelet自动重启该容器；</li><li>Never：不论容器运行状态如何，kubelet都不会重启该容器。</li></ul><h6 id=镜像拉取策略>镜像拉取策略<a hidden class=anchor aria-hidden=true href=#镜像拉取策略>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/demo/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span></code></pre></div><p>设置镜像的拉取策略，默认为IfNotPresent</p><ul><li>Always，总是拉取镜像，即使本地有镜像也从仓库拉取</li><li>IfNotPresent ，本地有则使用本地镜像，本地没有则去仓库拉取</li><li>Never，只使用本地镜像，本地没有则报错</li></ul><h6 id=pod资源限制>Pod资源限制<a hidden class=anchor aria-hidden=true href=#pod资源限制>#</a></h6><p>为了保证充分利用集群资源，且确保重要容器在运行周期内能够分配到足够的资源稳定运行，因此平台需要具备</p><p>Pod的资源限制的能力。 对于一个pod来说，资源最基础的2个的指标就是：CPU和内存。</p><p>Kubernetes提供了个采用requests和limits 两种类型参数对资源进行预分配和使用限制。</p><p>完整文件路径：<code>myblog/one-pod/pod-with-resourcelimits.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST  </span><span class=w> </span><span class=c>#  指定root用户的用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>requests：</p><ul><li>容器使用的最小资源需求,作用于schedule阶段，作为容器调度时资源分配的判断依赖</li><li>只有当前节点上可分配的资源量 >= request 时才允许将容器调度到该节点</li><li>request参数不限制容器的最大可使用资源</li><li>requests.cpu被转成docker的&ndash;cpu-shares参数，与cgroup cpu.shares功能相同 (无论宿主机有多少个cpu或者内核，&ndash;cpu-shares选项都会按照比例分配cpu资源）</li><li>requests.memory没有对应的docker参数，仅作为k8s调度依据</li></ul><p>limits：</p><ul><li>容器能使用资源的最大值</li><li>设置为0表示对使用的资源不做限制, 可无限的使用</li><li>当pod 内存超过limit时，会被oom</li><li>当cpu超过limit时，不会被kill，但是会限制不超过limit值</li><li>limits.cpu会被转换成docker的–cpu-quota参数。与cgroup cpu.cfs_quota_us功能相同</li><li>limits.memory会被转换成docker的–memory参数。用来限制容器使用的最大内存</li></ul><p>对于 CPU，我们知道计算机里 CPU 的资源是按<code>“时间片”</code>的方式来进行分配的，系统里的每一个操作都需要 CPU 的处理，所以，哪个任务要是申请的 CPU 时间片越多，那么它得到的 CPU 资源就越多。</p><p>然后还需要了解下 CGroup 里面对于 CPU 资源的单位换算：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=m>1</span> <span class=nv>CPU</span> <span class=o>=</span>  <span class=m>1000</span> millicpu（1 <span class=nv>Core</span> <span class=o>=</span> 1000m）
</span></span></code></pre></div><p>这里的 <code>m</code> 就是毫、毫核的意思，Kubernetes 集群中的每一个节点可以通过操作系统的命令来确认本节点的 CPU 内核数量，然后将这个数量乘以1000，得到的就是节点总 CPU 总毫数。比如一个节点有四核，那么该节点的 CPU 总毫量为 4000m。</p><p><code>docker run</code>命令和 CPU 限制相关的所有选项如下：</p><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td><code>--cpuset-cpus=""</code></td><td>允许使用的 CPU 集，值可以为 0-3,0,1</td></tr><tr><td><code>-c</code>,<code>--cpu-shares=0</code></td><td>CPU 共享权值（相对权重）</td></tr><tr><td><code>cpu-period=0</code></td><td>限制 CPU CFS 的周期，范围从 100ms~1s，即[1000, 1000000]</td></tr><tr><td><code>--cpu-quota=0</code></td><td>限制 CPU CFS 配额，必须不小于1ms，即 >= 1000，绝对限制</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker run -it --cpu-period<span class=o>=</span><span class=m>50000</span> --cpu-quota<span class=o>=</span><span class=m>25000</span> ubuntu:16.04 /bin/bash
</span></span></code></pre></div><p>将 CFS 调度的周期设为 50000，将容器在每个周期内的 CPU 配额设置为 25000，表示该容器每 50ms 可以得到 50% 的 CPU 运行时间。</p><blockquote><p>注意：若内存使用超出限制，会引发系统的OOM机制，因CPU是可压缩资源，不会引发Pod退出或重建</p></blockquote><h6 id=yaml优化>yaml优化<a hidden class=anchor aria-hidden=true href=#yaml优化>#</a></h6><p>目前完善后的yaml，<code>myblog/one-pod/pod-completed.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/mysql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>   </span><span class=c># 使用节点选择器将Pod调度到指定label的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST  </span><span class=w> </span><span class=c>#  指定root用户的用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>  </span><span class=c># 容器启动后第一次执行探测是需要等待多少秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w> 	</span><span class=c># 执行探测的频率</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>		</span><span class=c># 探测超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/mysql:5.7-utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_DATABASE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myblog&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span></code></pre></div><p>为什么要优化</p><ul><li>考虑真实的使用场景，像数据库这类中间件，是作为公共资源，为多个项目提供服务，不适合和业务容器绑定在同一个Pod中，因为业务容器是经常变更的，而数据库不需要频繁迭代</li><li>yaml的环境变量中存在敏感信息（账号、密码），存在安全隐患</li></ul><p>解决问题一，需要拆分yaml</p><p><code>myblog/two-pod/mysql.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>	</span><span class=c># 声明pod的网络模式为host模式，效果通docker run --net=host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/mysql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>   </span><span class=c># 使用节点选择器将Pod调度到指定label的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/mysql:5.7-utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_DATABASE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myblog&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span></code></pre></div><p>myblog.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST  </span><span class=w> </span><span class=c>#  指定root用户的用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;172.21.32.6&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123456&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>  </span><span class=c># 容器启动后第一次执行探测是需要等待多少秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w> 	</span><span class=c># 执行探测的频率</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>		</span><span class=c># 探测超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span></code></pre></div><p>创建测试</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 先删除旧pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>delete</span> <span class=n>po</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 分别创建mysql和myblog</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>mysql</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>myblog</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看pod，注意mysqlIP为宿主机IP，因为网络模式为host</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-o</span> <span class=n>wide</span> 
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>                <span class=n>NODE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>41s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>152</span>      <span class=nb>k8s-slave1</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>52s</span>   <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>136</span><span class=p>.</span><span class=n>131</span>   <span class=nb>k8s-slave1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 访问myblog服务正常</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>152</span><span class=err>:</span><span class=n>8002</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span></code></pre></div><p>解决问题二，环境变量中敏感信息带来的安全隐患</p><p>为什么要统一管理环境变量</p><ul><li>环境变量中有很多敏感的信息，比如账号密码，直接暴漏在yaml文件中存在安全性问题</li><li>团队内部一般存在多个项目，这些项目直接存在配置相同环境变量的情况，因此可以统一维护管理</li><li>对于开发、测试、生产环境，由于配置均不同，每套环境部署的时候都要修改yaml，带来额外的开销</li></ul><p>k8s提供两类资源，configMap和Secret，可以用来实现业务配置的统一管理， 允许将配置文件与镜像文件分离，以使容器化的应用程序具有可移植性 。</p><p><img loading=lazy src=images%5cconfigmap.png alt></p><ul><li><p>configMap，通常用来管理应用的配置文件或者环境变量，<code>myblog/two-pod/configmap.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MYSQL_HOST</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;172.21.32.6&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MYSQL_PORT</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3306&#34;</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Secret，管理敏感类的信息，默认会base64编码存储，有三种类型</p><ul><li>Service Account ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；创建ServiceAccount后，Pod中指定serviceAccount后，自动创建该ServiceAccount对应的secret；</li><li>Opaque ： base64编码格式的Secret，用来存储密码、密钥等；</li><li>kubernetes.io/dockerconfigjson ：用来存储私有docker registry的认证信息。</li></ul><p><code>myblog/two-pod/secret.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MYSQL_USER</span><span class=p>:</span><span class=w> </span><span class=l>cm9vdA==		#注意加-n参数， echo -n root|base64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MYSQL_PASSWD</span><span class=p>:</span><span class=w> </span><span class=l>MTIzNDU2</span><span class=w>
</span></span></span></code></pre></div><p>创建并查看：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>secret</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>secret</span>
</span></span></code></pre></div><p>如果不习惯这种方式，可以通过如下方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>cat </span><span class=n>secret</span><span class=p>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=n>MYSQL_USER</span><span class=p>=</span><span class=n>root</span>
</span></span><span class=line><span class=cl><span class=n>MYSQL_PASSWD</span><span class=p>=</span><span class=n>123456</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>create</span> <span class=n>secret</span> <span class=n>generic</span> <span class=n>myblog</span> <span class=p>-</span><span class=n>-from-env</span><span class=o>-file</span><span class=p>=</span><span class=n>secret</span><span class=p>.</span><span class=n>txt</span> 
</span></span></code></pre></div></li></ul><p>修改后的mysql的yaml，资源路径：<code>myblog/two-pod/mysql-with-config.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/mysql:5.7-utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_DATABASE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myblog&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>修改后的myblog的yaml，资源路径：<code>myblog/two-pod/myblog-with-config.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span></code></pre></div><p>在部署不同的环境时，pod的yaml无须再变化，只需要在每套环境中维护一套ConfigMap和Secret即可。但是注意configmap和secret不能跨namespace使用，且更新后，pod内的env不会自动更新，重建后方可更新。</p><h6 id=如何编写资源yaml>如何编写资源yaml<a hidden class=anchor aria-hidden=true href=#如何编写资源yaml>#</a></h6><ol><li><p>拿来主义，从机器中已有的资源中拿</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=nb>kube-system</span> <span class=n>get</span> <span class=n>po</span><span class=p>,</span><span class=n>deployment</span><span class=p>,</span><span class=n>ds</span>
</span></span></code></pre></div></li><li><p>学会在官网查找， <a href=https://kubernetes.io/docs/home/>https://kubernetes.io/docs/home/</a></p></li><li><p>从kubernetes-api文档中查找， <a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core>https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core</a></p></li><li><p>kubectl explain 查看具体字段含义</p></li></ol><h6 id=pod状态与生命周期>pod状态与生命周期<a hidden class=anchor aria-hidden=true href=#pod状态与生命周期>#</a></h6><p>Pod的状态如下表所示：</p><table><thead><tr><th>状态值</th><th>描述</th></tr></thead><tbody><tr><td>Pending</td><td>API Server已经创建该Pod，等待调度器调度</td></tr><tr><td>ContainerCreating</td><td>镜像正在创建</td></tr><tr><td>Running</td><td>Pod内容器均已创建，且至少有一个容器处于运行状态、正在启动状态或正在重启状态</td></tr><tr><td>Succeeded</td><td>Pod内所有容器均已成功执行退出，且不再重启</td></tr><tr><td>Failed</td><td>Pod内所有容器均已退出，但至少有一个容器退出为失败状态</td></tr><tr><td>CrashLoopBackOff</td><td>Pod内有容器启动失败，比如配置文件丢失导致主进程启动失败</td></tr><tr><td>Unknown</td><td>由于某种原因无法获取该Pod的状态，可能由于网络通信不畅导致</td></tr></tbody></table><p>生命周期示意图：</p><p><img loading=lazy src=images%5cfcachl.jpg alt></p><p>启动和关闭示意：</p><p><img loading=lazy src=images%5cAOQgQj.jpg alt></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-start-stop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>demo-start-stop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>INIT &gt;&gt; /loap/timing&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/loap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>timing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>START &gt;&gt; /loap/timing;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>sleep 10; echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>END &gt;&gt; /loap/timing;&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/loap </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>timing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>LIVENESS &gt;&gt; /loap/timing&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>READINESS &gt;&gt; /loap/timing&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lifecycle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>postStart</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>POST-START &gt;&gt; /loap/timing&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preStop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span><span class=p>:</span><span class=w> </span><span class=l>PRE-STOP &gt;&gt; /loap/timing&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>timing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/loap</span><span class=w>
</span></span></span></code></pre></div><p>创建pod测试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>demo-pod</span><span class=n>-start</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看demo状态</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-o</span> <span class=n>wide</span> <span class=n>-w</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 查看调度节点的/tmp/loap/timing</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>cat </span><span class=p>/</span><span class=n>tmp</span><span class=p>/</span><span class=n>loap</span><span class=p>/</span><span class=n>timing</span>
</span></span><span class=line><span class=cl><span class=n>1585424708</span><span class=err>:</span> <span class=n>INIT</span>
</span></span><span class=line><span class=cl><span class=n>1585424746</span><span class=err>:</span> <span class=nb>START
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=n>1585424746</span><span class=err>:</span> <span class=nb>POST-START</span>
</span></span><span class=line><span class=cl><span class=n>1585424754</span><span class=err>:</span> <span class=n>READINESS</span>
</span></span><span class=line><span class=cl><span class=n>1585424756</span><span class=err>:</span> <span class=n>LIVENESS</span>
</span></span><span class=line><span class=cl><span class=n>1585424756</span><span class=err>:</span> <span class=k>END</span>
</span></span></code></pre></div><blockquote><p>须主动杀掉 Pod 才会触发 <code>pre-stop hook</code>，如果是 Pod 自己 Down 掉，则不会执行 <code>pre-stop hook</code></p></blockquote><h6 id=小结-1>小结<a hidden class=anchor aria-hidden=true href=#小结-1>#</a></h6><ol><li>实现k8s平台与特定的容器运行时解耦，提供更加灵活的业务部署方式，引入了Pod概念</li><li>k8s使用yaml格式定义资源文件，yaml中Map与List的语法，与json做类比</li><li>通过kubectl create | get | exec | logs | delete 等操作k8s资源，必须指定namespace</li><li>每启动一个Pod，为了实现网络空间共享，会先创建Infra容器，并把其他容器网络加入该容器</li><li>通过livenessProbe和readinessProbe实现Pod的存活性和就绪健康检查</li><li>通过requests和limit分别限定容器初始资源申请与最高上限资源申请</li><li>通过Pod IP访问具体的Pod服务，实现是</li></ol><h5 id=pod控制器-----录屏>Pod控制器 录屏！！！<a hidden class=anchor aria-hidden=true href=#pod控制器-----录屏>#</a></h5><p>只使用Pod, 将会面临如下需求:</p><ol><li>业务应用启动多个副本</li><li>Pod重建后IP会变化，外部如何访问Pod服务</li><li>运行业务Pod的某个节点挂了，可以自动帮我把Pod转移到集群中的可用节点启动起来</li><li>我的业务应用功能是收集节点监控数据,需要把Pod运行在k8集群的各个节点上</li></ol><h6 id=workload-工作负载>Workload (工作负载)<a hidden class=anchor aria-hidden=true href=#workload-工作负载>#</a></h6><p>控制器又称工作负载是用于实现管理pod的中间层，确保pod资源符合预期的状态，pod的资源出现故障时，会尝试 进行重启，当根据重启策略无效，则会重新新建pod的资源。</p><p><img loading=lazy src=images%5cworkload.png alt></p><ul><li>ReplicaSet: 代用户创建指定数量的pod副本数量，确保pod副本数量符合预期状态，并且支持滚动式自动扩容和缩容功能</li><li>Deployment：工作在ReplicaSet之上，用于管理无状态应用，目前来说最好的控制器。支持滚动更新和回滚功能，还提供声明式配置</li><li>DaemonSet：用于确保集群中的每一个节点只运行特定的pod副本，通常用于实现系统级后台任务。比如ELK服务</li><li>Job：只要完成就立即退出，不需要重启或重建</li><li>Cronjob：周期性任务控制，不需要持续后台运行</li><li>StatefulSet：管理有状态应用</li></ul><h6 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h6><p><code>myblog/deployment/deploy-mysql.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>	</span><span class=c>#指定Pod副本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>selector:		#指定Pod的选择器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>labels:	#给Pod打label</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>	</span><span class=c># 声明pod的网络模式为host模式，效果通docker run --net=host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/mysql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>   </span><span class=c># 使用节点选择器将Pod调度到指定label的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.15</span><span class=p>:</span><span class=m>5000</span><span class=l>/mysql:5.7-utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_DATABASE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myblog&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span></code></pre></div><p>deploy-myblog.yaml:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>	</span><span class=c>#指定Pod副本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>selector:		#指定Pod的选择器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>labels:	#给Pod打label</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.15</span><span class=p>:</span><span class=m>5000</span><span class=l>/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_PASSWD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>  </span><span class=c># 容器启动后第一次执行探测是需要等待多少秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w> 	</span><span class=c># 执行探测的频率</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>		</span><span class=c># 探测超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/blog/index/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span></code></pre></div><h6 id=创建deployment>创建Deployment<a hidden class=anchor aria-hidden=true href=#创建deployment>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>deploy</span><span class=p>.</span><span class=n>yaml</span>
</span></span></code></pre></div><h6 id=查看deployment>查看Deployment<a hidden class=anchor aria-hidden=true href=#查看deployment>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># kubectl api-resources</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>deploy</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>READY</span>   <span class=nb>UP-TO</span><span class=n>-DATE</span>   <span class=n>AVAILABLE</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>2m22s</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>2d11h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>*</span> <span class=p>`</span><span class=n>NAME</span><span class=p>`</span> <span class=n>列出了集群中</span> <span class=n>Deployments</span> <span class=n>的名称</span><span class=err>。</span>
</span></span><span class=line><span class=cl>  <span class=p>*</span> <span class=p>`</span><span class=n>READY</span><span class=p>`</span><span class=n>显示当前正在运行的副本数</span><span class=p>/</span><span class=n>期望的副本数</span><span class=err>。</span>
</span></span><span class=line><span class=cl>  <span class=p>*</span> <span class=p>`</span><span class=nb>UP-TO</span><span class=n>-DATE</span><span class=p>`</span><span class=n>显示已更新以实现期望状态的副本数</span><span class=err>。</span>
</span></span><span class=line><span class=cl>  <span class=p>*</span> <span class=p>`</span><span class=n>AVAILABLE</span><span class=p>`</span><span class=n>显示应用程序可供用户使用的副本数</span><span class=err>。</span>
</span></span><span class=line><span class=cl>  <span class=p>*</span> <span class=p>`</span><span class=n>AGE</span><span class=p>`</span> <span class=n>显示应用程序运行的时间量</span><span class=err>。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 查看pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                      <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span><span class=p>-</span><span class=n>7c96c9f76b-qbbg7</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>109s</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span><span class=p>-</span><span class=n>85f4f65f99-w6jkj</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>2m28s</span>
</span></span></code></pre></div><h6 id=副本保障机制>副本保障机制<a hidden class=anchor aria-hidden=true href=#副本保障机制>#</a></h6><p>controller实时检测pod状态，并保障副本数一直处于期望的值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 删除pod，观察pod状态变化</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>delete</span> <span class=n>pod</span> <span class=n>myblog</span><span class=p>-</span><span class=n>7c96c9f76b-qbbg7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 观察pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>pods</span> <span class=n>-o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 设置两个副本, 或者通过kubectl -n demo edit deploy myblog的方式，最好通过修改文件，然后apply的方式，这样yaml文件可以保持同步</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>scale</span> <span class=n>deploy</span> <span class=n>myblog</span> <span class=p>-</span><span class=n>-replicas</span><span class=p>=</span><span class=n>2</span>
</span></span><span class=line><span class=cl><span class=n>deployment</span><span class=p>.</span><span class=n>extensions</span><span class=p>/</span><span class=n>myblog</span> <span class=n>scaled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 观察pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>pods</span> <span class=n>-o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                      <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span><span class=p>-</span><span class=n>7c96c9f76b-qbbg7</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>11m</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span><span class=p>-</span><span class=n>7c96c9f76b-s6brm</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>55s</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span><span class=p>-</span><span class=n>85f4f65f99-w6jkj</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>11m</span>
</span></span></code></pre></div><h6 id=pod驱逐策略>Pod驱逐策略<a hidden class=anchor aria-hidden=true href=#pod驱逐策略>#</a></h6><p>K8S 有个特色功能叫 pod eviction，它在某些场景下如节点 NotReady，或者资源不足时，把 pod 驱逐至其它节点，这也是出于业务保护的角度去考虑的。</p><ol><li><p>Kube-controller-manager: 周期性检查所有节点状态，当节点处于 NotReady 状态超过一段时间后，驱逐该节点上所有 pod。停掉kubelet</p><ul><li><code>pod-eviction-timeout</code>：NotReady 状态节点超过该时间后，执行驱逐，默认 5 min</li></ul></li><li><p>Kubelet: 周期性检查本节点资源，当资源不足时，按照优先级驱逐部分 pod</p><ul><li><code>memory.available</code>：节点可用内存</li><li><code>nodefs.available</code>：节点根盘可用存储空间</li><li><code>nodefs.inodesFree</code>：节点inodes可用数量</li><li><code>imagefs.available</code>：镜像存储盘的可用空间</li><li><code>imagefs.inodesFree</code>：镜像存储盘的inodes可用数量</li></ul></li></ol><h6 id=服务更新>服务更新<a hidden class=anchor aria-hidden=true href=#服务更新>#</a></h6><p>修改dockerfile，重新打tag模拟服务更新。</p><p>更新方式：</p><ul><li>修改yaml文件，使用<code>kubectl -n demo apply -f deploy-myblog.yaml</code>来应用更新</li><li><code>kubectl -n demo edit deploy myblog</code>在线更新</li><li><code>kubectl set image deploy myblog myblog=172.21.32.6:5000/myblog:v2 --record</code></li></ul><p>修改文件测试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>vi</span> <span class=n>mybolg</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>template</span><span class=p>/</span><span class=n>index</span><span class=p>.</span><span class=n>html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>.</span> <span class=n>-t</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>myblog</span><span class=err>:</span><span class=n>v2</span> <span class=o>-f</span> <span class=n>Dockerfile_optimized</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>push</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>myblog</span><span class=err>:</span><span class=n>v2</span>
</span></span></code></pre></div><h6 id=更新策略>更新策略<a hidden class=anchor aria-hidden=true href=#更新策略>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>	</span><span class=c>#指定Pod副本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>selector:		#指定Pod的选择器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate		#指定更新方式为滚动更新，默认策略，通过get deploy yaml查看</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=images%5cupdate.png alt></p><p>策略控制：</p><ul><li>maxSurge：最大激增数, 指更新过程中, 最多可以比replicas预先设定值多出的pod数量, 可以为固定值或百分比,默认为desired Pods数的25%。计算时向上取整(比如3.4，取4)，更新过程中最多会有replicas + maxSurge个pod</li><li>maxUnavailable： 指更新过程中, 最多有几个pod处于无法服务状态 , 可以为固定值或百分比，默认为desired Pods数的25%。计算时向下取整(比如3.6，取3)</li></ul><p><em>在Deployment rollout时，需要保证Available(Ready) Pods数不低于 desired pods number - maxUnavailable; 保证所有的非异常状态Pods数不多于 desired pods number + maxSurge</em>。</p><p>以myblog为例，使用默认的策略，更新过程:</p><ol><li>maxSurge 25%，2个实例，向上取整，则maxSurge为1，意味着最多可以有2+1=3个Pod，那么此时会新创建1个ReplicaSet，RS-new，把副本数置为1，此时呢，副本控制器就去创建这个新的Pod</li><li>同时，maxUnavailable是25%，副本数2*25%，向下取整，则为0，意味着，滚动更新的过程中，不能有少于2个可用的Pod，因此，旧的Replica（RS-old）会先保持不动，等RS-new管理的Pod状态Ready后，此时已经有3个Ready状态的Pod了，那么由于只要保证有2个可用的Pod即可，因此，RS-old的副本数会有2个变成1个，此时，会删掉一个旧的Pod</li><li>删掉旧的Pod的时候，由于总的Pod数量又变成2个了，因此，距离最大的3个还有1个Pod可以创建，所以，RS-new把管理的副本数由1改成2，此时又会创建1个新的Pod，等RS-new管理了2个Pod都ready后，那么就可以把RS-old的副本数由1置为0了，这样就完成了滚动更新</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>#查看滚动更新事件</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>describe</span> <span class=n>deploy</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>Events</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=nb>Type </span>   <span class=n>Reason</span>             <span class=n>Age</span>   <span class=n>From</span>                   <span class=n>Message</span>
</span></span><span class=line><span class=cl>  <span class=p>----</span>    <span class=p>------</span>             <span class=p>----</span>  <span class=p>----</span>                   <span class=p>-------</span>
</span></span><span class=line><span class=cl>  <span class=n>Normal</span>  <span class=n>ScalingReplicaSet</span>  <span class=n>11s</span>   <span class=nb>deployment-controller</span>  <span class=n>Scaled</span> <span class=n>up</span> <span class=n>replica</span> <span class=nb>set </span><span class=n>myblog</span><span class=p>-</span><span class=n>6cf56fc848</span> <span class=n>to</span> <span class=n>1</span>
</span></span><span class=line><span class=cl>  <span class=n>Normal</span>  <span class=n>ScalingReplicaSet</span>  <span class=n>11s</span>   <span class=nb>deployment-controller</span>  <span class=n>Scaled</span> <span class=n>down</span> <span class=n>replica</span> <span class=nb>set </span><span class=n>myblog</span><span class=p>-</span><span class=n>6fdcf98f9</span> <span class=n>to</span> <span class=n>1</span>
</span></span><span class=line><span class=cl>  <span class=n>Normal</span>  <span class=n>ScalingReplicaSet</span>  <span class=n>11s</span>   <span class=nb>deployment-controller</span>  <span class=n>Scaled</span> <span class=n>up</span> <span class=n>replica</span> <span class=nb>set </span><span class=n>myblog</span><span class=p>-</span><span class=n>6cf56fc848</span> <span class=n>to</span> <span class=n>2</span>
</span></span><span class=line><span class=cl>  <span class=n>Normal</span>  <span class=n>ScalingReplicaSet</span>  <span class=n>6s</span>    <span class=nb>deployment-controller</span>  <span class=n>Scaled</span> <span class=n>down</span> <span class=n>replica</span> <span class=nb>set </span><span class=n>myblog</span><span class=p>-</span><span class=n>6fdcf98f9</span> <span class=n>to</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>rs</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                     <span class=n>DESIRED</span>   <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span><span class=p>-</span><span class=n>6cf56fc848</span>   <span class=n>2</span>         <span class=n>2</span>         <span class=n>2</span>       <span class=n>16h</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span><span class=p>-</span><span class=n>6fdcf98f9</span>    <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>16h</span>
</span></span></code></pre></div><h6 id=服务回滚>服务回滚<a hidden class=anchor aria-hidden=true href=#服务回滚>#</a></h6><p>通过滚动升级的策略可以平滑的升级Deployment，若升级出现问题，需要最快且最好的方式回退到上一次能够提供正常工作的版本。为此K8S提供了回滚机制。</p><p><strong>revision</strong>：更新应用时，K8S都会记录当前的版本号，即为revision，当升级出现问题时，可通过回滚到某个特定的revision，默认配置下，K8S只会保留最近的几个revision，可以通过Deployment配置文件中的spec.revisionHistoryLimit属性增加revision数量，默认是10。</p><p>查看当前：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>rollout</span> <span class=nb>history </span><span class=n>deploy</span> <span class=n>myblog</span> <span class=c>##CHANGE-CAUSE为空</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>delete</span> <span class=o>-f</span> <span class=nb>deploy-myblog</span><span class=p>.</span><span class=n>yaml</span>    <span class=c>## 方便演示到具体效果，删掉已有deployment</span>
</span></span></code></pre></div><p>记录回滚：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>deploy-myblog</span><span class=p>.</span><span class=n>yaml</span> <span class=p>-</span><span class=n>-record</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=nb>set </span><span class=n>image</span> <span class=n>deploy</span> <span class=n>myblog</span> <span class=n>myblog</span><span class=p>=</span><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>myblog</span><span class=err>:</span><span class=n>v2</span> <span class=p>-</span><span class=n>-record</span><span class=p>=</span><span class=n>true</span>
</span></span></code></pre></div><p>查看deployment更新历史：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>rollout</span> <span class=nb>history </span><span class=n>deploy</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>deployment</span><span class=p>.</span><span class=n>extensions</span><span class=p>/</span><span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>REVISION</span>  <span class=nb>CHANGE-CAUSE</span>
</span></span><span class=line><span class=cl><span class=n>1</span>         <span class=n>kubectl</span> <span class=n>create</span> <span class=p>-</span><span class=n>-filename</span><span class=p>=</span><span class=nb>deploy-myblog</span><span class=p>.</span><span class=n>yaml</span> <span class=p>-</span><span class=n>-record</span><span class=p>=</span><span class=n>true</span>
</span></span><span class=line><span class=cl><span class=n>2</span>         <span class=n>kubectl</span> <span class=nb>set </span><span class=n>image</span> <span class=n>deploy</span> <span class=n>myblog</span> <span class=n>myblog</span><span class=p>=</span><span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>demo</span><span class=p>/</span><span class=n>myblog</span><span class=err>:</span><span class=n>v1</span> <span class=p>-</span><span class=n>-record</span><span class=p>=</span><span class=n>true</span>
</span></span></code></pre></div><p>回滚到具体的REVISION:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>rollout</span> <span class=n>undo</span> <span class=n>deploy</span> <span class=n>myblog</span> <span class=p>-</span><span class=n>-to-revision</span><span class=p>=</span><span class=n>1</span>
</span></span><span class=line><span class=cl><span class=n>deployment</span><span class=p>.</span><span class=n>extensions</span><span class=p>/</span><span class=n>myblog</span> <span class=n>rolled</span> <span class=n>back</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 访问应用测试</span>
</span></span></code></pre></div><h5 id=kubernetes调度----录屏>Kubernetes调度 录屏！！！<a hidden class=anchor aria-hidden=true href=#kubernetes调度----录屏>#</a></h5><h6 id=为何要控制pod应该如何调度>为何要控制Pod应该如何调度<a hidden class=anchor aria-hidden=true href=#为何要控制pod应该如何调度>#</a></h6><ul><li>集群中有些机器的配置高（SSD，更好的内存等），我们希望核心的服务（比如说数据库）运行在上面</li><li>某两个服务的网络传输很频繁，我们希望它们最好在同一台机器上</li><li>&mldr;&mldr;</li></ul><h6 id=nodeselector>NodeSelector<a hidden class=anchor aria-hidden=true href=#nodeselector>#</a></h6><p><code>label</code>是<code>kubernetes</code>中一个非常重要的概念，用户可以非常灵活的利用 label 来管理集群中的资源，POD 的调度可以根据节点的 label 进行特定的部署。</p><p>查看节点的label：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>nodes</span> <span class=p>-</span><span class=n>-show-labels</span>
</span></span></code></pre></div><p>为节点打label：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>label</span> <span class=n>node</span> <span class=nb>k8s-master</span> <span class=n>disktype</span><span class=p>=</span><span class=n>ssd</span>
</span></span></code></pre></div><p>当 node 被打上了相关标签后，在调度的时候就可以使用这些标签了，只需要在spec 字段中添加<code>nodeSelector</code>字段，里面是我们需要被调度的节点的 label。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>	</span><span class=c># 声明pod的网络模式为host模式，效果通docker run --net=host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/mysql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>   </span><span class=c># 使用节点选择器将Pod调度到指定label的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/demo/mysql:5.7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><h6 id=nodeaffinity>nodeAffinity<a hidden class=anchor aria-hidden=true href=#nodeaffinity>#</a></h6><p>节点亲和性 ， 比上面的<code>nodeSelector</code>更加灵活，它可以进行一些简单的逻辑组合，不只是简单的相等匹配 。分为两种，软策略和硬策略。</p><p>preferredDuringSchedulingIgnoredDuringExecution：软策略，如果你没有满足调度要求的节点的话，Pod就会忽略这条规则，继续完成调度过程，说白了就是满足条件最好了，没有满足就忽略掉的策略。</p><p>requiredDuringSchedulingIgnoredDuringExecution ： 硬策略，如果没有满足条件的节点的话，就不断重试直到满足条件为止，简单说就是你必须满足我的要求，不然我就不会调度Pod。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#要求 Pod 不能运行在128和132两个节点上，如果有个节点满足disktype=ssd的话就优先调度到这个节点上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/demo/myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>NotIn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=m>192.168.136.128</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=m>192.168.136.132</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=l>ssd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=l>sas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>这里的匹配逻辑是 label 的值在某个列表中，现在<code>Kubernetes</code>提供的操作符有下面的几种：</p><ul><li>In：label 的值在某个列表中</li><li>NotIn：label 的值不在某个列表中</li><li>Gt：label 的值大于某个值</li><li>Lt：label 的值小于某个值</li><li>Exists：某个 label 存在</li><li>DoesNotExist：某个 label 不存在</li></ul><p><em>如果nodeSelectorTerms下面有多个选项的话，满足任何一个条件就可以了；如果matchExpressions有多个选项的话，则必须同时满足这些条件才能正常调度 Pod</em></p><h6 id=污点taints与容忍tolerations>污点（Taints）与容忍（tolerations）<a hidden class=anchor aria-hidden=true href=#污点taints与容忍tolerations>#</a></h6><p>对于<code>nodeAffinity</code>无论是硬策略还是软策略方式，都是调度 Pod 到预期节点上，而<code>Taints</code>恰好与之相反，如果一个节点标记为 Taints ，除非 Pod 也被标识为可以容忍污点节点，否则该 Taints 节点不会被调度Pod。</p><p>Taints(污点)是Node的一个属性，设置了Taints(污点)后，因为有了污点，所以Kubernetes是不会将Pod调度到这个Node上的。于是Kubernetes就给Pod设置了个属性Tolerations(容忍)，只要Pod能够容忍Node上的污点，那么Kubernetes就会忽略Node上的污点，就能够(不是必须)把Pod调度过去。</p><p>比如用户希望把 Master 节点保留给 Kubernetes 系统组件使用，或者把一组具有特殊资源预留给某些 Pod，则污点就很有用了，Pod 不会再被调度到 taint 标记过的节点。taint 标记节点举例如下：</p><p>设置污点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=no>[node_name]</span> <span class=n>key</span><span class=p>=</span><span class=n>value</span><span class=err>:</span><span class=no>[effect]</span>   
</span></span><span class=line><span class=cl>      <span class=n>其中</span><span class=no>[effect]</span> <span class=n>可取值</span><span class=err>：</span> <span class=p>[</span> <span class=n>NoSchedule</span> <span class=p>|</span> <span class=n>PreferNoSchedule</span> <span class=p>|</span> <span class=n>NoExecute</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>       <span class=n>NoSchedule</span><span class=err>：</span><span class=n>一定不能被调度</span><span class=err>。</span>
</span></span><span class=line><span class=cl>       <span class=n>PreferNoSchedule</span><span class=err>：</span><span class=n>尽量不要调度</span><span class=err>。</span>
</span></span><span class=line><span class=cl>       <span class=n>NoExecute</span><span class=err>：</span><span class=n>不仅不会调度</span><span class=err>，</span><span class=n>还会驱逐Node上已有的Pod</span><span class=err>。</span>
</span></span><span class=line><span class=cl>  <span class=n>示例</span><span class=err>：</span><span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-master</span> <span class=n>smoke</span><span class=p>=</span><span class=n>true</span><span class=err>:</span><span class=n>NoSchedule</span>
</span></span></code></pre></div><p>去除污点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>去除指定key及其effect</span><span class=err>：</span>
</span></span><span class=line><span class=cl>     <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>nodes</span> <span class=no>[node_name]</span> <span class=n>key</span><span class=err>:</span><span class=no>[effect]</span><span class=p>-</span>    <span class=c>#这里的key不用指定value</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl> <span class=n>去除指定key所有的effect</span><span class=err>:</span> 
</span></span><span class=line><span class=cl>     <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>nodes</span> <span class=n>node_name</span> <span class=n>key</span><span class=p>-</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=n>示例</span><span class=err>：</span>
</span></span><span class=line><span class=cl>     <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-master</span> <span class=n>smoke</span><span class=p>=</span><span class=n>true</span><span class=err>:</span><span class=n>NoSchedule</span>
</span></span><span class=line><span class=cl>     <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-master</span> <span class=n>smoke</span><span class=err>:</span><span class=n>NoExecute</span><span class=p>-</span>
</span></span><span class=line><span class=cl>     <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-master</span> <span class=n>smoke</span><span class=p>-</span>
</span></span></code></pre></div><p>污点演示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 给k8s-slave1打上污点，smoke=true:NoSchedule</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-slave1</span> <span class=n>smoke</span><span class=p>=</span><span class=n>true</span><span class=err>:</span><span class=n>NoSchedule</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-slave2</span> <span class=n>drunk</span><span class=p>=</span><span class=n>true</span><span class=err>:</span><span class=n>NoSchedule</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 扩容myblog的Pod，观察新Pod的调度情况</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kuebctl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>scale</span> <span class=n>deploy</span> <span class=n>myblog</span> <span class=p>-</span><span class=n>-replicas</span><span class=p>=</span><span class=n>3</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-w</span>    <span class=c>## pending</span>
</span></span></code></pre></div><p>Pod容忍污点示例：<code>myblog/deployment/deploy-myblog-taint.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=n>containers</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=n>demo</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=err>:</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>demo</span><span class=p>/</span><span class=n>myblog</span>
</span></span><span class=line><span class=cl>      <span class=n>tolerations</span><span class=err>:</span> <span class=c>#设置容忍性</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>key</span><span class=err>:</span> <span class=s2>&#34;smoke&#34;</span> 
</span></span><span class=line><span class=cl>        <span class=n>operator</span><span class=err>:</span> <span class=s2>&#34;Equal&#34;</span>  <span class=c>#如果操作符为Exists，那么value属性可省略,不指定operator，默认为Equal</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span><span class=err>:</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>effect</span><span class=err>:</span> <span class=s2>&#34;NoSchedule&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>key</span><span class=err>:</span> <span class=s2>&#34;drunk&#34;</span> 
</span></span><span class=line><span class=cl>        <span class=n>operator</span><span class=err>:</span> <span class=s2>&#34;Equal&#34;</span>  <span class=c>#如果操作符为Exists，那么value属性可省略,不指定operator，默认为Equal</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span><span class=err>:</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>effect</span><span class=err>:</span> <span class=s2>&#34;NoSchedule&#34;</span>
</span></span><span class=line><span class=cl>	  <span class=c>#意思是这个Pod要容忍的有污点的Node的key是smoke Equal true,效果是NoSchedule，</span>
</span></span><span class=line><span class=cl>      <span class=c>#tolerations属性下各值必须使用引号，容忍的值都是设置Node的taints时给的值。</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>apply</span> <span class=o>-f</span> <span class=nb>deploy-myblog</span><span class=n>-taint</span><span class=p>.</span><span class=n>yaml</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=n>containers</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=n>demo</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=err>:</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>demo</span><span class=p>/</span><span class=n>myblog</span>
</span></span><span class=line><span class=cl>      <span class=n>tolerations</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>operator</span><span class=err>:</span> <span class=s2>&#34;Exists&#34;</span>
</span></span></code></pre></div><h5 id=kubernetes服务访问之service----录屏>Kubernetes服务访问之Service 录屏！！！<a hidden class=anchor aria-hidden=true href=#kubernetes服务访问之service----录屏>#</a></h5><p>通过以前的学习，我们已经能够通过Deployment来创建一组Pod来提供具有高可用性的服务。虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两个问题：</p><ul><li>Pod IP仅仅是集群内可见的虚拟IP，外部无法访问。</li><li>Pod IP会随着Pod的销毁而消失，当ReplicaSet对Pod进行动态伸缩时，Pod IP可能随时随地都会变化，这样对于我们访问这个服务带来了难度。</li></ul><h6 id=service-负载均衡之cluster-ip>Service 负载均衡之Cluster IP<a hidden class=anchor aria-hidden=true href=#service-负载均衡之cluster-ip>#</a></h6><p>service是一组pod的服务抽象，相当于一组pod的LB，负责将请求分发给对应的pod。service会为这个LB提供一个IP，一般称为cluster IP 。使用Service对象，通过selector进行标签选择，找到对应的Pod:</p><p><code>myblog/deployment/svc-myblog.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span></code></pre></div><p>操作演示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 别名</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=k>alias</span> <span class=n>kd</span><span class=p>=</span><span class=s1>&#39;kubectl -n demo&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 创建服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>svc-myblog</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>po</span> <span class=p>-</span><span class=n>-show-labels</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                      <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>    <span class=n>LABELS</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span><span class=p>-</span><span class=n>5c97d79cdb-jn7km</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>6m5s</span>   <span class=n>app</span><span class=p>=</span><span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span><span class=p>-</span><span class=n>85f4f65f99-w6jkj</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>176m</span>   <span class=n>app</span><span class=p>=</span><span class=n>mysql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>svc</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>     <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>    <span class=n>7m50s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>describe</span> <span class=n>svc</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Name</span><span class=err>:</span>              <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Namespace</span><span class=err>:</span>         <span class=n>demo</span>
</span></span><span class=line><span class=cl><span class=n>Labels</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Annotations</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Selector</span><span class=err>:</span>          <span class=n>app</span><span class=p>=</span><span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Type</span><span class=err>:</span>              <span class=n>ClusterIP</span>
</span></span><span class=line><span class=cl><span class=n>IP</span><span class=err>:</span>                <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span>
</span></span><span class=line><span class=cl><span class=n>Port</span><span class=err>:</span>              <span class=p>&lt;</span><span class=n>unset</span><span class=p>&gt;</span>  <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>
</span></span><span class=line><span class=cl><span class=n>TargetPort</span><span class=err>:</span>        <span class=n>8002</span><span class=p>/</span><span class=n>TCP</span>
</span></span><span class=line><span class=cl><span class=n>Endpoints</span><span class=err>:</span>         <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>68</span><span class=err>:</span><span class=n>8002</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=n>Affinity</span><span class=err>:</span>  <span class=n>None</span>
</span></span><span class=line><span class=cl><span class=n>Events</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 扩容myblog服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>scale</span> <span class=n>deploy</span> <span class=n>myblog</span> <span class=p>-</span><span class=n>-replicas</span><span class=p>=</span><span class=n>2</span>
</span></span><span class=line><span class=cl><span class=n>deployment</span><span class=p>.</span><span class=n>extensions</span><span class=p>/</span><span class=n>myblog</span> <span class=n>scaled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 再次查看</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>describe</span> <span class=n>svc</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Name</span><span class=err>:</span>              <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Namespace</span><span class=err>:</span>         <span class=n>demo</span>
</span></span><span class=line><span class=cl><span class=n>Labels</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Annotations</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Selector</span><span class=err>:</span>          <span class=n>app</span><span class=p>=</span><span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>Type</span><span class=err>:</span>              <span class=n>ClusterIP</span>
</span></span><span class=line><span class=cl><span class=n>IP</span><span class=err>:</span>                <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span>
</span></span><span class=line><span class=cl><span class=n>Port</span><span class=err>:</span>              <span class=p>&lt;</span><span class=n>unset</span><span class=p>&gt;</span>  <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>
</span></span><span class=line><span class=cl><span class=n>TargetPort</span><span class=err>:</span>        <span class=n>8002</span><span class=p>/</span><span class=n>TCP</span>
</span></span><span class=line><span class=cl><span class=n>Endpoints</span><span class=err>:</span>         <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>68</span><span class=err>:</span><span class=n>8002</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>158</span><span class=err>:</span><span class=n>8002</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=n>Affinity</span><span class=err>:</span>  <span class=n>None</span>
</span></span><span class=line><span class=cl><span class=n>Events</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Service与Pod如何关联:</p><p>service对象创建的同时，会创建同名的endpoints对象，若服务设置了readinessProbe, 当readinessProbe检测失败时，endpoints列表中会剔除掉对应的pod_ip，这样流量就不会分发到健康检测失败的Pod中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>endpoints</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=n>ENDPOINTS</span>                            <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>68</span><span class=err>:</span><span class=n>8002</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>158</span><span class=err>:</span><span class=n>8002</span>   <span class=n>7m</span>
</span></span></code></pre></div><p>Service Cluster-IP如何访问:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>svc</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>   <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>       <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>    <span class=n>13m</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span></code></pre></div><p>为mysql服务创建service：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span></code></pre></div><p>访问mysql：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>svc</span> <span class=n>mysql</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span>    <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>108</span><span class=p>.</span><span class=n>214</span><span class=p>.</span><span class=n>84</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>3306</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>3s</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>108</span><span class=p>.</span><span class=n>214</span><span class=p>.</span><span class=n>84</span><span class=err>:</span><span class=n>3306</span>
</span></span></code></pre></div><p>目前使用hostNetwork部署，通过宿主机ip+port访问，弊端：</p><ul><li>服务使用hostNetwork，使得宿主机的端口大量暴漏，存在安全隐患</li><li>容易引发端口冲突</li></ul><p>服务均属于k8s集群，尽可能使用k8s的网络访问，因此可以对目前myblog访问mysql的方式做改造：</p><ul><li>为mysql创建一个固定clusterIp的Service，把clusterIp配置在myblog的环境变量中</li><li>利用集群服务发现的能力，组件之间通过service name来访问</li></ul><h6 id=服务发现>服务发现<a hidden class=anchor aria-hidden=true href=#服务发现>#</a></h6><p>在k8s集群中，组件之间可以通过定义的Service名称实现通信。</p><p>演示服务发现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 演示思路：在myblog的容器中直接通过service名称访问服务，观察是否可以访问通</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 先查看服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>svc</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>     <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>      <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>    <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span>    <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>     <span class=n>59m</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span>    <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>108</span><span class=p>.</span><span class=n>214</span><span class=p>.</span><span class=n>84</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>3306</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>35m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 进入myblog容器</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span><span class=p>-</span><span class=n>5c97d79cdb-j485f</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=nv>@myblog</span><span class=p>-</span><span class=n>5c97d79cdb-j485f</span> <span class=n>myblog</span><span class=p>]</span><span class=c># curl mysql:3306</span>
</span></span><span class=line><span class=cl><span class=n>5</span><span class=p>.</span><span class=n>7</span><span class=p>.</span><span class=n>29</span> <span class=p>)</span><span class=err>→</span>  <span class=p>(</span><span class=n>mysql_native_password</span> <span class=n>ot</span> <span class=n>packets</span> <span class=n>out</span> <span class=n>of</span> <span class=n>order</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=nv>@myblog</span><span class=p>-</span><span class=n>5c97d79cdb-j485f</span> <span class=n>myblog</span><span class=p>]</span><span class=c># curl myblog/blog/index/</span>
</span></span><span class=line><span class=cl><span class=n>我的博客列表</span>
</span></span></code></pre></div><p>虽然podip和clusterip都不固定，但是service name是固定的，而且具有完全的跨集群可移植性，因此组件之间调用的同时，完全可以通过service name去通信，这样避免了大量的ip维护成本，使得服务的yaml模板更加简单。因此可以对mysql和myblog的部署进行优化改造：</p><ol><li>mysql可以去掉hostNetwork部署，使得服务只暴漏在k8s集群内部网络</li><li>configMap中数据库地址可以换成Service名称，这样跨环境的时候，配置内容基本上可以保持不用变化</li></ol><p>修改deploy-mysql.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>	</span><span class=c># 去掉此行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/mysql/data</span><span class=w>
</span></span></span></code></pre></div><p>修改configmap.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MYSQL_HOST</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mysql&#34;</span><span class=w>	</span><span class=c># 此处替换为mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MYSQL_PORT</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3306&#34;</span><span class=w>
</span></span></span></code></pre></div><p>应用修改：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>apply</span> <span class=o>-f</span> <span class=n>configmap</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>apply</span> <span class=o>-f</span> <span class=nb>deploy-mysql</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 重建pod</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>delete</span> <span class=n>po</span> <span class=n>mysql</span><span class=p>-</span><span class=n>7f747644b8</span><span class=p>-</span><span class=n>6npzn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#去掉taint</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-slave1</span> <span class=n>smoke</span><span class=p>-</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>taint</span> <span class=n>node</span> <span class=nb>k8s-slave2</span> <span class=n>drunk</span><span class=p>-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## myblog不用动，会自动因健康检测不过而重启</span>
</span></span></code></pre></div><p>服务发现实现：</p><p><code>CoreDNS</code>是一个<code>Go</code>语言实现的链式插件<code>DNS服务端</code>，是CNCF成员，是一个高性能、易扩展的<code>DNS服务端</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=nb>kube-system</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-o</span> <span class=n>wide</span><span class=p>|</span><span class=n>grep</span> <span class=n>dns</span>
</span></span><span class=line><span class=cl><span class=nb>coredns-d4475785</span><span class=p>-</span><span class=n>2w4hk</span>             <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>4d22h</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>64</span>       
</span></span><span class=line><span class=cl><span class=nb>coredns-d4475785</span><span class=n>-s49hq</span>             <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>4d22h</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>65</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 查看myblog的pod解析配置</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>exec</span> <span class=n>-ti</span> <span class=n>myblog</span><span class=p>-</span><span class=n>5c97d79cdb-j485f</span> <span class=n>bash</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=nv>@myblog</span><span class=p>-</span><span class=n>5c97d79cdb-j485f</span> <span class=n>myblog</span><span class=p>]</span><span class=c># cat /etc/resolv.conf</span>
</span></span><span class=line><span class=cl><span class=n>nameserver</span> <span class=n>10</span><span class=p>.</span><span class=n>96</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>10</span>
</span></span><span class=line><span class=cl><span class=n>search</span> <span class=n>demo</span><span class=p>.</span><span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span> <span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span> <span class=n>cluster</span><span class=p>.</span><span class=n>local</span>
</span></span><span class=line><span class=cl><span class=n>options</span> <span class=n>ndots</span><span class=err>:</span><span class=n>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 10.96.0.10 从哪来</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=nb>kube-system</span> <span class=n>get</span> <span class=n>svc</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>       <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>   <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>         <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=nb>kube-dns</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>96</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>10</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>53</span><span class=p>/</span><span class=n>UDP</span><span class=p>,</span><span class=n>53</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>51d</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 启动pod的时候，会把kube-dns服务的cluster-ip地址注入到pod的resolve解析配置中，同时添加对应的namespace的search域。 因此跨namespace通过service name访问的话，需要添加对应的namespace名称，</span>
</span></span><span class=line><span class=cl><span class=n>service_name</span><span class=p>.</span><span class=n>namespace_name</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>svc</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>         <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>   <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>   <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>kubernetes</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>96</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span>    <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>443</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>26h</span>
</span></span></code></pre></div><h6 id=service负载均衡之nodeport>Service负载均衡之NodePort<a hidden class=anchor aria-hidden=true href=#service负载均衡之nodeport>#</a></h6><p>cluster-ip为虚拟地址，只能在k8s集群内部进行访问，集群外部如果访问内部服务，实现方式之一为使用NodePort方式。NodePort会默认在 30000-32767 ，不指定的会随机使用其中一个。</p><p><code>myblog/deployment/svc-myblog-nodeport.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>apiVersion</span><span class=err>:</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>kind</span><span class=err>:</span> <span class=n>Service</span>
</span></span><span class=line><span class=cl><span class=n>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=err>:</span> <span class=nb>myblog-np</span>
</span></span><span class=line><span class=cl>  <span class=n>namespace</span><span class=err>:</span> <span class=n>demo</span>
</span></span><span class=line><span class=cl><span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>ports</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span> <span class=n>port</span><span class=err>:</span> <span class=n>80</span>
</span></span><span class=line><span class=cl>    <span class=n>protocol</span><span class=err>:</span> <span class=n>TCP</span>
</span></span><span class=line><span class=cl>    <span class=n>targetPort</span><span class=err>:</span> <span class=n>8002</span>
</span></span><span class=line><span class=cl>  <span class=n>selector</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=err>:</span> <span class=n>myblog</span>
</span></span><span class=line><span class=cl>  <span class=n>type</span><span class=err>:</span> <span class=n>NodePort</span>
</span></span></code></pre></div><p>查看并访问服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>svc-myblog</span><span class=n>-nodeport</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=p>/</span><span class=nb>myblog-np</span> <span class=n>created</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kd</span> <span class=n>get</span> <span class=n>svc</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>        <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>       <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>        <span class=n>AGE</span>
</span></span><span class=line><span class=cl><span class=n>myblog</span>      <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span>     <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>         <span class=n>102m</span>
</span></span><span class=line><span class=cl><span class=nb>myblog-np</span>   <span class=n>NodePort</span>    <span class=n>10</span><span class=p>.</span><span class=n>105</span><span class=p>.</span><span class=n>228</span><span class=p>.</span><span class=n>101</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=err>:</span><span class=n>30647</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>4s</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span>       <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>108</span><span class=p>.</span><span class=n>214</span><span class=p>.</span><span class=n>84</span>    <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>3306</span><span class=p>/</span><span class=n>TCP</span>       <span class=n>77m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#集群内每个节点的NodePort端口都会进行监听</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>136</span><span class=p>.</span><span class=n>128</span><span class=err>:</span><span class=n>30647</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>我的博客列表</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>136</span><span class=p>.</span><span class=n>131</span><span class=err>:</span><span class=n>30647</span><span class=p>/</span><span class=n>blog</span><span class=p>/</span><span class=n>index</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>我的博客列表</span>
</span></span><span class=line><span class=cl><span class=c>## 浏览器访问</span>
</span></span></code></pre></div><p>思考：</p><ol><li><p>NodePort的端口监听如何转发到对应的Pod服务？</p></li><li><p>CLUSTER-IP为虚拟IP，集群内如何通过虚拟IP访问到具体的Pod服务？</p></li></ol><h6 id=kube-proxy>kube-proxy<a hidden class=anchor aria-hidden=true href=#kube-proxy>#</a></h6><p>运行在每个节点上，监听 API Server 中服务对象的变化，再通过创建流量路由规则来实现网络的转发。<a href=https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies>参照</a></p><p>有三种模式：</p><ul><li>User space, 让 Kube-Proxy 在用户空间监听一个端口，所有的 Service 都转发到这个端口，然后 Kube-Proxy 在内部应用层对其进行转发 ， 所有报文都走一遍用户态，性能不高，k8s v1.2版本后废弃。</li><li>Iptables， 当前默认模式，完全由 IPtables 来实现， 通过各个node节点上的iptables规则来实现service的负载均衡，但是随着service数量的增大，iptables模式由于线性查找匹配、全量更新等特点，其性能会显著下降。</li><li>IPVS， 与iptables同样基于Netfilter，但是采用的hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。 k8s 1.8版本开始引入，1.11版本开始稳定，需要开启宿主机的ipvs模块。</li></ul><p>IPtables模式示意图：</p><p><img loading=lazy src=images%5cservices-iptables-overview.svg alt></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>iptables-save</span> <span class=p>|</span><span class=n>grep</span> <span class=n>-v</span> <span class=nb>myblog-np</span><span class=p>|</span><span class=n>grep</span>  <span class=s2>&#34;demo/myblog&#34;</span>
</span></span><span class=line><span class=cl><span class=n>-A</span> <span class=nb>KUBE-SERVICES</span> <span class=p>!</span> <span class=n>-s</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>16</span> <span class=n>-d</span> <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span><span class=p>/</span><span class=n>32</span> <span class=n>-p</span> <span class=n>tcp</span> <span class=n>-m</span> <span class=n>comment</span> <span class=p>-</span><span class=n>-comment</span> <span class=s2>&#34;demo/myblog: cluster IP&#34;</span> <span class=n>-m</span> <span class=n>tcp</span> <span class=p>-</span><span class=n>-dport</span> <span class=n>80</span> <span class=n>-j</span> <span class=nb>KUBE-MARK</span><span class=n>-MASQ</span>
</span></span><span class=line><span class=cl><span class=n>-A</span> <span class=nb>KUBE-SERVICES</span> <span class=n>-d</span> <span class=n>10</span><span class=p>.</span><span class=n>99</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>93</span><span class=p>/</span><span class=n>32</span> <span class=n>-p</span> <span class=n>tcp</span> <span class=n>-m</span> <span class=n>comment</span> <span class=p>-</span><span class=n>-comment</span> <span class=s2>&#34;demo/myblog: cluster IP&#34;</span> <span class=n>-m</span> <span class=n>tcp</span> <span class=p>-</span><span class=n>-dport</span> <span class=n>80</span> <span class=n>-j</span> <span class=nb>KUBE-SVC</span><span class=n>-WQNGJ7YFZKCTKPZK</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>iptables-save</span> <span class=p>|</span><span class=n>grep</span> <span class=nb>KUBE-SVC</span><span class=n>-WQNGJ7YFZKCTKPZK</span>
</span></span><span class=line><span class=cl><span class=n>-A</span> <span class=nb>KUBE-SVC</span><span class=n>-WQNGJ7YFZKCTKPZK</span> <span class=n>-m</span> <span class=n>statistic</span> <span class=p>-</span><span class=n>-mode</span> <span class=n>random</span> <span class=p>-</span><span class=n>-probability</span> <span class=n>0</span><span class=p>.</span><span class=n>50000000000</span> <span class=n>-j</span> <span class=nb>KUBE-SEP</span><span class=n>-GB5GNOM5CZH7ICXZ</span>
</span></span><span class=line><span class=cl><span class=n>-A</span> <span class=nb>KUBE-SVC</span><span class=n>-WQNGJ7YFZKCTKPZK</span> <span class=n>-j</span> <span class=nb>KUBE-SEP</span><span class=p>-</span><span class=n>7GWC3FN2JI5KLE47</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span>  <span class=nb>iptables-save</span> <span class=p>|</span><span class=n>grep</span> <span class=nb>KUBE-SEP</span><span class=n>-GB5GNOM5CZH7ICXZ</span>
</span></span><span class=line><span class=cl><span class=n>-A</span> <span class=nb>KUBE-SEP</span><span class=n>-GB5GNOM5CZH7ICXZ</span> <span class=n>-p</span> <span class=n>tcp</span> <span class=n>-m</span> <span class=n>tcp</span> <span class=n>-j</span> <span class=n>DNAT</span> <span class=p>-</span><span class=n>-to-destination</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>158</span><span class=err>:</span><span class=n>8002</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>iptables-save</span> <span class=p>|</span><span class=n>grep</span> <span class=nb>KUBE-SEP</span><span class=p>-</span><span class=n>7GWC3FN2JI5KLE47</span>
</span></span><span class=line><span class=cl><span class=n>-A</span> <span class=nb>KUBE-SEP</span><span class=p>-</span><span class=n>7GWC3FN2JI5KLE47</span> <span class=n>-p</span> <span class=n>tcp</span> <span class=n>-m</span> <span class=n>tcp</span> <span class=n>-j</span> <span class=n>DNAT</span> <span class=p>-</span><span class=n>-to-destination</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>159</span><span class=err>:</span><span class=n>8002</span>
</span></span></code></pre></div><h5 id=kubernetes服务访问之ingress>Kubernetes服务访问之Ingress<a hidden class=anchor aria-hidden=true href=#kubernetes服务访问之ingress>#</a></h5><p>对于Kubernetes的Service，无论是Cluster-Ip和NodePort均是四层的负载，集群内的服务如何实现七层的负载均衡，这就需要借助于Ingress，Ingress控制器的实现方式有很多，比如nginx, Contour, Haproxy, trafik, Istio，我们以nginx的实现为例做演示。</p><p>Ingress-nginx是7层的负载均衡器 ，负责统一管理外部对k8s cluster中service的请求。主要包含：</p><ul><li>ingress-nginx-controller：根据用户编写的ingress规则（创建的ingress的yaml文件），动态的去更改nginx服务的配置文件，并且reload重载使其生效（是自动化的，通过lua脚本来实现）；</li><li>ingress资源对象：将Nginx的配置抽象成一个Ingress对象，每添加一个新的Service资源对象只需写一个新的Ingress规则的yaml文件即可（或修改已存在的ingress规则的yaml文件）</li></ul><h6 id=示意图>示意图：<a hidden class=anchor aria-hidden=true href=#示意图>#</a></h6><p><img loading=lazy src=images%5cingress.webp alt></p><h6 id=实现逻辑>实现逻辑<a hidden class=anchor aria-hidden=true href=#实现逻辑>#</a></h6><p>1）ingress controller通过和kubernetes api交互，动态的去感知集群中ingress规则变化
2）然后读取ingress规则(规则就是写明了哪个域名对应哪个service)，按照自定义的规则，生成一段nginx配置
3）再写到nginx-ingress-controller的pod里，这个Ingress controller的pod里运行着一个Nginx服务，控制器把生成的nginx配置写入/etc/nginx.conf文件中
4）然后reload一下使配置生效。以此达到域名分别配置和动态更新的问题。</p><h6 id=安装-1>安装<a hidden class=anchor aria-hidden=true href=#安装-1>#</a></h6><p><a href=https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md>官方文档</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>wget </span><span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>raw</span><span class=p>.</span><span class=n>githubusercontent</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=nb>ingress-nginx</span><span class=p>/</span><span class=n>nginx</span><span class=p>-</span><span class=n>0</span><span class=p>.</span><span class=n>30</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>deploy</span><span class=p>/</span><span class=n>static</span><span class=p>/</span><span class=k>mandatory</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=c>## 或者使用myblog/deployment/ingress/mandatory.yaml</span>
</span></span><span class=line><span class=cl><span class=c>## 修改部署节点</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>grep</span> <span class=n>-n5</span> <span class=n>nodeSelector</span> <span class=k>mandatory</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=n>212</span><span class=p>-</span>    <span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>213</span><span class=p>-</span>      <span class=n>hostNetwork</span><span class=err>:</span> <span class=n>true</span> <span class=c>#添加为host模式</span>
</span></span><span class=line><span class=cl><span class=n>214</span><span class=p>-</span>      <span class=c># wait up to five minutes for the drain of connections</span>
</span></span><span class=line><span class=cl><span class=n>215</span><span class=p>-</span>      <span class=n>terminationGracePeriodSeconds</span><span class=err>:</span> <span class=n>300</span>
</span></span><span class=line><span class=cl><span class=n>216</span><span class=p>-</span>      <span class=n>serviceAccountName</span><span class=err>:</span> <span class=nb>nginx-ingress</span><span class=n>-serviceaccount</span>
</span></span><span class=line><span class=cl><span class=n>217</span><span class=err>:</span>      <span class=n>nodeSelector</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>218</span><span class=p>-</span>        <span class=n>ingress</span><span class=err>:</span> <span class=s2>&#34;true&#34;</span>		<span class=c>#替换此处，来决定将ingress部署在哪些机器</span>
</span></span><span class=line><span class=cl><span class=n>219</span><span class=p>-</span>      <span class=n>containers</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>220</span><span class=p>-</span>        <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=nb>nginx-ingress</span><span class=n>-controller</span>
</span></span><span class=line><span class=cl><span class=n>221</span><span class=p>-</span>          <span class=n>image</span><span class=err>:</span> <span class=n>quay</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nb>kubernetes-ingress</span><span class=n>-controller</span><span class=p>/</span><span class=nb>nginx-ingress</span><span class=n>-controller</span><span class=err>:</span><span class=n>0</span><span class=p>.</span><span class=n>30</span><span class=p>.</span><span class=n>0</span>
</span></span><span class=line><span class=cl><span class=n>222</span><span class=p>-</span>          <span class=n>args</span><span class=err>:</span>
</span></span></code></pre></div><p>使用示例：<code>myblog/deployment/ingress.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>myblog.devops.cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>ingress-nginx动态生成upstream配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>server_name myblog.devops.cn ;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>listen 80  ;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>listen [::]:80  ;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>listen 443  ssl http2 ;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>listen [::]:443  ssl http2 ;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>set $proxy_upstream_name &#34;-&#34;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>ssl_certificate_by_lua_block {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=l>certificate.call()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>location / {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=l>set $namespace      &#34;demo&#34;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=l>set $ingress_name   &#34;myblog&#34;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span></code></pre></div><h6 id=访问>访问<a hidden class=anchor aria-hidden=true href=#访问>#</a></h6><p>域名解析服务，将 <code>myblog.devops.cn</code>解析到ingress的地址上。ingress是支持多副本的，高可用的情况下，生产的配置是使用lb服务（内网F5设备，公网elb、slb、clb，解析到各ingress的机器，如何域名指向lb地址）</p><p>本机，添加如下hosts记录来演示效果。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=mf>192.168</span><span class=err>.</span><span class=mf>136.128</span> <span class=err>myblog.devops.cn</span>
</span></span></code></pre></div><p>然后，访问 <a href=http://myblog.devops.cn/blog/index/>http://myblog.devops.cn/blog/index/</a></p><p>HTTPS访问：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>#自签名证书</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>openssl</span> <span class=n>req</span> <span class=n>-x509</span> <span class=n>-nodes</span> <span class=n>-days</span> <span class=n>2920</span> <span class=n>-newkey</span> <span class=n>rsa</span><span class=err>:</span><span class=n>2048</span> <span class=n>-keyout</span> <span class=n>tls</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>tls</span><span class=p>.</span><span class=n>crt</span> <span class=n>-subj</span> <span class=s2>&#34;/CN=*.devops.cn/O=ingress-nginx&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 证书信息保存到secret对象中，ingress-nginx会读取secret对象解析出证书加载到nginx配置中</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>demo</span> <span class=n>create</span> <span class=n>secret</span> <span class=n>tls</span> <span class=nb>https-secret</span> <span class=p>-</span><span class=n>-key</span> <span class=n>tls</span><span class=p>.</span><span class=n>key</span> <span class=p>-</span><span class=n>-cert</span> <span class=n>tls</span><span class=p>.</span><span class=n>crt</span>
</span></span><span class=line><span class=cl><span class=n>secret</span><span class=p>/</span><span class=nb>https-secret</span> <span class=n>created</span>
</span></span></code></pre></div><p>修改yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myblog-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>myblog.devops.cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>myblog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>myblog.devops.cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>https-secret</span><span class=w>
</span></span></span></code></pre></div><p>然后，访问 <a href=https://myblog.devops.cn/blog/index/>https://myblog.devops.cn/blog/index/</a></p><h5 id=kubernetes认证与授权----录屏>Kubernetes认证与授权 录屏！！！<a hidden class=anchor aria-hidden=true href=#kubernetes认证与授权----录屏>#</a></h5><h6 id=apiservice安全控制>APIService安全控制<a hidden class=anchor aria-hidden=true href=#apiservice安全控制>#</a></h6><p><img loading=lazy src=images%5ck8s-apiserver-access-control-overview.svg alt></p><ul><li><p>Authentication：身份认证</p><ol><li>这个环节它面对的输入是整个<code>http request</code>，负责对来自client的请求进行身份校验，支持的方法包括:</li></ol><ul><li><p>client证书验证（https双向验证）</p></li><li><p><code>basic auth</code></p></li><li><p>普通token</p></li><li><p><code>jwt token</code>(用于serviceaccount)</p></li></ul><ol start=2><li><p>APIServer启动时，可以指定一种Authentication方法，也可以指定多种方法。如果指定了多种方法，那么APIServer将会逐个使用这些方法对客户端请求进行验证， 只要请求数据通过其中一种方法的验证，APIServer就会认为Authentication成功；</p></li><li><p>使用kubeadm引导启动的k8s集群的apiserver初始配置中，默认支持<code>client证书</code>验证和<code>serviceaccount</code>两种身份验证方式。 证书认证通过设置<code>--client-ca-file</code>根证书以及<code>--tls-cert-file</code>和<code>--tls-private-key-file</code>来开启。</p></li><li><p>在这个环节，apiserver会通过client证书或 <code>http header</code>中的字段(比如serviceaccount的<code>jwt token</code>)来识别出请求的<code>用户身份</code>，包括”user”、”group”等，这些信息将在后面的<code>authorization</code>环节用到。</p></li></ol></li><li><p>Authorization：鉴权，你可以访问哪些资源</p><ol><li><p>这个环节面对的输入是<code>http request context</code>中的各种属性，包括：<code>user</code>、<code>group</code>、<code>request path</code>（比如：<code>/api/v1</code>、<code>/healthz</code>、<code>/version</code>等）、 <code>request verb</code>(比如：<code>get</code>、<code>list</code>、<code>create</code>等)。</p></li><li><p>APIServer会将这些属性值与事先配置好的访问策略(<code>access policy</code>）相比较。APIServer支持多种<code>authorization mode</code>，包括<code>Node、RBAC、Webhook</code>等。</p></li><li><p>APIServer启动时，可以指定一种<code>authorization mode</code>，也可以指定多种<code>authorization mode</code>，如果是后者，只要Request通过了其中一种mode的授权， 那么该环节的最终结果就是授权成功。在较新版本kubeadm引导启动的k8s集群的apiserver初始配置中，<code>authorization-mode</code>的默认配置是<code>”Node,RBAC”</code>。</p></li></ol></li><li><p>Admission Control：<a href=http://docs.kubernetes.org.cn/144.html>准入控制</a>，一个控制链(层层关卡)，偏集群安全控制、管理方面。为什么说是安全相关的机制？</p><ul><li>以NamespaceLifecycle为例， 该插件确保处于Termination状态的Namespace不再接收新的对象创建请求，并拒绝请求不存在的Namespace。该插件还可以防止删除系统保留的Namespace:default，kube-system，kube-public。</li><li>NodeRestriction， 此插件限制kubelet修改Node和Pod对象，这样的kubelets只允许修改绑定到Node的Pod API对象，以后版本可能会增加额外的限制 。</li></ul></li></ul><p>为什么我们执行命令kubectl命令，可以直接管理k8s集群资源？</p><h6 id=kubectl的认证授权>kubectl的认证授权<a hidden class=anchor aria-hidden=true href=#kubectl的认证授权>#</a></h6><p>kubectl的日志调试级别：</p><table><thead><tr><th style=text-align:left>信息</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left>v=0</td><td style=text-align:left>通常，这对操作者来说总是可见的。</td></tr><tr><td style=text-align:left>v=1</td><td style=text-align:left>当您不想要很详细的输出时，这个是一个合理的默认日志级别。</td></tr><tr><td style=text-align:left>v=2</td><td style=text-align:left>有关服务和重要日志消息的有用稳定状态信息，这些信息可能与系统中的重大更改相关。这是大多数系统推荐的默认日志级别。</td></tr><tr><td style=text-align:left>v=3</td><td style=text-align:left>关于更改的扩展信息。</td></tr><tr><td style=text-align:left>v=4</td><td style=text-align:left>调试级别信息。</td></tr><tr><td style=text-align:left>v=6</td><td style=text-align:left>显示请求资源。</td></tr><tr><td style=text-align:left>v=7</td><td style=text-align:left>显示 HTTP 请求头。</td></tr><tr><td style=text-align:left>v=8</td><td style=text-align:left>显示 HTTP 请求内容。</td></tr><tr><td style=text-align:left>v=9</td><td style=text-align:left>显示 HTTP 请求内容，并且不截断内容。</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>nodes</span> <span class=n>-v</span><span class=p>=</span><span class=n>7</span>
</span></span><span class=line><span class=cl><span class=n>I0329</span> <span class=n>20</span><span class=err>:</span><span class=n>20</span><span class=err>:</span><span class=n>08</span><span class=p>.</span><span class=n>633065</span>    <span class=n>3979</span> <span class=n>loader</span><span class=p>.</span><span class=n>go</span><span class=err>:</span><span class=n>359</span><span class=p>]</span> <span class=n>Config</span> <span class=n>loaded</span> <span class=n>from</span> <span class=n>file</span> <span class=p>/</span><span class=n>root</span><span class=p>/.</span><span class=n>kube</span><span class=p>/</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=n>I0329</span> <span class=n>20</span><span class=err>:</span><span class=n>20</span><span class=err>:</span><span class=n>08</span><span class=p>.</span><span class=n>633797</span>    <span class=n>3979</span> <span class=n>round_trippers</span><span class=p>.</span><span class=n>go</span><span class=err>:</span><span class=n>416</span><span class=p>]</span> <span class=n>GET</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>136</span><span class=p>.</span><span class=n>128</span><span class=err>:</span><span class=n>6443</span><span class=p>/</span><span class=n>api</span><span class=p>/</span><span class=n>v1</span><span class=p>/</span><span class=n>nodes</span><span class=k>?</span><span class=n>limit</span><span class=p>=</span><span class=n>500</span>
</span></span></code></pre></div><p><code>kubeadm init</code>启动完master节点后，会默认输出类似下面的提示内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>Your Kubernetes master has initialized successfully!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>... ...
</span></span></code></pre></div><p>这些信息是在告知我们如何配置<code>kubeconfig</code>文件。按照上述命令配置后，master节点上的<code>kubectl</code>就可以直接使用<code>$HOME/.kube/config</code>的信息访问<code>k8s cluster</code>了。 并且，通过这种配置方式，<code>kubectl</code>也拥有了整个集群的管理员(root)权限。</p><p>很多K8s初学者在这里都会有疑问：</p><ul><li>当<code>kubectl</code>使用这种<code>kubeconfig</code>方式访问集群时，<code>Kubernetes</code>的<code>kube-apiserver</code>是如何对来自<code>kubectl</code>的访问进行身份验证(<code>authentication</code>)和授权(<code>authorization</code>)的呢？</li><li>为什么来自<code>kubectl</code>的请求拥有最高的管理员权限呢？</li></ul><p>查看<code>/root/.kube/config</code>文件：</p><p>前面提到过apiserver的authentication支持通过<code>tls client certificate、basic auth、token</code>等方式对客户端发起的请求进行身份校验， 从kubeconfig信息来看，kubectl显然在请求中使用了<code>tls client certificate</code>的方式，即客户端的证书。</p><p>证书base64解码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>echo </span><span class=n>xxxxxxxxxxxxxx</span> <span class=p>|</span><span class=n>base64</span> <span class=n>-d</span> <span class=p>&gt;</span> <span class=n>kubectl</span><span class=p>.</span><span class=n>crt</span>
</span></span></code></pre></div><p>说明在认证阶段，<code>apiserver</code>会首先使用<code>--client-ca-file</code>配置的CA证书去验证kubectl提供的证书的有效性,基本的方式 ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span>  <span class=n>openssl</span> <span class=n>verify</span> <span class=n>-CAfile</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>ca</span><span class=p>.</span><span class=n>crt</span> <span class=n>kubectl</span><span class=p>.</span><span class=n>crt</span>
</span></span><span class=line><span class=cl><span class=n>kubectl</span><span class=p>.</span><span class=n>crt</span><span class=err>:</span> <span class=n>OK</span>
</span></span></code></pre></div><p>除了认证身份，还会取出必要的信息供授权阶段使用，文本形式查看证书内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>openssl</span> <span class=n>x509</span> <span class=n>-in</span> <span class=n>kubectl</span><span class=p>.</span><span class=n>crt</span> <span class=n>-text</span>
</span></span><span class=line><span class=cl><span class=n>Certificate</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Data</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Version</span><span class=err>:</span> <span class=n>3</span> <span class=p>(</span><span class=n>0x2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Serial</span> <span class=n>Number</span><span class=err>:</span> <span class=n>4736260165981664452</span> <span class=p>(</span><span class=n>0x41ba9386f52b74c4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Signature</span> <span class=n>Algorithm</span><span class=err>:</span> <span class=n>sha256WithRSAEncryption</span>
</span></span><span class=line><span class=cl>        <span class=n>Issuer</span><span class=err>:</span> <span class=n>CN</span><span class=p>=</span><span class=n>kubernetes</span>
</span></span><span class=line><span class=cl>        <span class=n>Validity</span>
</span></span><span class=line><span class=cl>            <span class=n>Not</span> <span class=n>Before</span><span class=err>:</span> <span class=n>Feb</span> <span class=n>10</span> <span class=n>07</span><span class=err>:</span><span class=n>33</span><span class=err>:</span><span class=n>39</span> <span class=n>2020</span> <span class=n>GMT</span>
</span></span><span class=line><span class=cl>            <span class=n>Not</span> <span class=n>After</span> <span class=err>:</span> <span class=n>Feb</span>  <span class=n>9</span> <span class=n>07</span><span class=err>:</span><span class=n>33</span><span class=err>:</span><span class=n>40</span> <span class=n>2021</span> <span class=n>GMT</span>
</span></span><span class=line><span class=cl>        <span class=n>Subject</span><span class=err>:</span> <span class=n>O</span><span class=p>=</span><span class=n>system</span><span class=err>:</span><span class=n>masters</span><span class=p>,</span> <span class=n>CN</span><span class=p>=</span><span class=nb>kubernetes-admin</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span></code></pre></div><p>认证通过后，提取出签发证书时指定的CN(Common Name),<code>kubernetes-admin</code>，作为请求的用户名 (User Name), 从证书中提取O(Organization)字段作为请求用户所属的组 (Group)，<code>group = system:masters</code>，然后传递给后面的授权模块。</p><p>kubeadm在init初始引导集群启动过程中，创建了许多<code>default</code>的<code>role、clusterrole、rolebinding</code>和<code>clusterrolebinding</code>， 在k8s有关RBAC的官方文档中，我们看到下面一些<code>default clusterrole</code>列表:</p><p><img loading=lazy src=C:%5cUsers%5cliyongxin%5cDesktop%5cwework%5c%e8%80%81%e7%94%b7%e5%ad%a9%5c%e8%ae%ad%e7%bb%83%e8%90%a5%5cimages%5ckubeadm-default-clusterrole-list.png alt></p><p>其中第一个cluster-admin这个cluster role binding绑定了system:masters group，这和authentication环节传递过来的身份信息不谋而合。 沿着system:masters group对应的cluster-admin clusterrolebinding“追查”下去，真相就会浮出水面。</p><p>我们查看一下这一binding：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl describe clusterrolebinding cluster-admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Name</span><span class=p>:</span><span class=w>         </span><span class=l>cluster-admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>       </span><span class=l>kubernetes.io/bootstrapping=rbac-defaults</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations:  rbac.authorization.kubernetes.io/autoupdate</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Role</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Kind</span><span class=p>:</span><span class=w>  </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Name</span><span class=p>:</span><span class=w>  </span><span class=l>cluster-admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>Kind   Name            Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>---- <span class=w>  </span>---- <span class=w>           </span>---------<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>Group  system:masters</span><span class=w>
</span></span></span></code></pre></div><p>我们看到在kube-system名字空间中，一个名为cluster-admin的clusterrolebinding将cluster-admin cluster role与system:masters Group绑定到了一起， 赋予了所有归属于system:masters Group中用户cluster-admin角色所拥有的权限。</p><p>我们再来查看一下cluster-admin这个role的具体权限信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>describe</span> <span class=n>clusterrole</span> <span class=nb>cluster-admin</span>
</span></span><span class=line><span class=cl><span class=n>Name</span><span class=err>:</span>         <span class=nb>cluster-admin</span>
</span></span><span class=line><span class=cl><span class=n>Labels</span><span class=err>:</span>       <span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>bootstrapping</span><span class=p>=</span><span class=nb>rbac-defaults</span>
</span></span><span class=line><span class=cl><span class=n>Annotations</span><span class=err>:</span>  <span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>autoupdate</span><span class=err>:</span> <span class=n>true</span>
</span></span><span class=line><span class=cl><span class=n>PolicyRule</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>Resources</span>  <span class=nb>Non-Resource</span> <span class=n>URLs</span>  <span class=n>Resource</span> <span class=n>Names</span>  <span class=n>Verbs</span>
</span></span><span class=line><span class=cl>  <span class=p>---------</span>  <span class=p>-----------------</span>  <span class=p>--------------</span>  <span class=p>-----</span>
</span></span><span class=line><span class=cl>  <span class=p>*.*</span>        <span class=p>[]</span>                 <span class=p>[]</span>              <span class=p>[*]</span>
</span></span><span class=line><span class=cl>             <span class=p>[*]</span>                <span class=p>[]</span>              <span class=p>[*]</span>
</span></span></code></pre></div><p>非资源类，如查看集群健康状态。</p><p><img loading=lazy src=images%5chow-kubectl-be-authorized.png alt></p><h6 id=rbac>RBAC<a hidden class=anchor aria-hidden=true href=#rbac>#</a></h6><p>Role-Based Access Control，基于角色的访问控制， apiserver启动参数添加&ndash;authorization-mode=RBAC 来启用RBAC认证模式，kubeadm安装的集群默认已开启。<a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>官方介绍</a></p><p>查看开启：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># master节点查看apiserver进程</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>ps </span><span class=n>aux</span> <span class=p>|</span><span class=n>grep</span> <span class=n>apiserver</span>
</span></span></code></pre></div><p>RBAC模式引入了4个资源：</p><ul><li><p>Role，角色</p><p>一个Role只能授权访问单个namespace</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## 示例定义一个名为pod-reader的角色，该角色具有读取default这个命名空间下的pods的权限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w> </span><span class=c># &#34;&#34; indicates the core API group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## apiGroups: &#34;&#34;,&#34;apps&#34;, &#34;autoscaling&#34;, &#34;batch&#34;, kubectl api-versions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## resources: &#34;services&#34;, &#34;pods&#34;,&#34;deployments&#34;... kubectl api-resources</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## verbs: &#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;update&#34;, &#34;patch&#34;, &#34;delete&#34;, &#34;exec&#34;</span><span class=w>
</span></span></span></code></pre></div></li><li><p>ClusterRole</p><p>一个ClusterRole能够授予和Role一样的权限，但是它是集群范围内的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## 定义一个集群角色，名为secret-reader，该角色可以读取所有的namespace中的secret资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># &#34;namespace&#34; omitted since ClusterRoles are not namespaced</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;secrets&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Rolebinding</p><p>将role中定义的权限分配给用户和用户组。RoleBinding包含主题（users,groups,或service accounts）和授予角色的引用。对于namespace内的授权使用RoleBinding，集群范围内使用ClusterRoleBinding。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## 定义一个角色绑定，将pod-reader这个role的权限授予给jane这个User，使得jane可以在读取default这个命名空间下的所有的pod数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>read-pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User  </span><span class=w> </span><span class=c>#这里可以是User,Group,ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jane </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w> </span><span class=c>#这里可以是Role或者ClusterRole,若是ClusterRole，则权限也仅限于rolebinding的内部</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-reader</span><span class=w> </span><span class=c># match the name of the Role or ClusterRole you wish to bind to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></div><p><em>注意：rolebinding既可以绑定role，也可以绑定clusterrole，当绑定clusterrole的时候，subject的权限也会被限定于rolebinding定义的namespace内部，若想跨namespace，需要使用clusterrolebinding</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## 定义一个角色绑定，将dave这个用户和secret-reader这个集群角色绑定，虽然secret-reader是集群角色，但是因为是使用rolebinding绑定的，因此dave的权限也会被限制在development这个命名空间内</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This role binding allows &#34;dave&#34; to read secrets in the &#34;development&#34; namespace.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># You need to already have a ClusterRole named &#34;secret-reader&#34;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>read-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The namespace of the RoleBinding determines where the permissions are granted.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># This only grants permissions within the &#34;development&#34; namespace.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>development</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dave</span><span class=w> </span><span class=c># Name is case sensitive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dave</span><span class=w> </span><span class=c># Name is case sensitive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></div><p>考虑一个场景： 如果集群中有多个namespace分配给不同的管理员，每个namespace的权限是一样的，就可以只定义一个clusterrole，然后通过rolebinding将不同的namespace绑定到管理员身上，否则就需要每个namespace定义一个Role，然后做一次rolebinding。</p></li><li><p>ClusterRolebingding</p><p>允许跨namespace进行授权</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This cluster role binding allows anyone in the &#34;manager&#34; group to read secrets in any namespace.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>read-secrets-global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>manager</span><span class=w> </span><span class=c># Name is case sensitive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></div></li></ul><p><img loading=lazy src=images%5crbac-2.jpg alt></p><h6 id=kubelet的认证授权>kubelet的认证授权<a hidden class=anchor aria-hidden=true href=#kubelet的认证授权>#</a></h6><p>查看kubelet进程</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>systemctl</span> <span class=n>status</span> <span class=n>kubelet</span>
</span></span><span class=line><span class=cl><span class=err>●</span> <span class=n>kubelet</span><span class=p>.</span><span class=n>service</span> <span class=p>-</span> <span class=n>kubelet</span><span class=err>:</span> <span class=n>The</span> <span class=n>Kubernetes</span> <span class=n>Node</span> <span class=n>Agent</span>
</span></span><span class=line><span class=cl>   <span class=n>Loaded</span><span class=err>:</span> <span class=n>loaded</span> <span class=p>(/</span><span class=n>etc</span><span class=p>/</span><span class=n>systemd</span><span class=p>/</span><span class=n>system</span><span class=p>/</span><span class=n>kubelet</span><span class=p>.</span><span class=n>service</span><span class=p>;</span> <span class=n>enabled</span><span class=p>;</span> <span class=n>vendor</span> <span class=n>preset</span><span class=err>:</span> <span class=n>disabled</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>Drop-In</span><span class=err>:</span> <span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>systemd</span><span class=p>/</span><span class=n>system</span><span class=p>/</span><span class=n>kubelet</span><span class=p>.</span><span class=n>service</span><span class=p>.</span><span class=n>d</span>
</span></span><span class=line><span class=cl>           <span class=err>└─</span><span class=n>10-kubeadm</span><span class=p>.</span><span class=n>conf</span>
</span></span><span class=line><span class=cl>   <span class=n>Active</span><span class=err>:</span> <span class=n>active</span> <span class=p>(</span><span class=n>running</span><span class=p>)</span> <span class=n>since</span> <span class=n>Wed</span> <span class=n>2020</span><span class=p>-</span><span class=n>04</span><span class=p>-</span><span class=n>01</span> <span class=n>02</span><span class=err>:</span><span class=n>34</span><span class=err>:</span><span class=n>13</span> <span class=n>CST</span><span class=p>;</span> <span class=n>1</span> <span class=n>day</span> <span class=n>14h</span> <span class=n>ago</span>
</span></span><span class=line><span class=cl>     <span class=n>Docs</span><span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>docs</span><span class=p>/</span>
</span></span><span class=line><span class=cl> <span class=n>Main</span> <span class=n>PID</span><span class=err>:</span> <span class=n>851</span> <span class=p>(</span><span class=n>kubelet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Tasks</span><span class=err>:</span> <span class=n>21</span>
</span></span><span class=line><span class=cl>   <span class=n>Memory</span><span class=err>:</span> <span class=n>127</span><span class=p>.</span><span class=n>1M</span>
</span></span><span class=line><span class=cl>   <span class=n>CGroup</span><span class=err>:</span> <span class=p>/</span><span class=n>system</span><span class=p>.</span><span class=n>slice</span><span class=p>/</span><span class=n>kubelet</span><span class=p>.</span><span class=n>service</span>
</span></span><span class=line><span class=cl>           <span class=err>└─</span><span class=n>851</span> <span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>kubelet</span> <span class=p>-</span><span class=n>-bootstrap-kubeconfig</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=nb>bootstrap-kubelet</span><span class=p>.</span><span class=n>conf</span> <span class=p>-</span><span class=n>-kubeconfig</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>kubelet</span><span class=p>.</span><span class=n>conf</span>
</span></span></code></pre></div><p>查看<code>/etc/kubernetes/kubelet.conf</code>，解析证书：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>echo </span><span class=n>xxxxx</span> <span class=p>|</span><span class=n>base64</span> <span class=n>-d</span> <span class=p>&gt;</span><span class=n>kubelet</span><span class=p>.</span><span class=n>crt</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>openssl</span> <span class=n>x509</span> <span class=n>-in</span> <span class=n>kubelet</span><span class=p>.</span><span class=n>crt</span> <span class=n>-text</span>
</span></span><span class=line><span class=cl><span class=n>Certificate</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Data</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Version</span><span class=err>:</span> <span class=n>3</span> <span class=p>(</span><span class=n>0x2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Serial</span> <span class=n>Number</span><span class=err>:</span> <span class=n>9059794385454520113</span> <span class=p>(</span><span class=n>0x7dbadafe23185731</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Signature</span> <span class=n>Algorithm</span><span class=err>:</span> <span class=n>sha256WithRSAEncryption</span>
</span></span><span class=line><span class=cl>        <span class=n>Issuer</span><span class=err>:</span> <span class=n>CN</span><span class=p>=</span><span class=n>kubernetes</span>
</span></span><span class=line><span class=cl>        <span class=n>Validity</span>
</span></span><span class=line><span class=cl>            <span class=n>Not</span> <span class=n>Before</span><span class=err>:</span> <span class=n>Feb</span> <span class=n>10</span> <span class=n>07</span><span class=err>:</span><span class=n>33</span><span class=err>:</span><span class=n>39</span> <span class=n>2020</span> <span class=n>GMT</span>
</span></span><span class=line><span class=cl>            <span class=n>Not</span> <span class=n>After</span> <span class=err>:</span> <span class=n>Feb</span>  <span class=n>9</span> <span class=n>07</span><span class=err>:</span><span class=n>33</span><span class=err>:</span><span class=n>40</span> <span class=n>2021</span> <span class=n>GMT</span>
</span></span><span class=line><span class=cl>        <span class=n>Subject</span><span class=err>:</span> <span class=n>O</span><span class=p>=</span><span class=n>system</span><span class=err>:</span><span class=n>nodes</span><span class=p>,</span> <span class=n>CN</span><span class=p>=</span><span class=n>system</span><span class=err>:</span><span class=n>node</span><span class=err>:</span><span class=n>master</span><span class=p>-</span><span class=n>1</span>
</span></span></code></pre></div><p>得到我们期望的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Subject: <span class=nv>O</span><span class=o>=</span>system:nodes, <span class=nv>CN</span><span class=o>=</span>system:node:k8s-master
</span></span></code></pre></div><p>我们知道，k8s会把O作为Group来进行请求，因此如果有权限绑定给这个组，肯定在clusterrolebinding的定义中可以找得到。因此尝试去找一下绑定了system:nodes组的clusterrolebinding</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>clusterrolebinding</span><span class=p>|</span><span class=n>awk</span> <span class=s1>&#39;NR&gt;1{print $1}&#39;</span><span class=p>|</span><span class=n>xargs</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>clusterrolebinding</span> <span class=n>-oyaml</span><span class=p>|</span><span class=n>grep</span> <span class=n>-n10</span> <span class=n>system</span><span class=err>:</span><span class=n>nodes</span>
</span></span><span class=line><span class=cl><span class=n>98</span><span class=p>-</span>  <span class=n>roleRef</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>99</span><span class=p>-</span>    <span class=n>apiGroup</span><span class=err>:</span> <span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span>
</span></span><span class=line><span class=cl><span class=n>100</span><span class=p>-</span>    <span class=n>kind</span><span class=err>:</span> <span class=n>ClusterRole</span>
</span></span><span class=line><span class=cl><span class=n>101</span><span class=p>-</span>    <span class=n>name</span><span class=err>:</span> <span class=n>system</span><span class=err>:</span><span class=n>certificates</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=err>:</span><span class=n>certificatesigningrequests</span><span class=err>:</span><span class=n>selfnodeclient</span>
</span></span><span class=line><span class=cl><span class=n>102</span><span class=p>-</span>  <span class=n>subjects</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>103</span><span class=p>-</span>  <span class=p>-</span> <span class=n>apiGroup</span><span class=err>:</span> <span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span>
</span></span><span class=line><span class=cl><span class=n>104</span><span class=p>-</span>    <span class=n>kind</span><span class=err>:</span> <span class=nb>Group
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=n>105</span><span class=err>:</span>    <span class=n>name</span><span class=err>:</span> <span class=n>system</span><span class=err>:</span><span class=n>nodes</span>
</span></span><span class=line><span class=cl><span class=n>106</span><span class=p>--</span> <span class=n>apiVersion</span><span class=err>:</span> <span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>107</span><span class=p>-</span>  <span class=n>kind</span><span class=err>:</span> <span class=n>ClusterRoleBinding</span>
</span></span><span class=line><span class=cl><span class=n>108</span><span class=p>-</span>  <span class=n>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>109</span><span class=p>-</span>    <span class=n>creationTimestamp</span><span class=err>:</span> <span class=s2>&#34;2020-02-10T07:34:02Z&#34;</span>
</span></span><span class=line><span class=cl><span class=n>110</span><span class=p>-</span>    <span class=n>name</span><span class=err>:</span> <span class=n>kubeadm</span><span class=err>:</span><span class=nb>node-proxier</span>
</span></span><span class=line><span class=cl><span class=n>111</span><span class=p>-</span>    <span class=n>resourceVersion</span><span class=err>:</span> <span class=s2>&#34;213&#34;</span>
</span></span><span class=line><span class=cl><span class=n>112</span><span class=p>-</span>    <span class=n>selfLink</span><span class=err>:</span> <span class=p>/</span><span class=n>apis</span><span class=p>/</span><span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>v1</span><span class=p>/</span><span class=n>clusterrolebindings</span><span class=p>/</span><span class=n>kubeadm</span><span class=k>%</span><span class=n>3Anode-proxier</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>describe</span> <span class=n>clusterrole</span> <span class=n>system</span><span class=err>:</span><span class=n>certificates</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=err>:</span><span class=n>certificatesigningrequests</span><span class=err>:</span><span class=n>selfnodeclient</span>
</span></span><span class=line><span class=cl><span class=n>Name</span><span class=err>:</span>         <span class=n>system</span><span class=err>:</span><span class=n>certificates</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=err>:</span><span class=n>certificatesigningrequests</span><span class=err>:</span><span class=n>selfnodeclient</span>
</span></span><span class=line><span class=cl><span class=n>Labels</span><span class=err>:</span>       <span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>bootstrapping</span><span class=p>=</span><span class=nb>rbac-defaults</span>
</span></span><span class=line><span class=cl><span class=n>Annotations</span><span class=err>:</span>  <span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>autoupdate</span><span class=err>:</span> <span class=n>true</span>
</span></span><span class=line><span class=cl><span class=n>PolicyRule</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>Resources</span>                                                      <span class=nb>Non-Resource</span> <span class=n>URLs</span>  <span class=n>Resource</span> <span class=n>Names</span>  <span class=n>Verbs</span>
</span></span><span class=line><span class=cl>  <span class=p>---------</span>                                                      <span class=p>-----------------</span>  <span class=p>--------------</span>  <span class=p>-----</span>
</span></span><span class=line><span class=cl>  <span class=n>certificatesigningrequests</span><span class=p>.</span><span class=n>certificates</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>selfnodeclient</span>  <span class=p>[]</span>                 <span class=p>[]</span>              <span class=no>[create]</span>
</span></span></code></pre></div><p>结局有点意外，除了<code>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</code>外，没有找到system相关的rolebindings，显然和我们的理解不一样。 尝试去找<a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>资料</a>，发现了这么一段 :</p><table><thead><tr><th style=text-align:left>Default ClusterRole</th><th style=text-align:left>Default ClusterRoleBinding</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>system:kube-scheduler</td><td style=text-align:left>system:kube-scheduler user</td><td style=text-align:left>Allows access to the resources required by the <a href=https://kubernetes.io/docs/reference/generated/kube-scheduler/>scheduler</a>component.</td></tr><tr><td style=text-align:left>system:volume-scheduler</td><td style=text-align:left>system:kube-scheduler user</td><td style=text-align:left>Allows access to the volume resources required by the kube-scheduler component.</td></tr><tr><td style=text-align:left>system:kube-controller-manager</td><td style=text-align:left>system:kube-controller-manager user</td><td style=text-align:left>Allows access to the resources required by the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/>controller manager</a> component. The permissions required by individual controllers are detailed in the <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#controller-roles>controller roles</a>.</td></tr><tr><td style=text-align:left>system:node</td><td style=text-align:left>None</td><td style=text-align:left>Allows access to resources required by the kubelet, <strong>including read access to all secrets, and write access to all pod status objects</strong>. You should use the <a href=https://kubernetes.io/docs/reference/access-authn-authz/node/>Node authorizer</a> and <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction>NodeRestriction admission plugin</a> instead of the <code>system:node</code> role, and allow granting API access to kubelets based on the Pods scheduled to run on them. The <code>system:node</code> role only exists for compatibility with Kubernetes clusters upgraded from versions prior to v1.8.</td></tr><tr><td style=text-align:left>system:node-proxier</td><td style=text-align:left>system:kube-proxy user</td><td style=text-align:left>Allows access to the resources required by the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/>kube-proxy</a>component.</td></tr></tbody></table><p>大致意思是说：之前会定义system:node这个角色，目的是为了kubelet可以访问到必要的资源，包括所有secret的读权限及更新pod状态的写权限。如果1.8版本后，是建议使用 <a href=https://kubernetes.io/docs/reference/access-authn-authz/node/>Node authorizer</a> and <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction>NodeRestriction admission plugin</a> 来代替这个角色的。</p><p>我们目前使用1.16，查看一下授权策略：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>ps </span><span class=n>axu</span><span class=p>|</span><span class=n>grep</span> <span class=n>apiserver</span>
</span></span><span class=line><span class=cl><span class=nb>kube-apiserver</span> <span class=p>-</span><span class=n>-authorization-mode</span><span class=p>=</span><span class=n>Node</span><span class=p>,</span><span class=n>RBAC</span>  <span class=p>-</span><span class=n>-enable-admission-plugins</span><span class=p>=</span><span class=n>NodeRestriction</span>
</span></span></code></pre></div><p>查看一下官网对Node authorizer的介绍：</p><p><em>Node authorization is a special-purpose authorization mode that specifically authorizes API requests made by kubelets.</em></p><p><em>In future releases, the node authorizer may add or remove permissions to ensure kubelets have the minimal set of permissions required to operate correctly.</em></p><p><em>In order to be authorized by the Node authorizer, kubelets must use a credential that identifies them as being in the <code>system:nodes</code> group, with a username of <code>system:node:&lt;nodeName></code></em></p><h6 id=service-account>Service Account<a hidden class=anchor aria-hidden=true href=#service-account>#</a></h6><p>前面说，认证可以通过证书，也可以通过使用ServiceAccount（服务账户）的方式来做认证。大多数时候，我们在基于k8s做二次开发时都是选择通过serviceaccount的方式。我们之前访问dashboard的时候，是如何做的？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## 新建一个名为admin的serviceaccount，并且把名为cluster-admin的这个集群角色的权限授予新建的serviceaccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-dashboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rbac.authorization.kubernetes.io/autoupdate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster-admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-dashboard</span><span class=w>
</span></span></span></code></pre></div><p>我们查看一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=nb>kubernetes-dashboard</span> <span class=n>get</span> <span class=n>sa</span> <span class=n>admin</span> <span class=n>-o</span> <span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=n>apiVersion</span><span class=err>:</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>kind</span><span class=err>:</span> <span class=n>ServiceAccount</span>
</span></span><span class=line><span class=cl><span class=n>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>creationTimestamp</span><span class=err>:</span> <span class=s2>&#34;2020-04-01T11:59:21Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=err>:</span> <span class=n>admin</span>
</span></span><span class=line><span class=cl>  <span class=n>namespace</span><span class=err>:</span> <span class=nb>kubernetes-dashboard</span>
</span></span><span class=line><span class=cl>  <span class=n>resourceVersion</span><span class=err>:</span> <span class=s2>&#34;1988878&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>selfLink</span><span class=err>:</span> <span class=p>/</span><span class=n>api</span><span class=p>/</span><span class=n>v1</span><span class=p>/</span><span class=n>namespaces</span><span class=p>/</span><span class=nb>kubernetes-dashboard</span><span class=p>/</span><span class=n>serviceaccounts</span><span class=p>/</span><span class=n>admin</span>
</span></span><span class=line><span class=cl>  <span class=n>uid</span><span class=err>:</span> <span class=n>639ecc3e</span><span class=p>-</span><span class=n>74d9</span><span class=p>-</span><span class=n>11ea-a59b</span><span class=p>-</span><span class=n>000c29dfd73f</span>
</span></span><span class=line><span class=cl><span class=n>secrets</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=nb>admin-token</span><span class=n>-lfsrf</span>
</span></span></code></pre></div><p>注意到serviceaccount上默认绑定了一个名为admin-token-lfsrf的secret，我们查看一下secret</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=nb>kubernetes-dashboard</span> <span class=n>describe</span> <span class=n>secret</span> <span class=nb>admin-token</span><span class=n>-lfsrf</span>
</span></span><span class=line><span class=cl><span class=n>Name</span><span class=err>:</span>         <span class=nb>admin-token</span><span class=n>-lfsrf</span>
</span></span><span class=line><span class=cl><span class=n>Namespace</span><span class=err>:</span>    <span class=nb>kubernetes-dashboard</span>
</span></span><span class=line><span class=cl><span class=n>Labels</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Annotations</span><span class=err>:</span>  <span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nb>service-account</span><span class=p>.</span><span class=n>name</span><span class=err>:</span> <span class=n>admin</span>
</span></span><span class=line><span class=cl>              <span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nb>service-account</span><span class=p>.</span><span class=n>uid</span><span class=err>:</span> <span class=n>639ecc3e</span><span class=p>-</span><span class=n>74d9</span><span class=p>-</span><span class=n>11ea-a59b</span><span class=p>-</span><span class=n>000c29dfd73f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Type</span><span class=err>:</span>  <span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nb>service-account</span><span class=n>-token</span>
</span></span><span class=line><span class=cl><span class=n>Data</span>
</span></span><span class=line><span class=cl><span class=p>====</span>
</span></span><span class=line><span class=cl><span class=n>ca</span><span class=p>.</span><span class=n>crt</span><span class=err>:</span>     <span class=n>1025</span> <span class=n>bytes</span>
</span></span><span class=line><span class=cl><span class=n>namespace</span><span class=err>:</span>  <span class=n>4</span> <span class=n>bytes</span>
</span></span><span class=line><span class=cl><span class=n>token</span><span class=err>:</span>      <span class=n>eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9</span><span class=p>.</span><span class=n>eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZW1vIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFkbWluLXRva2VuLWxmc3JmIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNjM5ZWNjM2UtNzRkOS0xMWVhLWE1OWItMDAwYzI5ZGZkNzNmIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlbW86YWRtaW4ifQ</span><span class=p>.</span><span class=nb>ffGCU4L5LxTsMx3NcNixpjT6nLBi-pmstb4I</span><span class=n>-W61nLOzNaMmYSEIwAaugKMzNR</span><span class=p>-</span><span class=n>2VwM14WbuG04dOeO67niJeP6n8-ALkl-vineoYCsUjrzJ09qpM3TNUPatHFqyjcqJ87h4VKZEqk2qCCmLxB6AGbEHpVFkoge40vHs56cIymFGZLe53JZkhu3pwYuS4jpXytV30Ad-HwmQDUu_Xqcifni6tDYPCfKz2CZlcOfwqHeGIHJjDGVBKqhEeo8PhStoofBU6Y4OjObP7HGuTY-Foo4QindNnpp0QU6vSb7kiOiQ4twpayybH8PTf73dtdFt46UF6mGjskWgevgolvmO8A</span>
</span></span></code></pre></div><p>开发的时候如何去调用k8s的api:</p><ol><li>curl演示</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>-k</span>  <span class=n>-H</span> <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZW1vIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFkbWluLXRva2VuLWxmc3JmIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNjM5ZWNjM2UtNzRkOS0xMWVhLWE1OWItMDAwYzI5ZGZkNzNmIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlbW86YWRtaW4ifQ.ffGCU4L5LxTsMx3NcNixpjT6nLBi-pmstb4I-W61nLOzNaMmYSEIwAaugKMzNR-2VwM14WbuG04dOeO67niJeP6n8-ALkl-vineoYCsUjrzJ09qpM3TNUPatHFqyjcqJ87h4VKZEqk2qCCmLxB6AGbEHpVFkoge40vHs56cIymFGZLe53JZkhu3pwYuS4jpXytV30Ad-HwmQDUu_Xqcifni6tDYPCfKz2CZlcOfwqHeGIHJjDGVBKqhEeo8PhStoofBU6Y4OjObP7HGuTY-Foo4QindNnpp0QU6vSb7kiOiQ4twpayybH8PTf73dtdFt46UF6mGjskWgevgolvmO8A&#34;</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>62</span><span class=p>.</span><span class=n>234</span><span class=p>.</span><span class=n>214</span><span class=p>.</span><span class=n>206</span><span class=err>:</span><span class=n>6443</span><span class=p>/</span><span class=n>api</span><span class=p>/</span><span class=n>v1</span><span class=p>/</span><span class=n>namespaces</span><span class=p>/</span><span class=n>demo</span><span class=p>/</span><span class=n>pods</span><span class=k>?</span><span class=n>limit</span><span class=p>=</span><span class=n>500</span>
</span></span></code></pre></div><ol start=2><li>postman</li></ol><h4 id=查看etcd数据>查看etcd数据<a hidden class=anchor aria-hidden=true href=#查看etcd数据>#</a></h4><p>拷贝etcdctl命令行工具：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=n>exec</span> <span class=n>-ti</span>  <span class=n>etcd_container</span> <span class=n>which</span> <span class=n>etcdctl</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>docker</span> <span class=nb>cp </span><span class=n>etcd_container</span><span class=err>:</span><span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>local</span><span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>etcdctl</span> <span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>etcdctl</span>
</span></span></code></pre></div><p>查看所有key值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span>  <span class=n>ETCDCTL_API</span><span class=p>=</span><span class=n>3</span> <span class=n>etcdctl</span> <span class=p>-</span><span class=n>-endpoints</span><span class=p>=</span><span class=n>https</span><span class=err>:</span><span class=p>//[</span><span class=n>127</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=p>]</span><span class=err>:</span><span class=n>2379</span> <span class=p>-</span><span class=n>-cacert</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>etcd</span><span class=p>/</span><span class=n>ca</span><span class=p>.</span><span class=n>crt</span> <span class=p>-</span><span class=n>-cert</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>etcd</span><span class=p>/</span><span class=nb>healthcheck-client</span><span class=p>.</span><span class=n>crt</span> <span class=p>-</span><span class=n>-key</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>etcd</span><span class=p>/</span><span class=nb>healthcheck-client</span><span class=p>.</span><span class=n>key</span> <span class=n>get</span> <span class=p>/</span> <span class=p>-</span><span class=n>-prefix</span> <span class=p>-</span><span class=n>-keys-only</span>
</span></span></code></pre></div><p>查看具体的key对应的数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>ETCDCTL_API</span><span class=p>=</span><span class=n>3</span> <span class=n>etcdctl</span> <span class=p>-</span><span class=n>-endpoints</span><span class=p>=</span><span class=n>https</span><span class=err>:</span><span class=p>//[</span><span class=n>127</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=p>]</span><span class=err>:</span><span class=n>2379</span> <span class=p>-</span><span class=n>-cacert</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>etcd</span><span class=p>/</span><span class=n>ca</span><span class=p>.</span><span class=n>crt</span> <span class=p>-</span><span class=n>-cert</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>etcd</span><span class=p>/</span><span class=nb>healthcheck-client</span><span class=p>.</span><span class=n>crt</span> <span class=p>-</span><span class=n>-key</span><span class=p>=/</span><span class=n>etc</span><span class=p>/</span><span class=n>kubernetes</span><span class=p>/</span><span class=n>pki</span><span class=p>/</span><span class=n>etcd</span><span class=p>/</span><span class=nb>healthcheck-client</span><span class=p>.</span><span class=n>key</span> <span class=n>get</span> <span class=p>/</span><span class=n>registry</span><span class=p>/</span><span class=n>pods</span><span class=p>/</span><span class=n>jenkins</span><span class=p>/</span><span class=nb>sonar-postgres</span><span class=p>-</span><span class=n>7fc5d748b6-gtmsb</span>
</span></span></code></pre></div><h4 id=基于efk实现kubernetes集群的日志平台扩展---录屏>基于EFK实现kubernetes集群的日志平台（扩展） 录屏！！！<a hidden class=anchor aria-hidden=true href=#基于efk实现kubernetes集群的日志平台扩展---录屏>#</a></h4><h5 id=efk介绍>EFK介绍<a hidden class=anchor aria-hidden=true href=#efk介绍>#</a></h5><p>EFK工作示意</p><p><img loading=lazy src=images%5cEFK-architecture.png alt></p><ul><li><p>Elasticsearch</p><p>一个开源的分布式、Restful 风格的搜索和数据分析引擎，它的底层是开源库Apache Lucene。它可以被下面这样准确地形容：</p><ul><li>一个分布式的实时文档存储，每个字段可以被索引与搜索；</li><li>一个分布式实时分析搜索引擎；</li><li>能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据。</li></ul></li><li><p>Fluentd</p><p>一个针对日志的收集、处理、转发系统。通过丰富的插件系统，可以收集来自于各种系统或应用的日志，转化为用户指定的格式后，转发到用户所指定的日志存储系统之中。</p><p><img loading=lazy src=images%5cfluentd-architecture.jpg alt></p><p>Fluentd 通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如 Elasticsearch、对象存储、kafka等等。Fluentd 支持超过300个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下</p><ol><li>首先 Fluentd 从多个日志源获取数据</li><li>结构化并且标记这些数据</li><li>然后根据匹配的标签将数据发送到多个目标服务</li></ol></li><li><p>Kibana</p><p>Kibana是一个开源的分析和可视化平台，设计用于和Elasticsearch一起工作。可以通过Kibana来搜索，查看，并和存储在Elasticsearch索引中的数据进行交互。也可以轻松地执行高级数据分析，并且以各种图标、表格和地图的形式可视化数据。</p></li></ul><h5 id=部署es服务>部署es服务<a hidden class=anchor aria-hidden=true href=#部署es服务>#</a></h5><h6 id=部署分析>部署分析<a hidden class=anchor aria-hidden=true href=#部署分析>#</a></h6><ol><li>es生产环境是部署es集群，通常会使用statefulset进行部署，此例由于演示环境资源问题，部署为单点</li><li>数据存储挂载主机路径</li><li>es默认使用elasticsearch用户启动进程，es的数据目录是通过宿主机的路径挂载，因此目录权限被主机的目录权限覆盖，因此可以利用init container容器在es进程启动之前把目录的权限修改掉，注意init container要用特权模式启动。</li></ol><h6 id=部署并验证>部署并验证<a hidden class=anchor aria-hidden=true href=#部署并验证>#</a></h6><p><code>efk/elasticsearch.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>apiVersion</span><span class=err>:</span> <span class=n>apps</span><span class=p>/</span><span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>kind</span><span class=err>:</span> <span class=n>StatefulSet</span>
</span></span><span class=line><span class=cl><span class=n>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>labels</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>addonmanager</span><span class=p>.</span><span class=n>kubernetes</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=n>mode</span><span class=err>:</span> <span class=n>Reconcile</span>
</span></span><span class=line><span class=cl>    <span class=nb>k8s-app</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=err>:</span> <span class=n>v7</span><span class=p>.</span><span class=n>4</span><span class=p>.</span><span class=n>2</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>  <span class=n>namespace</span><span class=err>:</span> <span class=n>logging</span>
</span></span><span class=line><span class=cl><span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>replicas</span><span class=err>:</span> <span class=n>1</span>
</span></span><span class=line><span class=cl>  <span class=n>revisionHistoryLimit</span><span class=err>:</span> <span class=n>10</span>
</span></span><span class=line><span class=cl>  <span class=n>selector</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>matchLabels</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=nb>k8s-app</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>      <span class=n>version</span><span class=err>:</span> <span class=n>v7</span><span class=p>.</span><span class=n>4</span><span class=p>.</span><span class=n>2</span>
</span></span><span class=line><span class=cl>  <span class=n>serviceName</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>  <span class=n>template</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=n>labels</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>k8s-app</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span><span class=err>:</span> <span class=n>v7</span><span class=p>.</span><span class=n>4</span><span class=p>.</span><span class=n>2</span>
</span></span><span class=line><span class=cl>    <span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=err>:</span> <span class=s2>&#34;true&#34;</span>	<span class=c>## 指定部署在哪个节点。需根据环境来修改</span>
</span></span><span class=line><span class=cl>      <span class=n>containers</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>env</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=n>NAMESPACE</span>
</span></span><span class=line><span class=cl>          <span class=n>valueFrom</span><span class=err>:</span>
</span></span><span class=line><span class=cl>            <span class=n>fieldRef</span><span class=err>:</span>
</span></span><span class=line><span class=cl>              <span class=n>apiVersion</span><span class=err>:</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl>              <span class=n>fieldPath</span><span class=err>:</span> <span class=n>metadata</span><span class=p>.</span><span class=n>namespace</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=n>cluster</span><span class=p>.</span><span class=n>initial_master_nodes</span>
</span></span><span class=line><span class=cl>          <span class=n>value</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span><span class=p>-</span><span class=n>0</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=n>ES_JAVA_OPTS</span>
</span></span><span class=line><span class=cl>          <span class=n>value</span><span class=err>:</span> <span class=s2>&#34;-Xms512m -Xmx512m&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=err>:</span> <span class=n>172</span><span class=p>.</span><span class=n>21</span><span class=p>.</span><span class=n>32</span><span class=p>.</span><span class=n>6</span><span class=err>:</span><span class=n>5000</span><span class=p>/</span><span class=n>elasticsearch</span><span class=p>/</span><span class=n>elasticsearch</span><span class=err>:</span><span class=n>7</span><span class=p>.</span><span class=n>4</span><span class=p>.</span><span class=n>2</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>        <span class=n>ports</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>containerPort</span><span class=err>:</span> <span class=n>9200</span>
</span></span><span class=line><span class=cl>          <span class=n>name</span><span class=err>:</span> <span class=n>db</span>
</span></span><span class=line><span class=cl>          <span class=n>protocol</span><span class=err>:</span> <span class=n>TCP</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>containerPort</span><span class=err>:</span> <span class=n>9300</span>
</span></span><span class=line><span class=cl>          <span class=n>name</span><span class=err>:</span> <span class=n>transport</span>
</span></span><span class=line><span class=cl>          <span class=n>protocol</span><span class=err>:</span> <span class=n>TCP</span>
</span></span><span class=line><span class=cl>        <span class=n>volumeMounts</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>mountPath</span><span class=err>:</span> <span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>share</span><span class=p>/</span><span class=n>elasticsearch</span><span class=p>/</span><span class=n>data</span>
</span></span><span class=line><span class=cl>          <span class=n>name</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>      <span class=n>dnsConfig</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=nb>single-request</span><span class=n>-reopen</span>
</span></span><span class=line><span class=cl>      <span class=n>initContainers</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>command</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=p>/</span><span class=n>sbin</span><span class=p>/</span><span class=n>sysctl</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>-w</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>vm</span><span class=p>.</span><span class=n>max_map_count</span><span class=p>=</span><span class=n>262144</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=err>:</span> <span class=n>alpine</span><span class=err>:</span><span class=n>3</span><span class=p>.</span><span class=n>6</span>
</span></span><span class=line><span class=cl>        <span class=n>imagePullPolicy</span><span class=err>:</span> <span class=n>IfNotPresent</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span><span class=n>-init</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=err>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>securityContext</span><span class=err>:</span>
</span></span><span class=line><span class=cl>          <span class=n>privileged</span><span class=err>:</span> <span class=n>true</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=nb>fix-permissions</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=err>:</span> <span class=n>alpine</span><span class=err>:</span><span class=n>3</span><span class=p>.</span><span class=n>6</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span><span class=err>:</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;chown -R 1000:1000 /usr/share/elasticsearch/data&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>securityContext</span><span class=err>:</span>
</span></span><span class=line><span class=cl>          <span class=n>privileged</span><span class=err>:</span> <span class=n>true</span>
</span></span><span class=line><span class=cl>        <span class=n>volumeMounts</span><span class=err>:</span>
</span></span><span class=line><span class=cl>        <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>          <span class=n>mountPath</span><span class=err>:</span> <span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>share</span><span class=p>/</span><span class=n>elasticsearch</span><span class=p>/</span><span class=n>data</span>
</span></span><span class=line><span class=cl>      <span class=n>volumes</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=p>-</span> <span class=n>name</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>        <span class=n>hostPath</span><span class=err>:</span>
</span></span><span class=line><span class=cl>          <span class=n>path</span><span class=err>:</span> <span class=p>/</span><span class=n>esdata</span>
</span></span><span class=line><span class=cl><span class=p>---</span>
</span></span><span class=line><span class=cl><span class=n>apiVersion</span><span class=err>:</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>kind</span><span class=err>:</span> <span class=n>Service</span>
</span></span><span class=line><span class=cl><span class=n>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>labels</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>k8s-app</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=err>:</span> <span class=n>elasticsearch</span>
</span></span><span class=line><span class=cl>  <span class=n>namespace</span><span class=err>:</span> <span class=n>logging</span>
</span></span><span class=line><span class=cl><span class=n>spec</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=n>ports</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span> <span class=n>port</span><span class=err>:</span> <span class=n>9200</span>
</span></span><span class=line><span class=cl>    <span class=n>protocol</span><span class=err>:</span> <span class=n>TCP</span>
</span></span><span class=line><span class=cl>    <span class=n>targetPort</span><span class=err>:</span> <span class=n>db</span>
</span></span><span class=line><span class=cl>  <span class=n>selector</span><span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>k8s-app</span><span class=err>:</span> <span class=nb>elasticsearch-logging</span>
</span></span><span class=line><span class=cl>  <span class=n>type</span><span class=err>:</span> <span class=n>ClusterIP</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=n>namespace</span> <span class=n>logging</span>
</span></span><span class=line><span class=cl><span class=c>## 给slave1节点打上label，将es服务调度到slave1节点</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>label</span> <span class=n>node</span> <span class=nb>k8s-slave1</span> <span class=n>log</span><span class=p>=</span><span class=n>true</span>
</span></span><span class=line><span class=cl><span class=c>## 部署服务，可以先去部署es的节点把镜像下载到本地</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>elasticsearch</span><span class=p>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=n>statefulset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=nb>elasticsearch-logging</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=n>service</span><span class=p>/</span><span class=n>elasticsearch</span> <span class=n>created</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 等待片刻，查看一下es的pod部署到了k8s-slave1节点，状态变为running</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>logging</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-o</span> <span class=n>wide</span>  
</span></span><span class=line><span class=cl><span class=n>NAME</span>                      <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>             <span class=n>NODE</span>       
</span></span><span class=line><span class=cl><span class=nb>elasticsearch-logging</span><span class=p>-</span><span class=n>0</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>69m</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>104</span>   <span class=nb>k8s-slave1</span>   
</span></span><span class=line><span class=cl><span class=c># 然后通过curl命令访问一下服务，验证es是否部署成功</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>logging</span> <span class=n>get</span> <span class=n>svc</span>  
</span></span><span class=line><span class=cl><span class=n>NAME</span>            <span class=nb>TYPE </span>       <span class=nb>CLUSTER-IP</span>      <span class=nb>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>    <span class=n>AGE</span>  
</span></span><span class=line><span class=cl><span class=n>elasticsearch</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>58</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>9200</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>71m</span>  
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=nb>curl </span><span class=n>10</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>174</span><span class=p>.</span><span class=n>58</span><span class=err>:</span><span class=n>9200</span>  
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span> <span class=err>:</span> <span class=s2>&#34;elasticsearch-logging-0&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>  <span class=s2>&#34;cluster_name&#34;</span> <span class=err>:</span> <span class=s2>&#34;docker-cluster&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>  <span class=s2>&#34;cluster_uuid&#34;</span> <span class=err>:</span> <span class=s2>&#34;uic8xOyNSlGwvoY9DIBT1g&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>  <span class=s2>&#34;version&#34;</span> <span class=err>:</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;number&#34;</span> <span class=err>:</span> <span class=s2>&#34;7.4.2&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;build_flavor&#34;</span> <span class=err>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;build_type&#34;</span> <span class=err>:</span> <span class=s2>&#34;docker&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;build_hash&#34;</span> <span class=err>:</span> <span class=s2>&#34;2f90bbf7b93631e52bafb59b3b049cb44ec25e96&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;build_date&#34;</span> <span class=err>:</span> <span class=s2>&#34;2019-10-28T20:40:44.881551Z&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;build_snapshot&#34;</span> <span class=err>:</span> <span class=n>false</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;lucene_version&#34;</span> <span class=err>:</span> <span class=s2>&#34;8.2.0&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;minimum_wire_compatibility_version&#34;</span> <span class=err>:</span> <span class=s2>&#34;6.8.0&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>	<span class=s2>&#34;minimum_index_compatibility_version&#34;</span> <span class=err>:</span> <span class=s2>&#34;6.0.0-beta1&#34;</span>  
</span></span><span class=line><span class=cl>  <span class=p>},</span>  
</span></span><span class=line><span class=cl>  <span class=s2>&#34;tagline&#34;</span> <span class=err>:</span> <span class=s2>&#34;You Know, for Search&#34;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span></code></pre></div><h5 id=部署kibana>部署kibana<a hidden class=anchor aria-hidden=true href=#部署kibana>#</a></h5><h6 id=部署分析-1>部署分析<a hidden class=anchor aria-hidden=true href=#部署分析-1>#</a></h6><ol start=2><li>kibana需要暴漏web页面给前端使用，因此使用ingress配置域名来实现对kibana的访问</li><li>kibana为无状态应用，直接使用Deployment来启动</li><li>kibana需要访问es，直接利用k8s服务发现访问此地址即可，http://elasticsearch:9200</li></ol><h6 id=部署并验证-1>部署并验证<a hidden class=anchor aria-hidden=true href=#部署并验证-1>#</a></h6><p>资源文件 <code>efk/kibana.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/kibana/kibana:7.4.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTICSEARCH_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>http://elasticsearch:9200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>5601</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5601</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>5601</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>kibana.devops.cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>5601</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>kibana</span><span class=p>.</span><span class=n>yaml</span>  
</span></span><span class=line><span class=cl><span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>kibana</span> <span class=n>created</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=p>/</span><span class=n>kibana</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=n>ingress</span><span class=p>/</span><span class=n>kibana</span> <span class=n>created</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 然后查看pod，等待状态变成running</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>logging</span> <span class=n>get</span> <span class=n>po</span>  
</span></span><span class=line><span class=cl><span class=n>NAME</span>                      <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>  
</span></span><span class=line><span class=cl><span class=nb>elasticsearch-logging</span><span class=p>-</span><span class=n>0</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>88m</span>  
</span></span><span class=line><span class=cl><span class=n>kibana</span><span class=p>-</span><span class=n>944c57766-ftlcw</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>15m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 配置域名解析 kibana.devops.cn，并访问服务进行验证，若可以访问，说明连接es成功</span>
</span></span></code></pre></div><h5 id=部署fluentd>部署fluentd<a hidden class=anchor aria-hidden=true href=#部署fluentd>#</a></h5><h6 id=部署分析-2>部署分析<a hidden class=anchor aria-hidden=true href=#部署分析-2>#</a></h6><ol><li>fluentd为日志采集服务，kubernetes集群的每个业务节点都有日志产生，因此需要使用daemonset的模式进行部署</li><li>为进一步控制资源，会为daemonset指定一个选择表情，fluentd=true来做进一步过滤，只有带有此标签的节点才会部署fluentd</li><li>日志采集，需要采集哪些目录下的日志，采集后发送到es端，因此需要配置的内容比较多，我们选择使用configmap的方式把配置文件整个挂载出来</li></ol><h6 id=部署服务>部署服务<a hidden class=anchor aria-hidden=true href=#部署服务>#</a></h6><p>配置文件，<code>efk/fluentd-es-main.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fluent.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # This is the root config file, which only includes components of the actual configuration
</span></span></span><span class=line><span class=cl><span class=sd>    #
</span></span></span><span class=line><span class=cl><span class=sd>    #  Do not collect fluentd&#39;s own logs to avoid infinite loops.
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;match fluent.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    @type null
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/match&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    @include /fluentd/etc/config.d/*.conf</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es-config-main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span></code></pre></div><p>配置文件，fluentd-config.yaml，注意点：</p><ol><li>数据源source的配置，k8s会默认把容器的标准和错误输出日志重定向到宿主机中</li><li>默认集成了 <a href=https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter>kubernetes_metadata_filter</a> 插件，来解析日志格式，得到k8s相关的元数据，raw.kubernetes</li><li>match输出到es端的flush配置</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>system.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;system&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      root_dir /tmp/fluentd-buffers/
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/system&gt;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers.input.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;source&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id fluentd-containers.log
</span></span></span><span class=line><span class=cl><span class=sd>      @type tail
</span></span></span><span class=line><span class=cl><span class=sd>      path /var/log/containers/*.log
</span></span></span><span class=line><span class=cl><span class=sd>      pos_file /var/log/es-containers.log.pos
</span></span></span><span class=line><span class=cl><span class=sd>      time_format %Y-%m-%dT%H:%M:%S.%NZ
</span></span></span><span class=line><span class=cl><span class=sd>      localtime
</span></span></span><span class=line><span class=cl><span class=sd>      tag raw.kubernetes.*
</span></span></span><span class=line><span class=cl><span class=sd>      format json
</span></span></span><span class=line><span class=cl><span class=sd>      read_from_head true
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/source&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    # Detect exceptions in the log output and forward them as one log entry.
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;match raw.kubernetes.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id raw.kubernetes
</span></span></span><span class=line><span class=cl><span class=sd>      @type detect_exceptions
</span></span></span><span class=line><span class=cl><span class=sd>      remove_tag_prefix raw
</span></span></span><span class=line><span class=cl><span class=sd>      message log
</span></span></span><span class=line><span class=cl><span class=sd>      stream stream
</span></span></span><span class=line><span class=cl><span class=sd>      multiline_flush_interval 5
</span></span></span><span class=line><span class=cl><span class=sd>      max_bytes 500000
</span></span></span><span class=line><span class=cl><span class=sd>      max_lines 1000
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/match&gt;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forward.input.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # Takes the messages sent over TCP
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;source&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @type forward
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/source&gt;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # Enriches records with Kubernetes metadata
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;filter kubernetes.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @type kubernetes_metadata
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/filter&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;match **&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id elasticsearch
</span></span></span><span class=line><span class=cl><span class=sd>      @type elasticsearch
</span></span></span><span class=line><span class=cl><span class=sd>      @log_level info
</span></span></span><span class=line><span class=cl><span class=sd>      include_tag_key true
</span></span></span><span class=line><span class=cl><span class=sd>      host elasticsearch
</span></span></span><span class=line><span class=cl><span class=sd>      port 9200
</span></span></span><span class=line><span class=cl><span class=sd>      logstash_format true
</span></span></span><span class=line><span class=cl><span class=sd>      request_timeout    30s
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;buffer&gt;
</span></span></span><span class=line><span class=cl><span class=sd>        @type file
</span></span></span><span class=line><span class=cl><span class=sd>        path /var/log/fluentd-buffers/kubernetes.system.buffer
</span></span></span><span class=line><span class=cl><span class=sd>        flush_mode interval
</span></span></span><span class=line><span class=cl><span class=sd>        retry_type exponential_backoff
</span></span></span><span class=line><span class=cl><span class=sd>        flush_thread_count 2
</span></span></span><span class=line><span class=cl><span class=sd>        flush_interval 5s
</span></span></span><span class=line><span class=cl><span class=sd>        retry_forever
</span></span></span><span class=line><span class=cl><span class=sd>        retry_max_interval 30
</span></span></span><span class=line><span class=cl><span class=sd>        chunk_limit_size 2M
</span></span></span><span class=line><span class=cl><span class=sd>        queue_limit_length 8
</span></span></span><span class=line><span class=cl><span class=sd>        overflow_action block
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;/buffer&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/match&gt;</span><span class=w>    
</span></span></span></code></pre></div><p>daemonset定义文件，fluentd.yaml，注意点：</p><ol><li>需要配置rbac规则，因为需要访问k8s api去根据日志查询元数据</li><li>需要将/var/log/containers/目录挂载到容器中</li><li>需要将fluentd的configmap中的配置文件挂载到容器内</li><li>想要部署fluentd的节点，需要添加fluentd=true的标签</li></ol><p><code>efk/fluentd.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;namespaces&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;pods&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;get&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;watch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;list&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENTD_ARGS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>--<span class=kc>no</span>-<span class=l>supervisor -q</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>172.21.32.6</span><span class=p>:</span><span class=m>5000</span><span class=l>/fluentd-es-root:v1.6.2-1.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>500Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>200Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/home/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainershome</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/fluentd/etc/config.d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/fluentd/etc/fluent.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume-main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>fluent.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fluentd</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/home/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainershome</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>420</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>420</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>fluent.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>fluent.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-es-config-main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume-main</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>## 给slave1和slave2打上标签，进行部署fluentd日志采集服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>label</span> <span class=n>node</span> <span class=nb>k8s-slave1</span> <span class=n>fluentd</span><span class=p>=</span><span class=n>true</span>  
</span></span><span class=line><span class=cl><span class=n>node</span><span class=p>/</span><span class=nb>k8s-slave1</span> <span class=n>labeled</span>  
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>label</span> <span class=n>node</span> <span class=nb>k8s-slave2</span> <span class=n>fluentd</span><span class=p>=</span><span class=n>true</span>  
</span></span><span class=line><span class=cl><span class=n>node</span><span class=p>/</span><span class=nb>k8s-slave2</span> <span class=n>labeled</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 创建服务</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>fluentd-es</span><span class=n>-config-main</span><span class=p>.</span><span class=n>yaml</span>  
</span></span><span class=line><span class=cl><span class=n>configmap</span><span class=p>/</span><span class=nb>fluentd-es</span><span class=n>-config-main</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=nb>fluentd-configmap</span><span class=p>.</span><span class=n>yaml</span>  
</span></span><span class=line><span class=cl><span class=n>configmap</span><span class=p>/</span><span class=nb>fluentd-config</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>create</span> <span class=o>-f</span> <span class=n>fluentd</span><span class=p>.</span><span class=n>yaml</span>  
</span></span><span class=line><span class=cl><span class=n>serviceaccount</span><span class=p>/</span><span class=nb>fluentd-es</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=n>clusterrole</span><span class=p>.</span><span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nb>fluentd-es</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=n>clusterrolebinding</span><span class=p>.</span><span class=n>rbac</span><span class=p>.</span><span class=n>authorization</span><span class=p>.</span><span class=n>k8s</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nb>fluentd-es</span> <span class=n>created</span>  
</span></span><span class=line><span class=cl><span class=n>daemonset</span><span class=p>.</span><span class=n>extensions</span><span class=p>/</span><span class=nb>fluentd-es</span> <span class=n>created</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 然后查看一下pod是否已经在k8s-slave1和k8s-slave2节点启动成功</span>
</span></span><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>-n</span> <span class=n>logging</span> <span class=n>get</span> <span class=n>po</span> <span class=n>-o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                      <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>  
</span></span><span class=line><span class=cl><span class=nb>elasticsearch-logging</span><span class=p>-</span><span class=n>0</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>123m</span>  
</span></span><span class=line><span class=cl><span class=nb>fluentd-es</span><span class=p>-</span><span class=n>246pl</span>   		  <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>2m2s</span>  
</span></span><span class=line><span class=cl><span class=nb>fluentd-es</span><span class=p>-</span><span class=n>4e21w</span>   		  <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>2m10s</span> 
</span></span><span class=line><span class=cl><span class=n>kibana</span><span class=p>-</span><span class=n>944c57766-ftlcw</span>    <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>50m</span>
</span></span></code></pre></div><h5 id=efk功能验证>EFK功能验证<a hidden class=anchor aria-hidden=true href=#efk功能验证>#</a></h5><h6 id=验证思路>验证思路<a hidden class=anchor aria-hidden=true href=#验证思路>#</a></h6><p>k8s-slave1和slave2中启动服务，同时往标准输出中打印测试日志，到kibana中查看是否可以收集</p><h6 id=创建测试容器>创建测试容器<a hidden class=anchor aria-hidden=true href=#创建测试容器>#</a></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>counter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fluentd</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine:3.6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>/bin/sh, -c,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s1>&#39;i=0; while true; do echo &#34;$i: $(date)&#34;; i=$((i+1)); sleep 1; done&#39;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=n>kubectl</span> <span class=n>get</span> <span class=n>po</span>  
</span></span><span class=line><span class=cl><span class=n>NAME</span>                          <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>  
</span></span><span class=line><span class=cl><span class=n>counter</span>                       <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>6s</span>
</span></span></code></pre></div><h6 id=配置kibana>配置kibana<a hidden class=anchor aria-hidden=true href=#配置kibana>#</a></h6><p>登录kibana界面，按照截图的顺序操作：</p><p><img loading=lazy src=images%5ckibana-op1.png alt></p><p><img loading=lazy src=images%5ckibana-op2.png alt></p><p><img loading=lazy src=images%5ckibana-op3.png alt></p><p><img loading=lazy src=images%5ckibana-op4.png alt></p><p>也可以通过其他元数据来过滤日志数据，比如可以单击任何日志条目以查看其他元数据，如容器名称，Kubernetes 节点，命名空间等，比如kubernetes.pod_name : counter</p><p>到这里，我们就在 Kubernetes 集群上成功部署了 EFK ，要了解如何使用 Kibana 进行日志数据分析，可以参考 Kibana 用户指南文档：https://www.elastic.co/guide/en/kibana/current/index.html</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://wandong1.github.io/post/%E9%9A%8F%E7%AC%94/><span class=title>« Prev Page</span><br><span>随笔</span></a>
<a class=next href=https://wandong1.github.io/post/docker%E5%85%A5%E9%97%A8%E8%87%B3%E8%BF%9B%E9%98%B6/><span class=title>Next Page »</span><br><span>docker入门至进阶</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share  on twitter" href="https://twitter.com/intent/tweet/?text=&url=https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share  on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f&title=&summary=&source=https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share  on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f&title="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share  on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share  on whatsapp" href="https://api.whatsapp.com/send?text=%20-%20https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share  on telegram" href="https://telegram.me/share/url?text=&url=https%3a%2f%2fwandong1.github.io%2fpost%2f%25E5%259F%25BA%25E4%25BA%258Edocker%25E5%2592%258Ckubernetes%25E7%259A%2584%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7devops%25E5%25AE%259E%25E8%25B7%25B5%25E8%25AE%25AD%25E7%25BB%2583%25E8%2590%25A5%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://wandong1.github.io>万东的云计算运维博客</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>